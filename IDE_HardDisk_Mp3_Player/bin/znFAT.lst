C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE ZNFAT
OBJECT MODULE PLACED IN .\bin\znFAT.obj
COMPILER INVOKED BY: C:\Keil_c51\C51\BIN\C51.EXE znFAT\znFAT.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\bin\znFAT.lst) TA
                    -BS(2) OBJECT(.\bin\znFAT.obj)

line level    source

   1          #include "znfat.h"
   2          #include "template.h"
   3          #include "gb2uni.h"
   4          #include "deviceio.h"
   5          
   6          /*¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï
   7            ¡¶ÕñÄÏµÄznFAT--Ç¶ÈëÊ½FAT32ÎÄ¼şÏµÍ³Éè¼ÆÓëÊµÏÖ¡·
   8             Ò»Êé[ÉÏÏÂ²á]ÒÑ¾­ÓÉ±±º½³ö°æÉçÕıÊ½³ö°æ·¢ĞĞ¡£
   9             ´ËÊéÊÇÕñÄÏÀú¾­3Äê¶àÊ±¼äÇ±ĞÄ±àÖø£¬ÊÇÏÖ½ñÊĞÃæÉÏÎ¨
  10             Ò»Ò»Ì×½²ÊöFAT32ÎÄ¼şÏµÍ³¡¢SD¿¨µÈÇ¶ÈëÊ½´æ´¢¼¼ÊõµÄ
  11             ×¨Öø¡£ÊéÖĞ»¹½éÉÜÁË´óÁ¿µÄ±à³Ì¼¼ÇÉÓëÕñÄÏµÄ¿ª·¢¾­Ñé¡£
  12             ÇëÔÚ¸÷´óÍøÂçÏúÊÛÆ½Ì¨ËÑË÷¡°znFAT¡±£¬¼´¿É¹ºÂò¡£
  13             ÔÚÈ«¹ú¸÷´óÊéµêÒ²ÓĞÊÛ¡£
  14             ÕñÄÏµÄZN-X¿ª·¢°å£¬Ö§³Ö51¡¢AVR¡¢STM32(M0/M3/M4)µÈ
  15             CPU¡£´Ë°å¿ÉÓëÊéÅäÌ×£¬°åÉÏ¸÷ÖÖ¾«²ÊµÄÊµÑéÊµÀıÇëÏê¼û
  16             ÕñÄÏÍøÕ¾www.znmcu.cn
  17            ¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï¡ï*/
  18          
  19          /*==================================================================================
  20            ÕñÄÏµÄznFAT Ò»ÖÖ½ÏÎªÍê±¸µÄÇ¶ÈëÊ½Æ½Ì¨ÉÏµÄFAT32ÎÄ¼şÏµÍ³½â¾ö·½°¸ V11.21
  21                         ¾´Çë¹Ø×¢ ÕñÄÏµÄznFAT ÍøÕ¾ www.znfat.com
  22                       QQ 987582714
  23          ===================================================================================*/
  24          /*----------------------------------------------------------------------------/
  25          /  Here is znFAT -- a complete FAT32 FileSystem Solution  ver 11.21   
  26          /-----------------------------------------------------------------------------/
  27          / znFAT is a complete FAT FileSystem Code Module for embeded system platform.
  28          / znFAT is Developped and Coded By ZN China who own the full copyright on it.
  29          / You are allowed to use it for study,research,and commerce purpose,to modify
  30          / the code and publish it freely.
  31          / znFAT is pleasure to be recommended to more E-amateur and Engineer.Thanks!!
  32          /  
  33          /              Copyright (C) 2010, ZN, all right reserved.
  34          /
  35          /               Technology Support http://www.znfat.com
  36          /                  Welcome to ZN's FAT32 FS World!!
  37          /-----------------------------------------------------------------------------/
  38          
  39          /-----------------------------------------------------------------------------/
  40          Function Table(¹¦ÄÜº¯Êı±í): 
  41           znFAT_Device_Init  : Storage device initialize (´æ´¢Éè±¸³õÊ¼»¯)
  42           znFAT_Init         : File system initialize (ÎÄ¼şÏµÍ³³õÊ¼»¯)
  43           znFAT_Select_Device: Select storage device (Ñ¡Ôñ´æ´¢Éè±¸)
  44           znFAT_Open_File    : Open a file (´ò¿ªÎÄ¼ş)
  45           znFAT_ReadData     : Read data in a file (¶ÁÈ¡ÎÄ¼şÊı¾İ)
  46           znFAT_ReadDataX    : Read data and redirect it (¶ÁÈ¡ÎÄ¼şÊı¾İ+Êı¾İÖØ¶¨Ïò)
  47           znFAT_Enter_Dir    : Enter a dir (½øÈëÄ¿Â¼)
  48           znFAT_WriteData    : Write data to a file,append it to the end (ÏòÎÄ¼şĞ´ÈëÊı¾İ)
  49           znFAT_Modify_Data  : Modify data in a file (ĞŞ¸ÄÎÄ¼şÊı¾İ)
  50           znFAT_Dump_Data    : Dump data of a file (¶ªÆú£¬½Ø¶ÏÎÄ¼şÊı¾İ)
  51           znFAT_Create_File  : Create file (´´½¨ÎÄ¼ş)
  52           znFAT_Create_Dir   : Create dir (´´½¨Ä¿Â¼)
  53           znFAT_Delete_File  : Delete file (É¾³ıÎÄ¼ş)
  54           znFAT_Delete_Dir   : Delete dir (É¾³ıÄ¿Â¼)
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 2   

  55           znFAT_Make_FS      : Make a FAT32 FS on a storage device,even Format (¸ñÊ½»¯)
  56           znFAT_Close_File   : Close file (¹Ø±ÕÎÄ¼ş)
  57           znFAT_Flush_FS     : Flush FS,Update FS information from RAM to Disk (Ë¢ĞÂFS)
  58          /----------------------------------------------------------------------------/
  59          Configuration for znFAT's Functions,is necessary before the usage of them.
  60                  (¶ÔznFATÖĞ¹¦ÄÜº¯ÊıµÄÅäÖÃ£¬ÔÚÊ¹ÓÃËüÃÇÖ®Ç°ÇëÎñ±Ø¶ÔÆä½øĞĞÅäÖÃ)
  61          
  62          When you use a function in znFAT(but znFAT_Device_Init znFAT_Init and znFAT_\
  63          Select_Device,because them must be used in every project),you must firstly
  64          OPEN the MACROS as "#define ZNFAT_XXXX",So the relevant code of the function
  65          is added to the compiling.Or,You will get a warning like "XXXX is undefined .."
  66          For example:You now wanna use znFAT_Open_File,You must open the header file
  67          config.h,OPEN the MACRO ZNFAT_OPEN_FILE,even delete the "//" before it.
  68          
  69          (µ±ÄãÒªÊ¹ÓÃznFATÖĞÒ»¸öº¯ÊıÊ±(znFAT_Device_Init znFAT_Init and znFAT_Select_\
  70          DeviceÕâÈı¸öº¯Êı³ıÍâ£¬ÒòÎªËüÃÇÔÚÈÎºÎÊ±ºò¶¼ÊÇ±ØÈ»±»Ê¹ÓÃµÄ)£¬±ØĞëÊ×ÏÈ°ÑÏàÓ¦µÄºê
  71          ´ò¿ª£¬±ÈÈç"#define ZNFAT_XXXX"£¬ÕâÑùÓëÕâ¸öº¯ÊıÏà¹ØµÄ´úÂë²Å»á±»¼ÓÈëµ½±àÒëÖ®ÖĞ£¬
  72          ·ñÔò£¬Äã¿ÉÄÜ»áµÃµ½ÏñÕâÑùµÄ¾¯¸æ"XXXX is undefined.."¡£¾ÙÀıËµÃ÷£ºÒªÊ¹ÓÃznFAT_\
  73          Open_Fileº¯Êı£¬Äã±ØĞëÒª´ò¿ªconfig.h£¬´ò¿ªÀïÃæ¶ÔÓ¦µÄºêZNFAT_OPEN_FILE£¬¼´È¥µô
  74          Ç°ÃæµÄ"//"¡£)
  75          
  76          Option for znFAT (znFATÖĞµÄ¹¤×÷·½Ê½Ñ¡Ôñ)
  77          
  78           USE_LFN : Use the Long File Name (Ê¹ÓÃ³¤ÎÄ¼şÃû)
  79            MAX_LFN_LEN : Define the max Long File Name length (¶¨Òå³¤ÎÄ¼şÃû×î´ó³¤¶È)
  80            USE_OEM_CHAR: Use OEM charactor in LFN,as CHN (ÔÚ³¤ÎÄ¼şÃûÖĞÊ¹ÓÃOEM×Ö·û£¬ÈçÖĞÎÄ)
  81           USE_MULTISEC_R : Use hardware continuous Sector Read (Ê¹ÓÃÓ²¼ş¼¶Á¬ĞøÉÈÇø¶Á)
  82           USE_MULTISEC_W : Use hardware continuous Sector Write (Ê¹ÓÃÓ²¼ş¼¶Á¬ĞøÉÈÇøĞ´)
  83           USE_MULTISEC_CLEAR : Use hardware continuous Sector Clear (Ê¹ÓÃÓ²¼ş¼¶Á¬ĞøÉÈÇøÇå0)
  84           RT_UPDATE_FSINFO : Realtime update the information of FS (ÊµÊ±Ë¢ĞÂÎÄ¼şÏµÍ³ĞÅÏ¢)
  85           RT_UPDATE_FILESIZE : Realtime update the file size (ÊµÊ±¸üĞÂÎÄ¼ş´óĞ¡)
  86           RT_UPDATE_CLUSTER_CHAIN : Realtime update the cluster chain (ÊµÊ±¸üĞÂ´ØÁ´)
  87                                     if not define it ,znFAT will use CCCB algorithm
  88                         to store the cluster chain in CCCB buffer 
  89                         (Èç¹ûÃ»ÓĞ¶¨ÒåÕâ¸öºê£¬ÔòznFATÔÚÊı¾İ¶ÁĞ´¹ı³ÌÖĞ£¬Ê¹ÓÃ
  90                          CCCBËã·¨À´½«´ØÁ´ÁÙÊ±ĞÔµÄ´æ´¢ÔÚRAMµÄ»º³åÇøÖĞ£¬ÕâÑù
  91                        ÊÇÎªÁËÌá¸ßÊı¾İ¶ÁĞ´ËÙÂÊ£¬±×¶ËÔÚÓÚ»º³åÖĞµÄ´ØÁ´²»»Ø
  92                        Ğ´µ½ÎïÀíÉÈÇøÖĞ£¬»áÔì³ÉÊı¾İ¶ªÊ§£¬Òò´ËÒª¼°Ê±»ØĞ´¡£)
  93            CCCB_LEN (XXX) : Define the size of CCCB buffer (¶¨ÒåCCCB »º³åÇø´óĞ¡)
  94            USE_ALONE_CCCB : Use the alone CCCB buffer (Ê¹ÓÃ¶ÀÁ¢CCCB »º³åÇø£¬¼´Ã¿Ò»¸öÎÄ¼ş
  95                                                        ¶¼»á·ÖÅäÒ»¸ö¶ÀÁ¢µÄCCCB»º³åÇø£¬Êı¾İ
  96                                  ¶ÁĞ´Ê±£¬¸÷ÎÄ¼ş¸÷ÓÃ¸÷×ÔµÄCCCB»º³å£¬
  97                                  »¥²»¸ÉÉæ¡£)
  98                         if not define it,use the Shared CCCB buffer
  99                                               (Èç¹û´ËºêÃ»ÓĞ¶¨Òå£¬ÔòznFAT»áÊ¹ÓÃ¹²
 100                                  CCCB »º³åÇø£¬Ö÷ÒªÊÇÎªÁË½ÚÊ¡RAM×Ê
 101                                  Ô´£¬µ«ÕâÑù±ØÈ»ÕĞÖÂ¶à¸öÎÄ¼ş¶Ô¹²Ïí
 102                                  CCCB»º³åµÄÇÀ¶á£¬ÔÚÍ¬Ê±²Ù×÷ÎÄ¼ş
 103                                  ½Ï¶àµÄÊ±ºò£¬Êı¾İ¶ÁĞ´Ğ§ÂÊ²¢²»¸ß¡£)
 104           USE_EXCHANGE_BUFFER : Use the exchange buffer and relevant algorithm (EXB)
 105                                                       (Ê¹ÓÃEXBÉÈÇø½»»»»º³å¼°ÆäËã·¨£¬EXB
 106                                  »º³åÊÇÎªÁË¼õÉÙÉÈÇøÊı¾İµÄ¶Á-¸Ä-Ğ´
 107                                  ²Ù×÷´ÎÊı)
 108            USE_ALONE_EXB : Use alone exchange buffer (Ê¹ÓÃ¶ÀÁ¢µÄEXBÉÈÇø½»»»»º³å£¬¼´Ã¿¸ö
 109                                                       ÎÄ¼ş¾ùÓĞ¸÷×Ô¶ÀÁ¢µÄEXB»º³å£¬ÕâÑù×÷
 110                                 »á¼«´óµÄÔö´óRAM¿ªÏú)
 111                          if no define it,use the Shared exchange buffer
 112                                              (Èç¹û´ËºêÃ»ÓĞ¶¨Òå£¬ÔòÊ¹ÓÃ¹²ÏíEXB
 113                                 »º³å£¬¶à¸öÎÄ¼ş·ÖÊ±·ÖÏíÒ»¸öÉÈÇø½»»»
 114                                 »º³å£¬»áÔì³ÉÕùÇÀÎÊÌâ)
 115           Data_Redirect : Redirect function name macro defination for read_dataX
 116                                                      (ÎªznFAT_ReadDataXº¯ÊıËù¶¨ÒåµÄÊı¾İ
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 3   

 117                                 ÖØ¶¨Ïòµ¥Î»×Ö½Ú´¦Àíº¯Êı)
 118          
 119          /---------------------------------------------------------------------------*/
 120          
 121          
 122          //#pragma udata directive
 123          //#pragma udata BUFFER
 124          UINT8 tmpBuf[ZNFAT_BUF_SIZE];
 125          //#pragma udata
 126          
 127          UINT8 *znFAT_Buffer=tmpBuf; //znFATµÄÄÚ²¿»º³åÇø£¬Ê¹ÓÃÕß²»¿ÉË½×ÔÊ¹ÓÃ
 128                                      //ÏÈ¶¨ÒåtmpBuf£¬ÔÙÓÃznFAT_BufferÖ¸ÏòËü£¬ÊÇÒòÎªÔÚÒ»Ğ©¼Ü¹¹µÄCPUÖĞ
 129                                      //ÊÜÏŞÓÚRAMµÄÌØÊâ½á¹¹£¬Ö»ÄÜÓÃÖ¸ÕëÀ´·ÃÎÊ´óÊı×é£¬±ÈÈçPIC
 130          
 131          //--------------------------------------------------------------------------------------------------
 132          struct znFAT_Init_Args *pInit_Args; //³õÊ¼»¯²ÎÊı½á¹¹ÌåÖ¸Õë£¬ÓÃÒÔÖ¸ÏòÄ³Ò»´æ´¢Éè±¸µÄ³õÊ¼»¯²ÎÊı¼¯ºÏ
 133                                              //Ê¹ÓÃÖ®Ç°*±ØĞë*ÏÈÖ¸Ïò½á¹¹»¯±äÁ¿
 134          extern struct znFAT_IO_Ctl ioctl; 
 135          
 136          UINT8 Dev_No=0; //Éè±¸ºÅ£¬ÓÃÓÚÊµÏÖ¶àÉè±¸
 137          
 138          //--------------------------------------------------------------------------------------------------
 139          
 140          struct FileInfo *just_file=(struct FileInfo *)0; //ÓÃÓÚ¼ÇÂ¼×î½ü²Ù×÷µÄÎÄ¼ş
 141          
 142          //-------------------SCCCBÏà¹Ø±äÁ¿¶¨Òå----------------------
 143          #ifndef RT_UPDATE_CLUSTER_CHAIN //ÓÃÓÚ¶¨Òå¹²ÏíCCCBµÄ±äÁ¿¼°»º³åÊµÌå
              #ifndef USE_ALONE_CCCB
              UINT32 scccb_buf[CCCB_LEN]; //CCCBµÄ»º³åÇø£¬ÒÔÁ¬Ğø´Ø¶ÎµÄ·½Ê½À´¼ÇÂ¼´ØÁ´
              UINT8  scccb_counter=0; 
              UINT32 scccb_curval=0;
              
              UINT8  scccb_curdev=(UINT8)(-1);
              #endif
              #endif
 152          
 153          #ifndef RT_UPDATE_CLUSTER_CHAIN
              
              #ifndef USE_ALONE_CCCB //²»Ê¹ÓÃ¶ÀÁ¢´ØÁ´»º³å£¬¶øÊÇÊ¹ÓÃ¹²Ïí´ØÁ´»º³å£¬ÒÔÏÂ±äÁ¿ÓÃÓÚÍê³É¹²ÏíCCCBÊ¹ÓÃ¹ı³ÌÖĞµÄÕùÇ
             -À
              UINT32 *pcccb_buf=scccb_buf;
              UINT32 *pcccb_curval=&scccb_curval;
              UINT8  *pcccb_counter=&scccb_counter;
              
              UINT8  *pcccb_curdev=&scccb_curdev;
              struct FileInfo *pcccb_cur_oc=(struct FileInfo *)0;
              struct znFAT_Init_Args *pcccb_cur_initargs=(struct znFAT_Init_Args *)0;
              #else
              UINT32 *pcccb_buf=(UINT32 *)0;
              UINT32 *pcccb_curval=(UINT32 *)0;
              UINT8  *pcccb_counter=(UINT8 *)0;
              #endif
               
              UINT8 get_next_cluster_in_cccb=0; //ÓÃÒÔ±êÖ¾ÊÇ·ñÔÚCCCBÖĞ²éÕÒÏÂÒ»´Ø
              #endif
 171          //----------------------------------------------------------
 172          
 173          //------------------EXBÏà¹Ø±äÁ¿¶¨Òå-------------------------
 174          #ifdef USE_EXCHANGE_BUFFER
              #ifndef USE_ALONE_EXB
              //#pragma udata directive
              //#pragma udata SEXB_BUF
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 4   

              UINT8  sexb_buf[ZNFAT_BUF_SIZE];
              //#pragma udata
              
              UINT8  sexb_cur_dev=(UINT8)(-1);
              UINT32 sexb_cur_sec=0;
              struct FileInfo *psexb_cur_oc=(struct FileInfo *)0; //Ö¸Ê¾µ±Ç°EXB±»ÄÄ¸öÎÄ¼şÕ¼ÓÃ
              #endif
              #endif
 186          
 187          #ifdef USE_EXCHANGE_BUFFER
              
              #ifndef USE_ALONE_EXB
              UINT8 *pexb_buf=sexb_buf;
              #else
              UINT8 *pexb_buf=(UINT8 *)0;
              #endif
              
              #endif
 196          //----------------------------------------------------------
 197          //====================Ò»Ğ©³£ÓÃº¯Êı================================================================
 198          
 199          //znFATÖĞÊ¹ÓÃµ½µÄ¹«¹²º¯Êı£¬ÆäÖĞ°üº¬ÁË¶ÔROMÀàĞÍ ×Ö½Ú¡¢×Ö¡¢Ë«×ÖµÄ¶ÁÈ¡ÒÔ¼°ROMµ½RAMÖ®¼ä¿½±´²Ù×÷
 200          //Èç¹ûÒªÊ¹³¤ÎÄ¼şÃû»ò¸ñÊ½»¯¹¦ÄÜ£¬ÔòÕâĞ©ROMÏà¹ØµÄº¯ÊıÊÇ±ØĞëÕıÈ·ÓèÒÔÊµÏÖµÄ
 201          
 202          UINT8 Memory_Set(UINT8 *pmem,UINT32 len,UINT8 value)
 203          {
 204   1       UINT32 i=0;
 205   1       for(i=0;i<len;i++)
 206   1       { 
 207   2        pmem[i]=value;
 208   2       }
 209   1      
 210   1       return 0;
 211   1      }
 212          
 213          UINT8 Memory_Compare(UINT8 *psmem,UINT8 *pdmem,UINT32 len)
 214          {
 215   1       UINT32 i=0;
 216   1      
 217   1       for(i=0;i<len;i++)
 218   1       {
 219   2        if(psmem[i]!=pdmem[i])
 220   2        {
 221   3         return 0;
 222   3        }
 223   2       }
 224   1       return 1;
 225   1      }
 226          
 227          UINT8 * Memory_Copy(UINT8 *pdmem,UINT8 *psmem,UINT32 len)
 228          {
 229   1       UINT32 i=0;
 230   1      
 231   1       for(i=0;i<len;i++)
 232   1       {
 233   2        pdmem[i]=psmem[i];
 234   2       }
 235   1      
 236   1       return pdmem;
 237   1      }
 238          
 239          INT8 * StringCopy(INT8 *dest_str,INT8 *src_str)
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 5   

 240          {
 241   1       UINT8 i=0;
 242   1      
 243   1       while('\0'!=src_str[i])
 244   1       {
 245   2        dest_str[i]=src_str[i];
 246   2        i++;
 247   2       }
 248   1      
 249   1       dest_str[i]='\0';
 250   1      
 251   1       return dest_str;
 252   1      }
 253          
 254          UINT32 StringLen(INT8 *pstr)
 255          {
 256   1       UINT32 len=0;
 257   1       while('\0'!=pstr[len]) 
 258   1       {
 259   2        len++;
 260   2       }
 261   1       return len;
 262   1      }
 263          
 264          UINT32 WStringLen(UINT16 *str)
 265          {
 266   1       UINT32 i=0;
 267   1       while(0!=str[i])
 268   1       {
 269   2        i++;
 270   2       }
 271   1      
 272   1       return i;
 273   1      }
 274          
 275          //=============================FLASHROM ²Ù×÷Ïà¹Øº¯Êı=====================
 276          
 277          UINT8 PGM_BYTE_FUN(ROM_TYPE_UINT8 *ptr)
 278          {
 279   1       return *(ptr); 
 280   1      }
 281          
 282          UINT16 PGM_WORD_FUN(ROM_TYPE_UINT16 *ptr)
 283          {
 284   1       return *(ptr);
 285   1      }
 286          
 287          UINT32 PGM_DWORD_FUN(ROM_TYPE_UINT32 *ptr)
 288          {
 289   1       return *(ptr);
 290   1      }
 291          
 292          UINT8 * PGM2RAM(UINT8 *pdmem,ROM_TYPE_UINT8 *psmem,UINT32 len)
 293          {
 294   1       UINT32 i=0;
 295   1      
 296   1       for(i=0;i<len;i++)
 297   1       {
 298   2        pdmem[i]=PGM_BYTE_FUN((psmem+i));
 299   2       }
 300   1      
 301   1       return pdmem;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 6   

 302   1      }
 303          
 304          //================================================================================================
 305          
 306          /*****************************************************************************
 307           ¹¦ÄÜ£ºÑ¡¶¨Ò»¸ö´æ´¢Éè±¸
 308           ĞÎ²Î£ºdevno:Éè±¸ºÅ pinitargs:Ö¸Ïò´æ´¢Éè±¸Ëù¶ÔÓ¦µÄÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏµÄÖ¸Õë
 309           ·µ»Ø£º0
 310           Ïê½â£ºznFATÊÇÖ§³Ö¶àÉè±¸µÄ£¬Òò´ËÔÚ¶ÔÉè±¸½øĞĞÎÄ¼şÏµÍ³Ïà¹Ø²Ù×÷Ö®Ç°£¬±ØĞëÒªÏÈÑ¡¶¨
 311                 Ò»¸ö´æ´¢Éè±¸¡£´Ëº¯Êı¶ÔDev_NoÕâ¸öÈ«¾ÖµÄÓÃÓÚÇø·Ö´æ´¢Éè±¸Çı¶¯µÄ±äÁ¿½øĞĞÉè
 312                 ¶¨£¬Í¬Ê±½«pInit_ArgsÖ¸Ïò´æ´¢Éè±¸ÏàÓ¦µÄÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏ
 313          *****************************************************************************/
 314          UINT8 znFAT_Select_Device(UINT8 devno,struct znFAT_Init_Args *pinitargs) //Ñ¡ÔñÉè±¸
 315          {
 316   1       pInit_Args=pinitargs; //½«znFATµÄ³õÊ¼»¯²ÎÊı¼¯ºÏÖ¸ÕëÖ¸ÏòÉè±¸µÄ³õÊ¼»¯²ÎÊı¼¯ºÏ
 317   1      
 318   1       Dev_No=devno; //ÉèÖÃÉè±¸ºÅ
 319   1      
 320   1       return 0;
 321   1      }
 322          
 323          /***********************************************************************************
 324           ¹¦ÄÜ£ºÓÉÒ»¸öĞ¡¶ËÅÅÁĞµÄ×Ö½ÚĞòÁĞ£¬¼ÆËãµÃµ½ÆäÔÚÄ³Ò»×Ö·û³¤¶ÈÏÂËù±í´ïµÄÕûĞÍÖµ
 325           ĞÎ²Î£ºdat:Ö¸Ïò×Ö½ÚĞòÁĞµÄÖ¸Õë len:½«×Ö½ÚĞòÁĞµÄÇ°len¸ö×Ö½Ú¼ÆËãÕûĞÍÖµ
 326           ·µ»Ø£º¼ÆËãµÃµ½µÄÕûĞÍÖµ
 327           Ïê½â£ºÕâÒ»º¯ÊıÊÇÆÁ±Î²»Í¬CPUÔÚ´óĞ¡¶ËÉÏµÄ²îÒìµÄÖ÷ÒªÊÖ¶Î¡£±ÈÈç¶ÔÓÚÒ»¸öĞ¡¶ËµÄ4×Ö½ÚĞòÁĞ
 328                 unsigned char *p={0X12,0X34,0X56,0X78} Èç¹ûÎÒÃÇÏë°ÑËüºÏ³ÉÎªÒ»¸ö4×Ö½ÚÕûĞÍ£¬Èç
 329                 unsigned long£¬ÄÇÃ´¿ÉÒÔÕâÑùÀ´×÷ *((unsigned long *)p)£¬µ«¶ÔÓÚ²»Í¬µÄCPU£¬Òò±ä
 330                 Á¿ÔÚRAMÖĞµÄ×Ö½ÚÅÅÁĞË³Ğò²»Í¬£¬¼´´óĞ¡¶ËÎÊÌâ£¬ÔòÆäËù±í´ïµÄÕûĞÍÖµ¿ÉÄÜÎª0X12345678
 331                 »ò 0X78563412£¬Õâ½«»á³öÏÖ´íÎó¡£ÎªÁËÆÁ±ÎÕâÖÖ²îÒì£¬ÒıÈëÁË´Ëº¯Êı£¬Í¨¹ı¶Ô×Ö½ÚĞòÁĞ
 332                 ½øĞĞ¼ÆËã£¬×îºó½«¿ÉÒÔµÃµ½ÕıÈ·µÄÖµ£¬¶ÔÓÚÉÏÀıÖĞµÄ×Ö½ÚĞòÁĞ£¬Í¨¹ı´Ëº¯ÊıµÄ¼ÆËãBytes
 333                 2Value(p,4)ÖµÒ»¶¨Îª0X12345678¡£
 334          ***********************************************************************************/
 335          UINT32 Bytes2Value(UINT8 *dat,UINT8 len)
 336          {
 337   1       UINT32 temp=0;
 338   1      
 339   1       if(len>=1) temp|=((UINT32)(dat[0]))    ;
 340   1       if(len>=2) temp|=((UINT32)(dat[1]))<<8 ;
 341   1       if(len>=3) temp|=((UINT32)(dat[2]))<<16;
 342   1       if(len>=4) temp|=((UINT32)(dat[3]))<<24;
 343   1      
 344   1       return temp;
 345   1      }
 346          
 347          /***********************************************************************************
 348           ¹¦ÄÜ£º²éÕÒFSINFOÉÈÇøµÄÎïÀíµØÖ·
 349           ĞÎ²Î£ºfsinfosec:Ò»¸öÖ¸ÏòÓÃÓÚ¼ÇÂ¼FSINFOÉÈÇøÎïÀíµØÖ·µÄ±äÁ¿µÄÖ¸Õë
 350           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
 351           Ïê½â£ºÒ»°ãÀ´ËµFSINFOÉÈÇøÔÚDBRÉÈÇøµÄºóÒ»¸öÉÈÇø£¬µ«²»·¦ÓĞÌØÊâÇé¿ö£¬Òò´ËÕâÀï¶ÔDBR+1µ½
 352                 FAT1µÄÇ°Ò»¸öÉÈÇø½øĞĞ±éÀú£¬ÒÔFSINFOÉÈÇøµÄ±êÖ¾×Ö×÷ÎªÈÏ¶¨ÊÇFSINFOÉÈÇøµÄÌõ¼ş¡£
 353          ***********************************************************************************/
 354          UINT8 Find_FSINFO_Sec(UINT32 *fsinfosec) //Ñ°ÕÒFSINFOÉÈÇø£¬ÀïÃæÓĞÊ£Óà´ØÊıÓë¿ÉÓÃµÄ¿Õ´Ø
 355          {
 356   1       UINT32 iSec=0;
 357   1       struct FSInfo *pfsinfo;
 358   1      
 359   1       UINT8 head[4]={'R','R','a','A'};
 360   1       UINT8 sign[4]={'r','r','A','a'}; //FSINFOÉÈÇøµÄ±êÖ¾
 361   1      
 362   1       for(iSec=(pInit_Args->BPB_Sector_No+1);iSec<(pInit_Args->FirstFATSector);iSec++)
 363   1       {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 7   

 364   2        znFAT_Device_Read_Sector(iSec,znFAT_Buffer);
 365   2        pfsinfo=((struct FSInfo *)znFAT_Buffer);
 366   2        if(Memory_Compare(pfsinfo->Head,head,4) //ÅĞ¶ÏÉÈÇøÊÇ·ñÊÇFSINFOÉÈÇø
 367   2         && Memory_Compare(pfsinfo->Sign,sign,4))
 368   2        {
 369   3         *fsinfosec=iSec;
 370   3         return ERR_SUCC;
 371   3        }
 372   2       }
 373   1      
 374   1       return ERR_FAIL;
 375   1      }
 376          
 377          /***********************************************************************************
 378           ¹¦ÄÜ£º´ÓFAT±íµÄ×îÍ·ÉÏ¿ªÊ¼²éÕÒ¿ÉÓÃµÄ¿Õ´Ø£¬¼´ÕÒµ½µÚÒ»¸ö¿ÉÓÃ¿Õ´Ø
 379           ĞÎ²Î£ºnFreeCluster:Ö¸ÏòÓÃÓÚ¼ÇÂ¼ÓĞÓÃµÄ¿Õ´ØµÄ±äÁ¿µÄÖ¸Õë
 380           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
 381           Ïê½â£º´ÓFAT±íµÄ×î¿ªÊ¼Î»ÖÃ¿ªÊ¼Ë³´Î²éÕÒ£¬Ö±µ½µÚÒ»¸ö¿ÉÓÃµÄ¿Õ´Ø³öÏÖ£¬´Ë¿Õ´ØÖµ½«»á±»¼ÇÂ¼
 382                 ÔÚÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏÖĞµÄpInit_Args->Next_Free_Cluster£¬ÎªÎÄ¼ş²Ù×÷¹ı³ÌÖĞĞè
 383                 Ê¹ÓÃ¿Õ´ØÊ±Ìá¹©¿ÉÓÃ¿Õ´ØµÄ²Î¿¼Öµ¡£
 384          ***********************************************************************************/
 385          UINT8 Search_Free_Cluster_From_Start(UINT32 *nFreeCluster)
 386          {
 387   1       UINT32 iSec=0;
 388   1       UINT8  iItem=0;
 389   1      
 390   1       struct FAT_Sec *pFAT_Sec;
 391   1      
 392   1       for(iSec=0;iSec<pInit_Args->FATsectors;iSec++)
 393   1       {
 394   2        znFAT_Device_Read_Sector(pInit_Args->FirstFATSector+iSec,znFAT_Buffer); //¶ÁÈ¡FATÉÈÇø
 395   2        pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer;
 396   2      
 397   2        for(iItem=0;iItem<NITEMSINFATSEC;iItem++) //±éÀúËùÓĞ´ØÏî£¬Ñ°ÕÒ¿ÕÏĞ´Ø
 398   2        {
 399   3         if((0==(((pFAT_Sec->items[iItem]).Item)[0])) && (0==(((pFAT_Sec->items[iItem]).Item)[1])) &&
 400   3          (0==(((pFAT_Sec->items[iItem]).Item)[2])) && (0==(((pFAT_Sec->items[iItem]).Item)[3])))
 401   3         {
 402   4          *nFreeCluster=((iSec*NITEMSINFATSEC)+(UINT32)iItem);
 403   4        return ERR_SUCC;
 404   4         }
 405   3        }
 406   2       }
 407   1       
 408   1       return ERR_FAIL;
 409   1      }
 410          
 411          /***********************************************************************************
 412           ¹¦ÄÜ£º¸üĞÂFSINFOÉÈÇø²ÎÊı
 413           ĞÎ²Î£ºÎŞ
 414           ·µ»Ø£º0
 415           Ïê½â£º¸üĞÂFSINFOÉÈÇø£¬ÆäÊµÖ÷ÒªÊÇÎªÁËÎ¬»¤Ê£Óà¿Õ´ØÊıÓëÏÂÒ»¸ö¿ÉÓÃ¿Õ´Ø²Î¿¼ÖµÕâÁ½¸ö²ÎÊı¡£
 416          ***********************************************************************************/
 417          #ifdef UPDATE_FSINFO
 418          UINT8 Update_FSINFO(void) //¸üĞÂFSINFOÉÈÇø
 419          {
 420   1       struct FSInfo *pfsinfo;
 421   1       znFAT_Device_Read_Sector(pInit_Args->FSINFO_Sec,znFAT_Buffer);
 422   1       
 423   1       pfsinfo=((struct FSInfo *)znFAT_Buffer);
 424   1       
 425   1       //Ğ´ÈëÊ£Óà¿Õ´ØÊı
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 8   

 426   1       pfsinfo->Free_Cluster[0]=(UINT8)( pInit_Args->Free_nCluster&0X000000FF)    ;
 427   1       pfsinfo->Free_Cluster[1]=(UINT8)((pInit_Args->Free_nCluster&0X0000FF00)>>8);
 428   1       pfsinfo->Free_Cluster[2]=(UINT8)((pInit_Args->Free_nCluster&0X00FF0000)>>16);
 429   1       pfsinfo->Free_Cluster[3]=(UINT8)((pInit_Args->Free_nCluster&0XFF000000)>>24);
 430   1      
 431   1       //Ğ´ÈëÏÂÒ»¿ÕÏĞ´Ø²Î¿¼Öµ£¬²¢ÎŞ¶à´óÒâÒå
 432   1       pfsinfo->Next_Free_Cluster[0]=(UINT8)( pInit_Args->Next_Free_Cluster&0X000000FF)    ;
 433   1       pfsinfo->Next_Free_Cluster[1]=(UINT8)((pInit_Args->Next_Free_Cluster&0X0000FF00)>>8);
 434   1       pfsinfo->Next_Free_Cluster[2]=(UINT8)((pInit_Args->Next_Free_Cluster&0X00FF0000)>>16);
 435   1       pfsinfo->Next_Free_Cluster[3]=(UINT8)((pInit_Args->Next_Free_Cluster&0XFF000000)>>24);
 436   1      
 437   1       znFAT_Device_Write_Sector(pInit_Args->FSINFO_Sec,znFAT_Buffer);
 438   1      
 439   1       return 0;
 440   1      }
 441          #endif
 442          
 443          /***********************************************************************************
 444           ¹¦ÄÜ£ºznFATÖĞµÄÎÄ¼şÏµÍ³³õÊ¼»¯º¯Êı
 445           ĞÎ²Î£ºÎŞ
 446           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü£¬Èç¹ûËü·µ»Ø2£¬ÔòËµÃ÷·¢ÉúFAT32ÎÄ¼şÏµÍ³ÀàĞÍĞ£Ñé´íÎó£¬¼´´æ
 447                 ´æ´¢ÉÏµÄÎÄ¼şÏµÍ³·ÇFAT32¡£
 448           Ïê½â£ºÎÄ¼şÏµÍ³³õÊ¼»¯º¯Êı£¬½«Íê³ÉÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏµÄ×°Èë£¬ÎªÒÔºóµÄÎÄ¼ş²Ù×÷×÷ºÃ
 449                 ×¼±¸¡£
 450          ***********************************************************************************/
 451          UINT8 znFAT_Init(void)
 452          {
 453   1       struct DBR *pdbr;
 454   1      
 455   1       UINT8 dm[3]=DBR_MARK;
 456   1      
 457   1       znFAT_Device_Read_Sector(MBR_SECTOR,znFAT_Buffer); 
 458   1         
 459   1       if(!(znFAT_Buffer[0]==dm[0] && znFAT_Buffer[1]==dm[1] && znFAT_Buffer[2]==dm[2])) //¼ì²â0ÉÈÇøÊÇ·ñÎªDBRÉÈÇ
             -ø
 460   1       {
 461   2        pInit_Args->BPB_Sector_No=Bytes2Value(((((struct MBR *)(znFAT_Buffer))->Part[0]).StartLBA),4);
 462   2       }
 463   1       else
 464   1       {
 465   2        pInit_Args->BPB_Sector_No=0;
 466   2       }
 467   1       
 468   1       znFAT_Device_Read_Sector((pInit_Args->BPB_Sector_No),znFAT_Buffer); //¶ÁÈ¡DBRÉÈÇø
 469   1       pdbr=(struct DBR *)znFAT_Buffer;
 470   1      
 471   1       if(!IS_FAT32_TYPE((pdbr->BS_FilSysType1))) return FSTYPE_NOT_FAT32; //FAT32ÎÄ¼şÏµÍ³ÀàĞÍ¼ìÑé
 472   1      
 473   1       pInit_Args->BytesPerSector  =Bytes2Value((pdbr->BPB_BytesPerSec),2);//×°ÈëÃ¿ÉÈÇø×Ö½ÚÊıµ½BytesPerSectorÖĞ
 474   1      
 475   1       pInit_Args->FATsectors      =Bytes2Value((pdbr->BPB_FATSz32)    ,4);//×°ÈëFAT±íÕ¼ÓÃµÄÉÈÇøÊıµ½FATsectorsÖĞ
 476   1      
 477   1       pInit_Args->SectorsPerClust =pdbr->BPB_SecPerClus;//×°ÈëÃ¿´ØÉÈÇøÊıµ½SectorsPerClust ÖĞ
 478   1       pInit_Args->FirstFATSector  =Bytes2Value((pdbr->BPB_RsvdSecCnt) ,2)+pInit_Args->BPB_Sector_No;//×°ÈëµÚÒ»¸
             -öFAT±íÉÈÇøºÅµ½FirstFATSector ÖĞ
 479   1       pInit_Args->FirstDirSector  =(pInit_Args->FirstFATSector)+(pdbr->BPB_NumFATs)*(pInit_Args->FATsectors); /
             -/×°ÈëµÚÒ»¸öÄ¿Â¼ÉÈÇøµ½FirstDirSectorÖĞ
 480   1       pInit_Args->Total_SizeKB    =Bytes2Value((pdbr->BPB_TotSec32),4)/2;  //´ÅÅÌµÄ×ÜÈİÁ¿£¬µ¥Î»ÊÇKB
 481   1      
 482   1       if(Find_FSINFO_Sec(&(pInit_Args->FSINFO_Sec))) //²éÕÒFSINFOĞÅÏ¢ÉÈÇø
 483   1       {
 484   2        return ERR_FAIL;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 9   

 485   2       }
 486   1      
 487   1       znFAT_Device_Read_Sector((pInit_Args->FSINFO_Sec),znFAT_Buffer);
 488   1       pInit_Args->Free_nCluster=Bytes2Value(((struct FSInfo *)znFAT_Buffer)->Free_Cluster,4); //»ñÈ¡Ê£Óà´ØÊı
 489   1      
 490   1       if(0XFFFFFFFF==pInit_Args->Free_nCluster) //Èç¹ûÒ»¸ö´ÅÅÌ¸ñÊ½»¯ºóÃ»ÓĞ¾í±ê£¬ÔòÆä´æ´¢¿Õ¼ä¾ÍÃ»ÓĞÒ»µãÕ¼ÓÃ£¬´ËÊ
             -±FSINFO¼ÇÂ¼µÄÊ£Óà¿Õ´ØÊıÎª0XFFFFFFFF
 491   1       {
 492   2        pInit_Args->Free_nCluster=(((pInit_Args->Total_SizeKB*2)-(pInit_Args->FirstDirSector))/(pInit_Args->Sect
             -orsPerClust))-1;
 493   2       }
 494   1      
 495   1       if(Search_Free_Cluster_From_Start(&(pInit_Args->Next_Free_Cluster)))//±éÀúÕû¸öFAT±í£¬ËÑË÷¿ÉÓÃµÄ¿ÕÏĞ´Ø
 496   1       {                                                                   //´Ë²Ù×÷¿ÉÄÜ»áºÄ·Ñ½Ï¶àÊ±¼ä£¬µ«Ã»ÓĞ°ì·
             -¨
 497   2        return ERR_FAIL;                                                   //FSINFOÖĞµÄ¿ÕÏĞ´Ø²Î¿¼Öµ²¢²»±£Ö¤ÕıÈ·
 498   2       }                                                                   //ĞŞÕıºÍÎ¬»¤Ëü·´¶ø»á¸ü¼ÓÂé·³
 499   1       
 500   1       #ifdef RT_UPDATE_FSINFO //¼°Ê±½«FSINFOÉÈÇø½øĞĞ¸üĞÂ
 501   1       Update_FSINFO();
 502   1       #endif
 503   1      
 504   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifndef USE_ALONE_CCCB
               Memory_Set((UINT8 *)pcccb_buf,sizeof(UINT32)*CCCB_LEN,0);
               #endif
               #endif
 509   1      
 510   1       #ifdef USE_EXCHANGE_BUFFER
               #ifndef USE_ALONE_EXB
               Memory_Set(pexb_buf,512,0);
               #endif
               #endif
 515   1      
 516   1       return ERR_SUCC;
 517   1      }
 518          
 519          #ifndef RT_UPDATE_CLUSTER_CHAIN
              
              #ifdef USE_ALONE_CCCB
              UINT8 CCCB_To_Alone(void) //¶¨Ïòµ½µ±Ç°ÎÄ¼şµÄCCCB   
              {
               pcccb_buf=(just_file->acccb_buf);
               pcccb_curval=&(just_file->acccb_curval);
               pcccb_counter=&(just_file->acccb_counter);
              
               return 0;
              }
              #endif
              
              UINT32 CCCB_Get_Next_Cluster(UINT32 cluster)
              {
               UINT32 pos=CCCB_LEN-1;
               UINT32 i=0,temp=0;
              
               if(pcccb_buf==(UINT32 *)0) return 0;
               
               if(0==pcccb_buf[0]) return 0; //Èç¹ûCCCBÎ´±»Õ¼ÓÃ£¬ÔòÖ±½Ó·µ»Ø0
              
               #ifndef USE_ALONE_CCCB
               if(Dev_No!=(*pcccb_curdev)) return 0; //Èç¹ûµ±Ç°Õ¼ÓÃSCCCBµÄÉè±¸²»ÊÇÏÖÔÚÑ¡¶¨µÄÉè±¸£¬ÔòÖ±½Ó·µ»Ø0
               if(just_file!=pcccb_cur_oc) return 0; //Èç¹ûµ±Ç°Õ¼ÓÃSCCCBµÄÎÄ¼ş²»ÊÇÏÖÔÚÕıÔÚ²Ù×÷µÄÎÄ¼ş£¬ÔòÖ±½Ó·µ»Ø0
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 10  

               #endif
              
               while(0==pcccb_buf[pos]) pos--;
              
               if(cluster>=pcccb_buf[pos] && cluster<=(*pcccb_curval))
               {
                if(cluster==(*pcccb_curval)) return 0X0FFFFFFF;
                if(cluster==pcccb_buf[pos])
                {
                 if(pcccb_buf[pos]==(*pcccb_curval)) return 0X0FFFFFFF;
                }
                return (cluster+1);
               }
              
               temp=pos/2;
               for(i=0;i<temp;i++)
               {
                if(cluster>=pcccb_buf[2*i] && cluster<=pcccb_buf[2*i+1])
                {
                 if(cluster==pcccb_buf[2*i+1]) return pcccb_buf[2*i+2];
                 if(cluster==pcccb_buf[2*i])
                 {
                  if(pcccb_buf[2*i]==pcccb_buf[2*i+1]) return pcccb_buf[2*i+2];
                 }
                 return (cluster+1);
                }  
               }
              
               return 0;
              }
              
              UINT8 CCCB_Update_FAT(void)
              {
               UINT32 i=0,j=0,temp=0,temp1=0;
               UINT32 old_clu=0,cur_clu=0,clu_sec=0;
              
               #ifndef USE_ALONE_CCCB
               UINT8 old_devno=Dev_No;
               struct znFAT_Init_Args *old_pinit_args=pInit_Args;
               #endif
              
               struct FAT_Sec *pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer; //½«Êı¾İ»º³åÇøÊ×µØÖ·Ç¿×ªÎªFAT_Sec½á¹¹ÌåµÄÖ¸ÕëÀàĞ
             -Í
              
               if(pcccb_buf==(UINT32 *)0) return 0;
              
               if(0==pcccb_buf[0]) return 0; //CCCBÉĞÎ´±»Õ¼ÓÃ£¬ÎŞ´ØÁ´¿É¸üĞÂ
              
               #ifndef USE_ALONE_CCCB
               Dev_No=(*pcccb_curdev); pInit_Args=pcccb_cur_initargs;
               #endif
              
               old_clu=cur_clu=pcccb_buf[0];
               clu_sec=(old_clu/NITEMSINFATSEC); //¼ÆËãÇ°Ò»´ØµÄ´ØÏîËùÔÚµÄFATÉÈÇø
               znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
               
               pcccb_buf[(*pcccb_counter)]=(*pcccb_curval); //½«×îºóÒ»¸öÇø¼ä²¹Æë
              
               temp1=((*pcccb_counter)+1)/2;
               for(i=0;i<temp1;)
               {
                for(j=pcccb_buf[2*i]+1;j<=pcccb_buf[2*i+1];j++)
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 11  

                {
                 cur_clu++;
              
                 if(clu_sec!=(old_clu/NITEMSINFATSEC))
                 {
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                   
                clu_sec=(old_clu/NITEMSINFATSEC);
                  znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 }
              
                 temp=(UINT8)(old_clu%NITEMSINFATSEC);
                 (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cur_clu&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                 (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cur_clu&0X0000FF00)>>8) ;
                 (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cur_clu&0X00FF0000)>>16);
                 (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cur_clu&0XFF000000)>>24);
                
                 old_clu=cur_clu;
                }
              
                cur_clu=((i==(temp1-1))?(0X0FFFFFFF):(pcccb_buf[2*i+2])); //Ä¿±ê´ØÈ¡ÏÂÒ»´Ø¶ÎµÄ¿ªÊ¼´Ø;
              
                if(clu_sec!=(old_clu/NITEMSINFATSEC))
                {
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                   
                 clu_sec=(old_clu/NITEMSINFATSEC);
                 znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                }
              
                temp=(UINT8)(old_clu%NITEMSINFATSEC);
                (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cur_clu&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cur_clu&0X0000FF00)>>8) ;
                (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cur_clu&0X00FF0000)>>16);
                (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cur_clu&0XFF000000)>>24);
              
                old_clu=cur_clu;
                i++;
               }
               znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
               znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
              
               //============================================================================================
               Memory_Set((UINT8 *)pcccb_buf,sizeof(UINT32)*CCCB_LEN,0); //Çå¿ÕCCCB
               (*pcccb_counter)=0;
              
               #ifndef USE_ALONE_CCCB
               pcccb_cur_oc=(struct FileInfo *)0;
               *pcccb_curdev=(UINT8)(-1);
               pcccb_cur_initargs=(struct znFAT_Init_Args *)0;
              
               Dev_No=old_devno; pInit_Args=old_pinit_args; //»Ö¸´Éè±¸ºÅÓë ÓëÉè±¸Ïà¹ØµÄÎÄ¼şÏµÍ³²ÎÊı¼¯ºÏ
               #endif
              
               return 0;
              }
              #endif
 664          
 665          /***********************************************************************************
 666           ¹¦ÄÜ£º»ñÈ¡ÏÂÒ»´Ø
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 12  

 667           ĞÎ²Î£ºµ±Ç°´Ø
 668           ·µ»Ø£ºÏÂÒ»´ØµÄ´ØºÅ
 669           Ïê½â£º´Ëº¯ÊıÔÚznFAT±»Æµ·±µ÷ÓÃ
 670          ***********************************************************************************/
 671          #ifdef GET_NEXT_CLUSTER 
 672          UINT32 Get_Next_Cluster(UINT32 cluster)
 673          {
 674   1       UINT32 clu_sec=0;
 675   1       struct FAT_Sec *pFAT_Sec;
 676   1       struct FAT_Item *pFAT_Item;
 677   1      
 678   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               UINT32 next_clu=0;
               #endif
 681   1      
 682   1       #ifndef RT_UPDATE_CLUSTER_CHAIN //Èç¹ûÊ¹ÓÃÁËCCCB£¬Ôò»ñÈ¡ÏÂÒ»´ØÊ±£¬ÏÈµ½CCCBÖĞÑ°ÕÒ£¬È»ºóÔÙµ½FATÖĞÈ¥ÕÒ
               if(0!=get_next_cluster_in_cccb)
               {
                next_clu=CCCB_Get_Next_Cluster(cluster);
                if(0!=next_clu) return next_clu;
               }
               #endif
 689   1      
 690   1       clu_sec=(cluster/NITEMSINFATSEC)+(pInit_Args->FirstFATSector); //Ö¸¶¨´ØµÄ´ØÏîËùÔÚµÄÉÈÇøÎªÆäFATÇøÄÚµÄÆ«ÒÆÁ
             -¿¼ÓÉÏ
 691   1                                                                
 692   1       znFAT_Device_Read_Sector(clu_sec,znFAT_Buffer); //½«´ØÏîËùÔÚµÄÉÈÇøÊı¾İ¶ÁÈë»º³åÇø
 693   1      
 694   1       pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer; //½«Êı¾İ»º³åÇøÊ×µØÖ·Ç¿×ªÎªFAT_Sec½á¹¹ÌåµÄÖ¸ÕëÀàĞÍ
 695   1      
 696   1       pFAT_Item=&((pFAT_Sec->items)[cluster%NITEMSINFATSEC]); //»ñÈ¡Ö¸¶¨´ØµÄ´ØÏîÔÚËùÔÚÉÈÇøÖĞµÄµØÖ·
 697   1      
 698   1       return Bytes2Value((UINT8 *)pFAT_Item,NFATITEMBYTES); //·µ»Ø´ØÏîµÄÖµ£¬¼´Ö¸¶¨´ØÏÂÒ»´ØµÄ´ØºÅ
 699   1      }
 700          #endif
 701          
 702          /***********************************************************************************
 703           ¹¦ÄÜ£ºÎÄ¼şÊı¾İ¶¨Î»
 704           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë offset:Ä¿±êÆ«ÒÆÁ¿
 705           ·µ»Ø£º0
 706           Ïê½â£ºÈç¹ûoffset´óÓÚÎÄ¼ş´óĞ¡£¬Ôò¶¨Î»µ½ÎÄ¼şÄ©Î²¡£´Ëº¯ÊıÒÑ¾­±»Êı¾İ¶ÁĞ´º¯Êı¼¯³É£¬Ê¹ÓÃ
 707                 ÕßÒ»°ã²»ĞèÒªµ÷ÓÃ´Ëº¯Êı¡£
 708          ***********************************************************************************/
 709          #ifdef ZNFAT_SEEK
 710          UINT8 znFAT_Seek(struct FileInfo *pfi,UINT32 offset)
 711          {
 712   1       UINT32 Cluster_Size=((pInit_Args->SectorsPerClust)*(pInit_Args->BytesPerSector)); //¼ÆËã´ØµÄ×Ü×Ö½ÚÊı¾İ£¬Ò
             -ÔÃâºóÃæÖØ¸´¼ÆËã
 713   1       UINT32 temp=0,temp1=0,temp2=0,len=0,k=0,ncluster=0,have_read=0;
 714   1      
 715   1       just_file=pfi;
 716   1      
 717   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
 723   1      
 724   1       if(offset<(pfi->File_Size)) //Èç¹ûÒª¶¨Î»µ½µÄÆ«ÒÆÁ¿Ğ¡ÓÚÎÄ¼ş´óĞ¡£¬Ôò±Ø¶¨²»ÔÚÎÄ¼şÄ©Î²
 725   1       {
 726   2        pfi->File_IsEOF=BOOL_FALSE;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 13  

 727   2       }
 728   1      
 729   1       if(offset==(pfi->File_CurOffset)) return 0; //Èç¹ûÒª¶¨Î»µÄÎ»ÖÃÕıºÃÊÇµ±Ç°Æ«ÒÆÁ¿£¬ÔòÖ±½Ó·µ»Ø
 730   1      
 731   1       if(offset<(pfi->File_CurOffset)) //Èç¹ûÒª¶¨Î»µÄÎ»ÖÃÔÚµ±Ç°Æ«ÒÆÁ¿Ö®Ç°£¬ÔòÏÈ»Øµ½ÎÄ¼şÆğµã£¬ÒòÎª´ØÁ´ÊÇµ¥ÏòµÄ
 732   1       {
 733   2        pfi->File_CurClust=pfi->File_StartClust;
 734   2        pfi->File_CurSec=SOC(pfi->File_CurClust);
 735   2        pfi->File_CurPos=0;
 736   2        pfi->File_CurOffset=0; 
 737   2        pfi->File_IsEOF=BOOL_FALSE;
 738   2       }
 739   1       
 740   1       len=offset-(pfi->File_CurOffset); //¼ÆËãÄ¿±êÆ«ÒÆÁ¿µ½µ±Ç°Æ«ÒÆÁ¿Ö®¼äµÄÊı¾İ³¤¶È
 741   1       
 742   1       if(offset>=(pfi->File_Size)) //Èç¹û´Óµ±Ç°Î»ÖÃ¿ªÊ¼Òª¶ÁÈ¡µÄÊı¾İ³¤¶Èlen²»Ğ¡ÓÚÎÄ¼ş´óĞ¡
 743   1       {
 744   2        len=(pfi->File_Size-pfi->File_CurOffset);    //¶Ôlen½øĞĞĞŞÕı£¬ÖÃÎªÎÄ¼şÊ£Óà¿É¶ÁÊı¾İÁ¿¡£
 745   2        pfi->File_IsEOF=BOOL_TRUE;    //ÕâÖÖÇé¿öÏÂ£¬ÎÄ¼ş±ØÈ»»á¶Áµ½Ä©Î²¡£                    
 746   2       }
 747   1       
 748   1       //=================================================================== 
 749   1       if((pfi->File_CurOffset%Cluster_Size)!=0) //Èç¹ûµ±Ç°Æ«ÒÆÁ¿ÊÇ´Ø´óĞ¡ÕûÊı±¶£¬ËµÃ÷´ËÎ»ÖÃ¼´ÎªÕû´Ø¿ªÊ¼
 750   1       {                                         //²»ÒªÔÙ½øĞĞµ±Ç°´ØÄÚÊı¾İ´¦Àí£¬Ö±½Ó½øÈë´Ø-ÉÈÇø-×Ö½Ú½×¶Î
 751   2        if(len<=(pInit_Args->BytesPerSector-pfi->File_CurPos))
 752   2        {
 753   3         //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
 754   3         if((pInit_Args->BytesPerSector-pfi->File_CurPos)==len) //Èç¹ûÕıºÃ¶Áµ½µ±Ç°ÉÈÇøµÄÄ©Î²
 755   3         {
 756   4          if(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))//Èç¹ûµ±Ç°ÉÈÇøÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø        
             -             
 757   4          {
 758   5           if(!pfi->File_IsEOF) 
 759   5         {
 760   6          pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); 
 761   6         }
 762   5           pfi->File_CurSec=SOC(pfi->File_CurClust);
 763   5          }
 764   4          else
 765   4          {
 766   5           pfi->File_CurSec++;  
 767   5          }
 768   4          pfi->File_CurPos=0; 
 769   4         }
 770   3         else
 771   3         {
 772   4          pfi->File_CurPos+=((UINT16)len); 
 773   4         }  
 774   3         pfi->File_CurOffset+=len;
 775   3      
 776   3         return NUL_RET;
 777   3        }
 778   2        //===================================================================
 779   2        else
 780   2        {
 781   3         temp=(pInit_Args->BytesPerSector-pfi->File_CurPos); //½«µ±Ç°ÉÈÇøµÄÊ£ÓàÊı¾İÁ¿¸³¸øÖĞ¼ä±äÁ¿temp
 782   3         have_read+=temp;
 783   3        
 784   3         if(!(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
 785   3         {
 786   4          pfi->File_CurSec++;
 787   4          pfi->File_CurPos=0; 
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 14  

 788   4      
 789   4          temp2=(len-have_read); //¼ÆËãÊ£ÓàÊı¾İÁ¿
 790   4          temp1=((LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec-1))*(pInit_Args->BytesPerSector)); //Ê£Ó
             -àËùÓĞÉÈÇøÊı¾İÁ¿
 791   4          if(temp2<=temp1) //Èç¹ûÊ£ÓàÊı¾İÁ¿xxx
 792   4          {
 793   5         //ÕâËµÃ÷Òª¶ÁµÄÊı¾İÔÚµ±Ç°´ØÄÚ£¬Ã»ÓĞ¿çµ½ÏÂÒ»´Ø    
 794   5           temp=temp2/(pInit_Args->BytesPerSector); //¼ÆËãµ±Ç°´ØÄÚÕûÉÈÇø¶ÁÈ¡µÄ½áÊøÉÈÇø
 795   5           have_read+=((pInit_Args->BytesPerSector)*temp);
 796   5      
 797   5           if(temp2==temp1)
 798   5           {
 799   6            if(!pfi->File_IsEOF) 
 800   6          {
 801   7           pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); 
 802   7          }
 803   6            pfi->File_CurSec=SOC(pfi->File_CurClust); 
 804   6            pfi->File_CurPos=0;
 805   6           }
 806   5           else
 807   5           {
 808   6            pfi->File_CurSec+=temp; 
 809   6            //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
 810   6            pfi->File_CurPos=(UINT16)(len-have_read);
 811   6           }
 812   5           pfi->File_CurOffset+=len; 
 813   5          
 814   5           return NUL_RET;
 815   5          }
 816   4          else //Èç¹ûÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı²»Ğ¡ÓÚµ±Ç°´ØµÄÊ£ÓàÉÈÇøÊı£¬¼´Òª¶ÁµÄÊı¾İ²»¹âÔÚµ±Ç°´ØÄÚ£¬ÒÑ¾­¿ç´ØÁË
 817   4          {
 818   5           temp=LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec)+1; //¼ÆËãµ±Ç°´ØµÄÊ£ÓàÕûÉÈÇøÊı
 819   5           have_read+=((pInit_Args->BytesPerSector)*temp);
 820   5          }
 821   4         }
 822   3        
 823   3         //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±ÒÑ¾­¶ÁÍêµ±Ç°´ØµÄËùÓĞÊ£ÓàÊı¾İ£¬¿çµ½ÏÂÒ»´Ø
 824   3         pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust);
 825   3         pfi->File_CurSec=SOC(pfi->File_CurClust); 
 826   3         pfi->File_CurPos=0;    
 827   3        }
 828   2       }
 829   1       //----------------------------ÒÔÉÏÊÇ´¦Àíµ±Ç°´ØÄÚµÄÊı¾İ-------------------------------------
 830   1       if(len-have_read>0) 
 831   1       {
 832   2        ncluster=(len-have_read)/Cluster_Size; //¼ÆËãÊ£ÓàÊı¾İµÄÕû´ØÊı
 833   2      
 834   2        //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±ÒÑ¾­¶ÁÍêËùÓĞµÄÕû´ØÊı¾İ
 835   2      
 836   2        for(k=0;k<ncluster;k++) //¶ÁÈ¡Õû´ØÊı¾İ
 837   2        {
 838   3         have_read+=(Cluster_Size);
 839   3         if(!((len-have_read)==0 && pfi->File_IsEOF))  
 840   3         {
 841   4        pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust);
 842   4         }
 843   3        }
 844   2      
 845   2        pfi->File_CurSec=SOC(pfi->File_CurClust);
 846   2       
 847   2        //----------------------------ÒÔÉÏÊÇ´¦ÀíÕû´ØÊı¾İ------------------------------------------  
 848   2        if(len-have_read>0)
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 15  

 849   2        {
 850   3         temp=(len-have_read)/(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı
 851   3         have_read+=((pInit_Args->BytesPerSector)*temp);   
 852   3      
 853   3         pfi->File_CurSec+=temp;
 854   3         //----------------------------ÒÔÉÏÊÇ´¦ÀíÕûÉÈÇøÊı¾İ----------------------------------------
 855   3         if(len-have_read>0)
 856   3         {  
 857   4          //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±Êı¾İ¶ÁÈ¡²Ù×÷ÒÑ¾­½áÊø
 858   4          pfi->File_CurPos=(UINT16)(len-have_read);    
 859   4         }
 860   3         //----------------------------ÒÔÉÏÊÇ´¦Àí×îºóÉÈÇøÄÚµÄÊ£Óà×Ö½Ú----------------------------------------
 861   3        }
 862   2       }
 863   1      
 864   1       pfi->File_CurOffset+=len;
 865   1      
 866   1       return 0;
 867   1      }
 868          #endif
 869          
 870          /******************************************************************************************
 871           ¹¦ÄÜ£ºÎÄ¼şÊı¾İ¶ÁÈ¡
 872           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë offset:Êı¾İ¶ÁÈ¡µÄ¿ªÊ¼Æ«ÒÆÁ¿ len:Òª¶ÁÈ¡µÄ×Ö½ÚÊı
 873                 app_Buffer:Ó¦ÓÃÊı¾İ»º³åÇøÖ¸Õë
 874           ·µ»Ø£ºÊµ¼Ê¶ÁÈ¡µ½µÄÊı¾İ³¤¶È 
 875           Ïê½â£ºÈç¹û´ÓoffsetÎ»ÖÃ¶ÁÈ¡µÄÊı¾İ³¤¶ÈÒÑ¾­³¬Ô½ÁËÎÄ¼ş´óĞ¡£¬Ôò½ö¶ÁÈ¡offsetÎ»ÖÃµ½ÎÄ¼şÄ©Î²µÄÊı¾İ
 876                 Òò´Ë£¬Èç¹ûÎÄ¼şµÄÆ«ÒÆÎ»ÖÃÒÑ¾­ÔÚÎÄ¼şÄ©Î²£¬ÔÙ¶ÔÆä½øĞĞ¶ÁÈ¡£¬Ôò±ØÈ»¶Á²»µ½Êı¾İ£¬¶ø·µ»Ø0£¬
 877                 Õâ¿ÉÒÔ×÷ÎªÎÄ¼şÊı¾İÒÑÈ«²¿¶ÁÍêµÄ±êÖ¾£»µ±È»Ò²¿ÉÒÔ¿´File_IsEOFÕâ¸ö±êÖ¾£¬Èç¹ûÎª1ÔòËµÃ÷ÎÄ¼ş
 878                 ÒÑ¾­ÔÚÄ©Î²ÁË£»ÔÙ»òÕß¿ÉÒÔ±È½ÏÎÄ¼şµ±Ç°Æ«ÒÆÁ¿File_CurOffsetÓëÎÄ¼ş´óĞ¡µÄ²îÖµ£¬Èç¹ûÎª0£¬Ôò
 879                 ÎÄ¼şÒÑµ½Ä©Î²¡£¶Áµ½µÄÊı¾İ½«±»·ÅÔÚapp_BufferÖ¸ÏòµÄÓ¦ÓÃÊı¾İ»º³åÇøÖĞ£¬Òª×¢Òâ»º³åÇø´óĞ¡£¬
 880                 ·ÀÖ¹ÄÚ´æÒç³ö¡£
 881          ******************************************************************************************/
 882          #ifdef ZNFAT_READDATA 
 883          UINT32 znFAT_ReadData(struct FileInfo *pfi,UINT32 offset,UINT32 len,UINT8 *app_Buffer)
 884          {
 885   1       UINT32 Cluster_Size=0,iClu=0,next_clu=0,start_clu=0,end_clu=0;
 886   1       UINT32 temp=0,temp1=0,temp2=0,ncluster=0,have_read=0;
 887   1      
 888   1       just_file=pfi;
 889   1      
 890   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
 896   1      
 897   1       znFAT_Seek(pfi,offset); //ÎÄ¼ş¶¨Î»
 898   1      
 899   1       if(0==len) return 0; //Èç¹ûÒª¶ÁÈ¡µÄÊı¾İ³¤¶ÈÎª0£¬ÔòÖ±½Ó·µ»Ø
 900   1       
 901   1       Cluster_Size=(pInit_Args->SectorsPerClust*pInit_Args->BytesPerSector); //¼ÆËã´ØµÄ×Ü×Ö½ÚÊı¾İ£¬ÒÔÃâºóÃæÖØ¸´
             -¼ÆËã
 902   1       
 903   1       if((pfi->File_CurOffset+len)>=(pfi->File_Size)) //Èç¹û´Óµ±Ç°Î»ÖÃ¿ªÊ¼Òª¶ÁÈ¡µÄÊı¾İ³¤¶Èlen²»Ğ¡ÓÚÎÄ¼ş´óĞ¡
 904   1       {
 905   2        len=(pfi->File_Size-pfi->File_CurOffset);    //¶Ôlen½øĞĞĞŞÕı£¬ÖÃÎªÎÄ¼şÊ£Óà¿É¶ÁÊı¾İÁ¿¡£
 906   2        pfi->File_IsEOF=BOOL_TRUE;    //ÕâÖÖÇé¿öÏÂ£¬ÎÄ¼ş±ØÈ»»á¶Áµ½Ä©Î²¡£                    
 907   2       }
 908   1       
 909   1       //=======================================================================================================
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 16  

             -===== 
 910   1       if((pfi->File_CurOffset%Cluster_Size)!=0) //Èç¹ûµ±Ç°Æ«ÒÆÁ¿ÊÇ´Ø´óĞ¡ÕûÊı±¶£¬ËµÃ÷´ËÎ»ÖÃ¼´ÎªÕû´Ø¿ªÊ¼
 911   1       {                                         //²»ÒªÔÙ½øĞĞµ±Ç°´ØÄÚÊı¾İ´¦Àí£¬Ö±½Ó½øÈë´Ø-ÉÈÇø-×Ö½Ú½×¶Î
 912   2        znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //½«µ±Ç°ÉÈÇø¶ÁÈëÄÚ²¿»º³åÇø
 913   2      
 914   2        temp=pInit_Args->BytesPerSector-pfi->File_CurPos; //¼ÆËãµ±Ç°ÉÈÇøÖĞµÄÊ£ÓàÊı¾İÁ¿
 915   2      
 916   2        if(len<=temp)
 917   2        {
 918   3         Memory_Copy(app_Buffer,znFAT_Buffer+(pfi->File_CurPos),len);//½«ÄÚ²¿»º³åÇøÖĞÒª¶ÁµÄÊı¾İ¿½ÈëÓ¦ÓÃ»º³åÇø
 919   3         
 920   3         //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
 921   3         if(temp==len) //Èç¹ûÕıºÃ¶Áµ½µ±Ç°ÉÈÇøµÄÄ©Î²
 922   3         {
 923   4          if(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))//Èç¹ûµ±Ç°ÉÈÇøÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø        
             -             
 924   4          {
 925   5           if(!pfi->File_IsEOF) //Èç¹û²»ÊÇÎÄ¼şÄ©Î²
 926   5         {
 927   6          pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //¿ÉÄÜÓĞ¡°¾½´Ø¡± 
 928   6         }
 929   5           pfi->File_CurSec=SOC(pfi->File_CurClust);
 930   5          }
 931   4          else
 932   4          {
 933   5           pfi->File_CurSec++;  
 934   5          }
 935   4          pfi->File_CurPos=0; 
 936   4         }
 937   3         else
 938   3         {
 939   4          pfi->File_CurPos+=(UINT16)len; 
 940   4         }  
 941   3         pfi->File_CurOffset+=len;
 942   3      
 943   3         return len;
 944   3        }
 945   2        //======================================================================================================
             -=====
 946   2        else
 947   2        {
 948   3         temp=(pInit_Args->BytesPerSector-pfi->File_CurPos); //½«µ±Ç°ÉÈÇøµÄÊ£ÓàÊı¾İÁ¿¸³¸øÖĞ¼ä±äÁ¿temp
 949   3      
 950   3         Memory_Copy(app_Buffer,znFAT_Buffer+(pfi->File_CurPos),temp); //½«µ±Ç°ÉÈÇøÊ£ÓàÊı¾İÌÜµ½Ó¦ÓÃ»º³åÇø
 951   3         have_read+=temp;
 952   3        
 953   3         if(!(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
 954   3         {
 955   4          pfi->File_CurSec++;
 956   4          pfi->File_CurPos=0; 
 957   4      
 958   4          temp2=(len-have_read); //¼ÆËãÊ£ÓàÊı¾İÁ¿
 959   4          temp1=((LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec-1))*(pInit_Args->BytesPerSector)); //Ê£Ó
             -àËùÓĞÉÈÇøÊı¾İÁ¿
 960   4          if(temp2<=temp1) //Èç¹ûÒª¶ÁµÄÊ£ÓàÊı¾İÁ¿Ğ¡ÓÚµÈÓÚµ±Ç°´ØÊ£ÓàÊı¾İÁ¿ 
 961   4          {
 962   5         //ÕâËµÃ÷Òª¶ÁµÄÊı¾İÔÚµ±Ç°´ØÄÚ£¬Ã»ÓĞ¿çµ½ÏÂÒ»´Ø
 963   5           
 964   5           temp=temp2/(pInit_Args->BytesPerSector); //¼ÆËãÒª¶ÁÈ¡µÄÊ£ÓàÊı¾İ×ã¹»¼¸¸öÕûÉÈÇø 
 965   5           
 966   5         znFAT_Device_Read_nSector(temp,pfi->File_CurSec,app_Buffer+have_read);
 967   5         have_read+=((pInit_Args->BytesPerSector)*temp);
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 17  

 968   5      
 969   5           if(temp2==temp1)
 970   5           {
 971   6            if(!pfi->File_IsEOF) //Èç¹û²»ÊÇÎÄ¼şÄ©Î²
 972   6          {
 973   7           pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //¿ÉÄÜÓĞ¡°¾½´Ø¡± 
 974   7          }
 975   6            pfi->File_CurSec=SOC(pfi->File_CurClust); 
 976   6            pfi->File_CurPos=0;
 977   6           }
 978   5           else
 979   5           {
 980   6            pfi->File_CurSec+=temp; 
 981   6          temp=len-have_read;
 982   6      
 983   6            znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //µ±Ç°ÉÈÇøÖĞ¿ÉÄÜ»¹ÓĞ²¿·ÖÊ£ÓàÊı¾İÒª¶Á
 984   6            Memory_Copy(app_Buffer+have_read,znFAT_Buffer,temp); //½«×îºó²»×ãÉÈÇøµÄÊı¾İÌÜÈëÓ¦ÓÃ»º³åÇø
 985   6            //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
 986   6            pfi->File_CurPos=(UINT16)temp;
 987   6            
 988   6           }
 989   5           pfi->File_CurOffset+=len; 
 990   5          
 991   5           return len;
 992   5          }
 993   4          else //Èç¹ûÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı²»Ğ¡ÓÚµ±Ç°´ØµÄÊ£ÓàÉÈÇøÊı£¬¼´Òª¶ÁµÄÊı¾İ²»¹âÔÚµ±Ç°´ØÄÚ£¬ÒÑ¾­¿ç´ØÁË
 994   4          {
 995   5           temp=(LAST_SEC_OF_CLU(pfi->File_CurClust))-(pfi->File_CurSec)+1; //¼ÆËãµ±Ç°´Ø»¹ÓĞ¼¸¸öÕûÉÈÇø 
 996   5      
 997   5           znFAT_Device_Read_nSector(temp,(pfi->File_CurSec),app_Buffer+have_read);
 998   5           have_read+=((pInit_Args->BytesPerSector)*temp);
 999   5          }
1000   4         }
1001   3        
1002   3         //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±ÒÑ¾­¶ÁÍêµ±Ç°´ØµÄËùÓĞÊ£ÓàÊı¾İ£¬¿çµ½ÏÂÒ»´Ø
1003   3         pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //ÕâÀï²»»á²úÉú¡°¾½´Ø¡± 
1004   3         pfi->File_CurSec=SOC(pfi->File_CurClust); 
1005   3         pfi->File_CurPos=0;    
1006   3        }
1007   2       }
1008   1       //----------------------------ÒÔÉÏÊÇ´¦Àíµ±Ç°´ØÄÚµÄÊı¾İ-------------------------------------
1009   1      
1010   1       temp1=len-have_read;
1011   1       ncluster=temp1/Cluster_Size; //¼ÆËãÊ£ÓàÊı¾İµÄÕû´ØÊı
1012   1       if(ncluster>0) //Ê£ÓàÊı¾İÆğÂë×ã¹»Ò»¸ö´Ø
1013   1       {
1014   2        //ÒÔÏÂ¼ÆËãÁ¬Ğø´Ø¶Î£¬ÒÔ¾¡Á¿Ê¹ÓÃ¶àÉÈÇø¶ÁÈ¡Çı¶¯
1015   2        start_clu=end_clu=pfi->File_CurClust;
1016   2      
1017   2        for(iClu=1;iClu<ncluster;iClu++)
1018   2        {
1019   3         next_clu=Get_Next_Cluster(end_clu);
1020   3         if((next_clu-1)==end_clu)
1021   3         {
1022   4          end_clu=next_clu;
1023   4         }
1024   3         else
1025   3         {
1026   4          znFAT_Device_Read_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Buf
             -fer+have_read);
1027   4        have_read+=((end_clu-start_clu+1)*Cluster_Size);
1028   4        start_clu=end_clu=next_clu;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 18  

1029   4         }
1030   3        }
1031   2      
1032   2        //----------------------------ÒÔÉÏÊÇ´¦ÀíÕû´ØÊı¾İ------------------------------------------  
1033   2        temp=temp1%Cluster_Size; //¼ÆËãÕû´Ø¶ÁÍêÖ®ºó£¬ÊÇ·ñ»¹ÓĞÊı¾İÒª¶Á
1034   2        if(temp>0) //Õû´ØÊı¾İºóÃæ»¹ÓĞÊı¾İÒª¶Á
1035   2        {
1036   3         temp=temp/(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕ²»×ãÕû´ØµÄÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı
1037   3      
1038   3         
1039   3      
1040   3         next_clu=Get_Next_Cluster(end_clu);
1041   3         if((next_clu-1)==end_clu) //Èç¹û×îºóÒ»¸ö´ØÈÔÈ»ÓëÇ°ÃæµÄÁ¬Ğø´Ø¶ÎÁ¬Ğø
1042   3         {
1043   4          znFAT_Device_Read_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+temp),SOC(start_clu),ap
             -p_Buffer+have_read);
1044   4        have_read+=((pInit_Args->BytesPerSector)*((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+temp));
1045   4         }
1046   3         else //Èç¹û×îºóÒ»¸ö´ØÓëÇ°ÃæµÄÁ¬Ğø´Ø¶Î²¢²»Á¬Ğø
1047   3         {
1048   4          znFAT_Device_Read_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Buf
             -fer+have_read);
1049   4        have_read+=(Cluster_Size*(end_clu-start_clu+1));
1050   4          znFAT_Device_Read_nSector(temp,SOC(next_clu),app_Buffer+have_read);
1051   4        have_read+=(temp*(pInit_Args->BytesPerSector));
1052   4         }
1053   3      
1054   3         pfi->File_CurClust=next_clu;
1055   3         pfi->File_CurSec=(SOC(next_clu)+temp); 
1056   3      
1057   3         //----------------------------ÒÔÉÏÊÇ´¦ÀíÕûÉÈÇøÊı¾İ----------------------------------------
1058   3         temp=len-have_read;
1059   3         if(temp>0)
1060   3         {
1061   4          znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //½«×îºóµÄ¿ÉÄÜ°üº¬Ò»²¿·ÖÒª¶ÁµÄÊı¾İµÄÉÈÇø¶Áµ½Ä
             -Ú²¿»º³åÇø
1062   4          Memory_Copy(app_Buffer+have_read,znFAT_Buffer,temp); //½«×îºó²»×ãÉÈÇøµÄÊı¾İÓàÁ¿ÌÜÈëÓ¦ÓÃ»º³åÇø
1063   4        
1064   4          //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±Êı¾İ¶ÁÈ¡²Ù×÷ÒÑ¾­½áÊø
1065   4          pfi->File_CurPos=(UINT16)temp;    
1066   4         }
1067   3         //----------------------------ÒÔÉÏÊÇ´¦Àí×îºóÉÈÇøÄÚµÄÊ£Óà×Ö½Ú----------------------------------------
1068   3        }
1069   2        else //Õû´ØÊı¾İ¶ÁÍêÖ®ºóÔÙÎŞÊı¾İÒª¶Á
1070   2        {
1071   3         znFAT_Device_Read_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Buff
             -er+have_read);
1072   3      
1073   3         pfi->File_CurClust=end_clu;
1074   3         if(!pfi->File_IsEOF) 
1075   3         {
1076   4          pfi->File_CurClust=Get_Next_Cluster(end_clu);
1077   4         }
1078   3         pfi->File_CurSec=SOC(pfi->File_CurClust); 
1079   3        }
1080   2       }
1081   1       else //Ê£ÓàµÄÊı¾İ²»×ãÒ»¸ö´Ø
1082   1       {
1083   2        temp=temp1/(pInit_Args->BytesPerSector); //¼ÆËãÊ£ÓàµÄÊı¾İ×ã¹»¼¸¸öÉÈÇø
1084   2        znFAT_Device_Read_nSector(temp,SOC(pfi->File_CurClust),app_Buffer+have_read);
1085   2        have_read+=temp*(pInit_Args->BytesPerSector);
1086   2      
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 19  

1087   2        pfi->File_CurSec+=temp;
1088   2        
1089   2        temp=temp1%(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕµÄ²»×ãÒ»ÉÈÇøµÄÊı¾İÁ¿
1090   2        if(temp>0) //Èç¹û×îºó»¹ÓĞÊı¾İ
1091   2        {
1092   3         znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer);
1093   3         Memory_Copy(app_Buffer+have_read,znFAT_Buffer,temp);
1094   3      
1095   3         pfi->File_CurPos=(UINT16)temp;
1096   3        }
1097   2       }
1098   1      
1099   1       //----------------------------------------------------------------------------------------
1100   1       pfi->File_CurOffset+=len;
1101   1      
1102   1       return len;
1103   1      }
1104          #endif
1105          
1106          /******************************************************************************************
1107           ¹¦ÄÜ£ºÎÄ¼şÊı¾İ¶ÁÈ¡+Êı¾İÖØ¶¨Ïò
1108           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë offset:Êı¾İ¶ÁÈ¡µÄ¿ªÊ¼Æ«ÒÆÁ¿ len:Òª¶ÁÈ¡µÄ×Ö½ÚÊı
1109                 app_Buffer:Ó¦ÓÃÊı¾İ»º³åÇøÖ¸Õë
1110           ·µ»Ø£ºÊµ¼Ê¶ÁÈ¡µ½µÄÊı¾İ³¤¶È 
1111           Ïê½â£º´Ëº¯ÊıµÄÊµÏÖ¹ı³ÌÓëÉÏÃæµÄÊı¾İ¶ÁÈ¡º¯ÊıÏàËÆ£¬²»Í¬ÔÚÓÚ¿ÉÒÔ¶Ô¶Áµ½µÄÊı¾İ½øĞĞÖØĞÂ¶¨Ïò¡£
1112                 ÉÏÃæµÄÊı¾İ¶ÁÈ¡º¯ÊıÊÇ½«Êı¾İÖ±½Ó·Åµ½ÁËÓ¦ÓÃÊı¾İ»º³åÇøÖĞ£¬µ«ÊÇÔÚÄ³Ğ©Ó²¼şÆ½Ì¨ÉÏRAM×ÊÔ´
1113                 ±È½Ï½ôÕÅ£¬¿ª±Ù³ö½Ï´óµÄÓ¦ÓÃÊı¾İ»º³åÇø²»Ì«ÏÖÊµ£¬Òò´ËÔÚÕâÀïÒıÈëÖØ¶¨ÏòµÄ¸ÅÄî£¬¿ÉÒÔ½«
1114                 ¶Áµ½µÄÃ¿Ò»¸ö×Ö½ÚÊ¹ÓÃÄ³¸öº¯ÊıÖ±½Ó½øĞĞ´¦Àí£¬¶ø²»·ÅÔÚ»º³åÇøÖĞ¡£Õâ¸öÓÃÓÚ´¦Àí×Ö½ÚÊı¾İµÄ
1115                 º¯ÊıÓÉÊ¹ÓÃÕßÌá¹©£¬Õâ¸öº¯ÊıµÄº¯ÊıÃûÔÚznfat.hÖĞ±»ºê¶¨ÒåÎªData_Redirect¡£±ÈÈçÈç¹ûÏë°Ñ
1116                 ¶Áµ½µÄÊı¾İÍ¨¹ı´®¿Ú·¢³ö£¬ÔòÔÚznfat.hÖĞ½«ºê¶¨Òå¸ÄÎª #define Data_Redirect Send_Byte
1117                 Send_Byte¾ÍÊÇ´®¿Ú·¢ËÍ×Ö½ÚµÄº¯ÊıµÄº¯ÊıÃû¡£
1118          ******************************************************************************************/
1119          #ifdef ZNFAT_READDATAX 
              UINT32 znFAT_ReadDataX(struct FileInfo *pfi,UINT32 offset,UINT32 len) //Êı¾İÖØ¶¨Ïò¶ÁÈ¡Ì×ÓÃÁËÊı¾İ¶ÁÈ¡º¯Êı£¬
             -µ«²¢²»Ê¹ÓÃ¶àÉÈÇøÇı¶¯
              {                                                                     //¼ÓÖ®Ã»ÓĞ×ã¹»µÄRAM×ÊÔ´£¬ÇÒÃ¿´Î´¦ÀíÒ
             -»¸ö×Ö½Ú£¬Òò´ËĞ§ÂÊ²»¸ß
               UINT32 Cluster_Size=0,iClu=0,iSec=0,next_clu=0,start_clu=0,end_clu=0;
               UINT32 temp=0,temp1=0,temp2=0,k=0,ncluster=0,have_read=0;
               UINT32 i=0;
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               znFAT_Seek(pfi,offset); //ÎÄ¼ş¶¨Î»
               
               Cluster_Size=(pInit_Args->SectorsPerClust*pInit_Args->BytesPerSector); //¼ÆËã´ØµÄ×Ü×Ö½ÚÊı¾İ£¬ÒÔÃâºóÃæÖØ¸´
             -¼ÆËã
               
               if((pfi->File_CurOffset+len)>=(pfi->File_Size)) //Èç¹û´Óµ±Ç°Î»ÖÃ¿ªÊ¼Òª¶ÁÈ¡µÄÊı¾İ³¤¶Èlen²»Ğ¡ÓÚÎÄ¼ş´óĞ¡
               {
                len=(pfi->File_Size-pfi->File_CurOffset);    //¶Ôlen½øĞĞĞŞÕı£¬ÖÃÎªÎÄ¼şÊ£Óà¿É¶ÁÊı¾İÁ¿¡£
                pfi->File_IsEOF=BOOL_TRUE;    //ÕâÖÖÇé¿öÏÂ£¬ÎÄ¼ş±ØÈ»»á¶Áµ½Ä©Î²¡£                    
               }
               
               //=================================================================== 
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 20  

               if((pfi->File_CurOffset%Cluster_Size)!=0) //Èç¹ûµ±Ç°Æ«ÒÆÁ¿ÊÇ´Ø´óĞ¡ÕûÊı±¶£¬ËµÃ÷´ËÎ»ÖÃ¼´ÎªÕû´Ø¿ªÊ¼
               {                                         //²»ÒªÔÙ½øĞĞµ±Ç°´ØÄÚÊı¾İ´¦Àí£¬Ö±½Ó½øÈë´Ø-ÉÈÇø-×Ö½Ú½×¶Î
                znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //½«µ±Ç°ÉÈÇø¶ÁÈëÄÚ²¿»º³åÇø
              
                temp=pInit_Args->BytesPerSector-pfi->File_CurPos; //¼ÆËãµ±Ç°ÉÈÇøÖĞµÄÊ£ÓàÊı¾İÁ¿
                if(len<=temp)
                {
                 for(i=0;i<len;i++)
                 {
                Data_Redirect(znFAT_Buffer[i+(pfi->File_CurPos)]);
                 }
                 
                 //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
                 if(temp==len) //Èç¹ûÕıºÃ¶Áµ½µ±Ç°ÉÈÇøµÄÄ©Î²
                 {
                  if(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))//Èç¹ûµ±Ç°ÉÈÇøÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø        
             -             
                  {
                   if(!pfi->File_IsEOF) //Èç¹û²»ÊÇÎÄ¼şÄ©Î²
                 {
                  pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //¿ÉÄÜÓĞ¡°¾½´Ø¡± 
                 }
                   pfi->File_CurSec=SOC(pfi->File_CurClust);
                  }
                  else
                  {
                   pfi->File_CurSec++;  
                  }
                  pfi->File_CurPos=0; 
                 }
                 else
                 {
                  pfi->File_CurPos+=(UINT16)len; 
                 }  
                 pfi->File_CurOffset+=len;
              
                 return len;
                }
                //===================================================================
                else
                {
                 temp=(pInit_Args->BytesPerSector-pfi->File_CurPos); //½«µ±Ç°ÉÈÇøµÄÊ£ÓàÊı¾İÁ¿¸³¸øÖĞ¼ä±äÁ¿temp
              
                 for(i=0;i<temp;i++)
                 {
                Data_Redirect(znFAT_Buffer[i+(pfi->File_CurPos)]);
                 }
                 
                 have_read+=temp;
                
                 if(!(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
                 {
                  pfi->File_CurSec++;
                  pfi->File_CurPos=0; 
              
                  temp2=(len-have_read); //¼ÆËãÊ£ÓàÊı¾İÁ¿
                  temp1=((LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec-1))*(pInit_Args->BytesPerSector)); //Ê£Ó
             -àËùÓĞÉÈÇøÊı¾İÁ¿
                  if(temp2<=temp1) //Èç¹ûÒª¶ÁµÄÊ£ÓàÊı¾İÁ¿Ğ¡ÓÚµÈÓÚµ±Ç°´ØÊ£ÓàÊı¾İÁ¿ 
                  {
                 //ÕâËµÃ÷Òª¶ÁµÄÊı¾İÔÚµ±Ç°´ØÄÚ£¬Ã»ÓĞ¿çµ½ÏÂÒ»´Ø
                   
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 21  

                   temp=temp2/(pInit_Args->BytesPerSector); //¼ÆËãÒª¶ÁÈ¡µÄÊ£ÓàÊı¾İ×ã¹»¼¸¸öÕûÉÈÇø 
              
                 for(iSec=0;iSec<temp;iSec++)
                 {
                  znFAT_Device_Read_Sector(pfi->File_CurSec+iSec,znFAT_Buffer);
                  for(i=0;i<(pInit_Args->BytesPerSector);i++)
                  {
                   Data_Redirect(znFAT_Buffer[i]);
                  }
                 }
                 
                 have_read+=temp*(pInit_Args->BytesPerSector);
              
                   if(temp2==temp1)
                   {
                    if(!pfi->File_IsEOF) //Èç¹û²»ÊÇÎÄ¼şÄ©Î²
                  {
                   pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //¿ÉÄÜÓĞ¡°¾½´Ø¡± 
                  }
                    pfi->File_CurSec=SOC(pfi->File_CurClust); 
                    pfi->File_CurPos=0;
                   }
                   else
                   {
                    pfi->File_CurSec+=temp; 
                  temp=len-have_read;
              
                    znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //µ±Ç°ÉÈÇøÖĞ¿ÉÄÜ»¹ÓĞ²¿·ÖÊ£ÓàÊı¾İÒª¶Á
                    for(i=0;i<temp;i++)
                  {
                   Data_Redirect(znFAT_Buffer[i]);
                  }
                    //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
                    pfi->File_CurPos=(UINT16)temp;
                    
                   }
                   pfi->File_CurOffset+=len; 
                  
                   return len;
                  }
                  else //Èç¹ûÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı²»Ğ¡ÓÚµ±Ç°´ØµÄÊ£ÓàÉÈÇøÊı£¬¼´Òª¶ÁµÄÊı¾İ²»¹âÔÚµ±Ç°´ØÄÚ£¬ÒÑ¾­¿ç´ØÁË
                  {
                   temp=(LAST_SEC_OF_CLU(pfi->File_CurClust))-(pfi->File_CurSec)+1; //¼ÆËãµ±Ç°´Ø»¹ÓĞ¼¸¸öÕûÉÈÇø 
              
                 for(iSec=0;iSec<temp;iSec++)
                 {
                  znFAT_Device_Read_Sector(pfi->File_CurSec+iSec,znFAT_Buffer);
                  for(i=0;i<(pInit_Args->BytesPerSector);i++)
                  {
                   Data_Redirect(znFAT_Buffer[i]);
                  }
                 }
                 have_read+=temp*(pInit_Args->BytesPerSector);
                  }
                 }
                
                 //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±ÒÑ¾­¶ÁÍêµ±Ç°´ØµÄËùÓĞÊ£ÓàÊı¾İ£¬¿çµ½ÏÂÒ»´Ø
                 pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //ÕâÀï²»»á²úÉú¡°¾½´Ø¡± 
                 pfi->File_CurSec=SOC(pfi->File_CurClust); 
                 pfi->File_CurPos=0;    
                }
               }
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 22  

               //----------------------------ÒÔÉÏÊÇ´¦Àíµ±Ç°´ØÄÚµÄÊı¾İ-------------------------------------
               temp1=len-have_read;
               ncluster=temp1/Cluster_Size; //¼ÆËãÊ£ÓàÊı¾İµÄÕû´ØÊı
              
               if(ncluster>0) //Ê£ÓàÊı¾İÆğÂë×ã¹»Ò»¸ö´Ø
               {
                //ÒÔÏÂ¼ÆËãÁ¬Ğø´Ø¶Î£¬ÒÔ¾¡Á¿Ê¹ÓÃ¶àÉÈÇø¶ÁÈ¡Çı¶¯
                start_clu=end_clu=pfi->File_CurClust;
              
                for(iClu=1;iClu<ncluster;iClu++)
                {
                 next_clu=Get_Next_Cluster(end_clu);
                 if((next_clu-1)==end_clu)
                 {
                  end_clu=next_clu;
                 }
                 else
                 {
                  temp=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust));
                  for(iSec=0;iSec<temp;iSec++)
                {
                 znFAT_Device_Read_Sector(SOC(start_clu)+iSec,znFAT_Buffer);
                 for(i=0;i<(pInit_Args->BytesPerSector);i++)
                 {
                  Data_Redirect(znFAT_Buffer[i]);
                 }
                }
                  have_read+=temp*(pInit_Args->BytesPerSector);
                start_clu=end_clu=next_clu;
                 }
                }
              
                //----------------------------ÒÔÉÏÊÇ´¦ÀíÕû´ØÊı¾İ------------------------------------------  
                temp=temp1%Cluster_Size; //¼ÆËãÕû´Ø¶ÁÍêÖ®ºó£¬ÊÇ·ñ»¹ÓĞÊı¾İÒª¶Á
                if(temp>0) //Õû´ØÊı¾İºóÃæ»¹ÓĞÊı¾İÒª¶Á
                { 
                 temp=temp/(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕ²»×ãÕû´ØµÄÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı
                 next_clu=Get_Next_Cluster(end_clu);
                 if((next_clu-1)==end_clu) //Èç¹û×îºóÒ»¸ö´ØÈÔÈ»ÓëÇ°ÃæµÄÁ¬Ğø´Ø¶ÎÁ¬Ğø
                 {
                  temp2=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+temp);
                  for(iSec=0;iSec<temp2;iSec++)
                {
                 znFAT_Device_Read_Sector(SOC(start_clu)+iSec,znFAT_Buffer);
              
                 for(i=0;i<(pInit_Args->BytesPerSector);i++)
                 {
                  Data_Redirect(znFAT_Buffer[i]);
                 }
                }
                 }
                 else //Èç¹û×îºóÒ»¸ö´ØÓëÇ°ÃæµÄÁ¬Ğø´Ø¶Î²¢²»Á¬Ğø
                 {
                temp2=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust));
                  for(iSec=0;iSec<temp2;iSec++)
                {
                 znFAT_Device_Read_Sector(SOC(start_clu)+iSec,znFAT_Buffer);
              
                 for(i=0;i<(pInit_Args->BytesPerSector);i++)
                 {
                  Data_Redirect(znFAT_Buffer[i]);
                 }
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 23  

                }
              
                  for(iSec=0;iSec<temp;iSec++)
                {
                 znFAT_Device_Read_Sector(SOC(next_clu)+iSec,znFAT_Buffer);
              
                 for(i=0;i<(pInit_Args->BytesPerSector);i++)
                 {
                  Data_Redirect(znFAT_Buffer[i]);
                 }
                }
                 }
                 
                 have_read+=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+temp)*(pInit_Args->BytesPerSector);
              
                 pfi->File_CurClust=next_clu;
                 pfi->File_CurSec=(SOC(next_clu)+temp); 
              
                 //----------------------------ÒÔÉÏÊÇ´¦ÀíÕûÉÈÇøÊı¾İ----------------------------------------
                 temp=len-have_read;
                 if(temp>0)
                 {
                  znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //½«×îºóµÄ¿ÉÄÜ°üº¬Ò»²¿·ÖÒª¶ÁµÄÊı¾İµÄÉÈÇø¶Áµ½Ä
             -Ú²¿»º³åÇø
                
                for(i=0;i<temp;i++)
                {
                 Data_Redirect(znFAT_Buffer[i]);
                }
              
                  //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±Êı¾İ¶ÁÈ¡²Ù×÷ÒÑ¾­½áÊø
                  pfi->File_CurPos=(UINT16)temp;    
                 }
                 //----------------------------ÒÔÉÏÊÇ´¦Àí×îºóÉÈÇøÄÚµÄÊ£Óà×Ö½Ú----------------------------------------
                }
                else //Õû´ØÊı¾İ¶ÁÍêÖ®ºóÔÙÎŞÊı¾İÒª¶Á
                {
                 temp2=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust));
                 for(iSec=0;iSec<temp2;iSec++)
                 {
                znFAT_Device_Read_Sector(SOC(start_clu)+iSec,znFAT_Buffer);
                for(i=0;i<(pInit_Args->BytesPerSector);i++)
                {
                 Data_Redirect(znFAT_Buffer[i]);
                }
                 }
              
                 pfi->File_CurClust=end_clu;
                 if(!pfi->File_IsEOF) 
                 {
                  pfi->File_CurClust=Get_Next_Cluster(end_clu);
                 }
                 pfi->File_CurSec=SOC(pfi->File_CurClust); 
                }
               }
               else //Ê£ÓàµÄÊı¾İ²»×ãÒ»¸ö´Ø
               {
                temp=temp1/(pInit_Args->BytesPerSector); //¼ÆËãÊ£ÓàµÄÊı¾İ×ã¹»¼¸¸öÉÈÇø
                for(iSec=0;iSec<temp;iSec++)
                {
                 znFAT_Device_Read_Sector(SOC(pfi->File_CurClust)+iSec,znFAT_Buffer);
                 for(i=0;i<(pInit_Args->BytesPerSector);i++)
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 24  

                 {
                Data_Redirect(znFAT_Buffer[i]);
                 }
                }
              
                pfi->File_CurSec+=temp;
                
                temp=temp1%(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕµÄ²»×ãÒ»ÉÈÇøµÄÊı¾İÁ¿
                if(temp>0) //Èç¹û×îºó»¹ÓĞÊı¾İ
                {
                 znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer);
                 for(i=0;i<temp;i++)
                 {
                Data_Redirect(znFAT_Buffer[i]);
                 }
              
                 pfi->File_CurPos=temp;
                }
               }
              
               //----------------------------------------------------------------------------------------
               pfi->File_CurOffset+=len;
              
               return len;
              }
              #endif
1417          
1418          //----------------------------ÒÔÏÂº¯ÊıÓÃÓÚ¼ìÑéÎÄ¼şÃûµÄºÏ·¨ĞÔ----------------------------------
1419          
1420          /******************************************************************************************
1421           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûÖĞÊÇ·ñº¬ÓĞ·Ç·¨×Ö·û£¬·Ç·¨×Ö·ûÓĞ \/:"<>| 
1422           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1423           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü  ³É¹¦£ºÎÄ¼şÃûÖĞÎŞ·Ç·¨×Ö·û£¬·´Ö®ÔòÓĞ 
1424           Ïê½â£º¶ÔÓÚÎÄ¼şÃûÖĞ·Ç·¨×Ö·ûµÄ¼ì²é£¬ÆäÊµ»¹ÓĞÁ½¸ö×Ö·û*?£¬µ«ÊÇznFATÊÇÖ§³ÖÎÄ¼şÃûµÄÍ¨ÅäµÄ£¬Òò´Ë
1425                 ÕâÀï²»ÏŞÖÆ*Óë?£¬ÔÚ´ò¿ªÎÄ¼şºÍÄ¿Â¼µÄÊ±ºòËùÊ¹ÓÃµÄÎÄ¼şÃûÖĞÊÇ´øÓĞ*Óë?£¬µ«´´½¨ÎÄ¼şºÍÄ¿Â¼Ê±
1426                 ÎÄ¼şÃûÖĞÔò²»¿ÉÓĞ*Óë?£¬ÇëÊ¹ÓÃÕß×¢Òâ£¡
1427          ******************************************************************************************/
1428          #ifdef CHECK_ILLEGAL_CHAR
1429          UINT8 Check_Illegal_Char(INT8 *pfn) 
1430          {
1431   1       UINT32 i=0;
1432   1       while(pfn[i])
1433   1       {
1434   2        if(('\\'==pfn[i]) || ('/'==pfn[i]) || (':'==pfn[i])  
1435   2         || /*('*'==pfn[i]) || ('?'==pfn[i]) ||*/ ('"'==pfn[i])  
1436   2         || ('<'==pfn[i]) || ('>'==pfn[i]) || ('|'==pfn[i]))
1437   2        return ERR_FAIL;
1438   2        i++;
1439   2       }
1440   1       return ERR_SUCC;
1441   1      }
1442          #endif
1443          
1444          /******************************************************************************************
1445           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûÖĞÊÇ·ñº¬ÓĞÌØÊâ×Ö·û£¬+[],;=space
1446           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1447           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü  ³É¹¦£ºÎÄ¼şÃûÖĞÎŞÌØÊâ×Ö·û£¬·´Ö®ÔòÓĞ 
1448           Ïê½â£º¶ÔÓÚ8.3¸ñÊ½µÄÎÄ¼şÃû£¬Èç¹ûÆäÖĞ°üº¬ÁËÌØÊâ×Ö·û£¬ÔòÆä±»ÊÓÎª³¤ÎÄ¼şÃû£¬¶ø·Ç¶ÌÃû¡£ÒòÎª¶ÌÃû
1449                 Óë³¤ÃûÔÚ´¦Àí·½·¨ÊÇ²»Í¬µÄ£¬Òò´Ë¶ÔËüÃÇÇø·Ö¿ªÀ´¡£SFNÊÇShort FileNameµÄËõĞ´£¬´øÓĞSFNµÄº¯
1450                 ÊÇÕë¶Ô¶ÌÃûµÄ¼ì²é
1451          ******************************************************************************************/
1452          #ifdef CHECK_SFN_SPECIAL_CHAR
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 25  

1453          UINT8 Check_SFN_Special_Char(INT8 *pfn) 
1454          {
1455   1       UINT32 i=0;
1456   1       UINT32 pos=(StringLen(pfn)-1);
1457   1      
1458   1       while(' '==pfn[pos]) pos--;
1459   1       
1460   1       while(i<=pos)
1461   1       {
1462   2        if( ('+'==pfn[i]) || ('['==pfn[i]) 
1463   2         || (']'==pfn[i]) || (','==pfn[i])
1464   2         || (' '==pfn[i]) || (';'==pfn[i])
1465   2         || ('='==pfn[i]))
1466   2        return ERR_FAIL;
1467   2        i++;
1468   2       }
1469   1      
1470   1       return ERR_SUCC;
1471   1      }
1472          #endif
1473          
1474          /******************************************************************************************
1475           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûÖĞµÄ.ÊÇ·ñ·ûºÏSFNÒªÇó
1476           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1477           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
1478           Ïê½â£ºSFNÖĞµÄ.²»µÃ¶àÓÚ1¸ö£¬ÈçA..A.TXT¡¢A.A.A¡¢AA.A..AµÈ¾ù·ÇSFN£¬ÎÄ¼şÃû²»µÃÒÔ.¿ªÊ¼
1479                 Èô¸É¸ö.Èç¹ûÔÚÄ©Î²Ôò¾ù±»ºöÂÔ
1480          ******************************************************************************************/
1481          #ifdef CHECK_SFN_DOT
1482          UINT8 Check_SFN_Dot(INT8 *pfn) 
1483          {
1484   1       UINT32 pos=(StringLen(pfn)-1);
1485   1       UINT32 dot_counter=0;
1486   1      
1487   1       if('.'==pfn[0]) return ERR_FAIL;
1488   1      
1489   1       while(pos>0) 
1490   1       {
1491   2        if('.'==pfn[pos])
1492   2        {
1493   3         dot_counter++;
1494   3        }
1495   2        pos--;
1496   2       }
1497   1      
1498   1       if(dot_counter>1) return ERR_FAIL;
1499   1       else return ERR_SUCC;
1500   1      }
1501          #endif
1502          
1503          /******************************************************************************************
1504           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûµÄ´óĞ¡Ğ´ÊÇ·ñ·ûºÏSFNÒªÇó
1505           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1506           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
1507           Ïê½â£ºSFNÖĞÊÇ²»¿ÉÄÜÓĞ´óĞ¡Ğ´»ìÅÅµÄ£¬±ÈÈçAabcC.txt ABC.Txt AbCdef.TXT¶¼²»ÊÇSFN£¬¶øÊÇ³¤Ãû
1508                 ¼òÑÔÖ®£¬SFNµÄÖ÷ÎÄ¼şÃûºÍÀ©Õ¹Ãû±ØĞë¾ùÊÇ´óĞ´»òĞ¡Ğ´£¬±ÈÈçaaa.TXT AAA.txt aaa.txt AA.TXT
1509                 ¾ùÊÇSFN
1510          ******************************************************************************************/
1511          #ifdef CHECK_SFN_ILLEGAL_LOWER
1512          UINT8 Check_SFN_Illegal_Lower(INT8 *pfn)
1513          {
1514   1       UINT32 i=(StringLen(pfn)-1);
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 26  

1515   1       UINT8 flag1=2,flag2=2; 
1516   1      
1517   1       while('.'!=pfn[i] && i>0)
1518   1       {
1519   2        if(pfn[i]>='a' && pfn[i]<='z') 
1520   2        {
1521   3         if(0==flag1)
1522   3         {
1523   4        return (UINT8)-1;
1524   4         }
1525   3         flag1=1;
1526   3        }
1527   2      
1528   2        if(pfn[i]>='A' && pfn[i]<='Z') 
1529   2        {
1530   3         if(1==flag1)
1531   3         {
1532   4        return (UINT8)-1;
1533   4         }
1534   3         flag1=0;
1535   3        }
1536   2      
1537   2        i--;
1538   2       }
1539   1      
1540   1       if(0==i) //Èç¹ûÃ»ÓĞ.ËµÃ÷Ã»ÓĞÀ©Õ¹Ãû
1541   1       { 
1542   2        if(pfn[0]>='a' && pfn[0]<='z') 
1543   2        {
1544   3         if(0==flag1)
1545   3         {
1546   4        return (UINT8)-1;
1547   4         }
1548   3         flag1=1;
1549   3        }
1550   2      
1551   2        flag2=flag1; 
1552   2        flag1=0;
1553   2       }
1554   1      
1555   1       if('.'==pfn[i])
1556   1       {
1557   2        i--;
1558   2       }
1559   1      
1560   1       while(i>0)
1561   1       {
1562   2        if(pfn[i]>='a' && pfn[i]<='z') 
1563   2        {
1564   3         if(0==flag2)
1565   3         {
1566   4        return (UINT8)-1;
1567   4         }
1568   3         flag2=1;
1569   3        }
1570   2      
1571   2        if(pfn[i]>='A' && pfn[i]<='Z') 
1572   2        {
1573   3         if(1==flag2)
1574   3         {
1575   4        return (UINT8)-1;
1576   4         }
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 27  

1577   3         flag2=0;
1578   3        }
1579   2      
1580   2        i--;  
1581   2       }
1582   1      
1583   1       if(2==flag2)
1584   1       {
1585   2        if(pfn[0]>='a' && pfn[0]<='z') 
1586   2        {
1587   3         flag2=1;
1588   3        }
1589   2        if(pfn[0]>='A' && pfn[0]<='Z')
1590   2        {
1591   3         flag2=0;
1592   3        }
1593   2       }
1594   1       
1595   1       return (UINT8)((flag1<<4)|(flag2));
1596   1      }
1597          #endif
1598          
1599          /******************************************************************************************
1600           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûµÄ³¤¶ÈÊÇ·ñ·ûºÏSFNÒªÇó
1601           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1602           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
1603           Ïê½â£º8.3¸ñÊ½µÄSFN£¬ÒªÇóÖ÷ÎÄ¼şÃûµÄ³¤¶È0<len<=8 À©Õ¹Ãû³¤¶È0<=len<=3£¬²»·ûºÏÕâÒ»ÒªÇóµÄ¾ùÎª³¤
1604                 Ãû
1605          ******************************************************************************************/
1606          #ifdef CHECK_SFN_ILLEGAL_LENGTH
1607          UINT8 Check_SFN_Illegal_Length(INT8 *pfn)
1608          {
1609   1       UINT8 dot_pos=0,have_dot=0,i=0;
1610   1       UINT8 mainfn_len=0,extfn_len=0;
1611   1       UINT32 fn_len=StringLen(pfn);
1612   1      
1613   1       while(' '==pfn[fn_len-1]) fn_len--;
1614   1      
1615   1       if(fn_len>12) return ERR_FAIL; //fn is longer than 8.3
1616   1      
1617   1       for(i=(UINT8)(fn_len-1);i>0;i--) //·´ÏòÑ°ÕÒ. µÚÒ»¸ö.ÊÇÖ÷ÎÄ¼şÓëÀ©Õ¹ÃûµÄ·Ö½ç
1618   1       {
1619   2        if('.'==pfn[i]) 
1620   2        {
1621   3         dot_pos=i;
1622   3         have_dot=1;
1623   3         break;
1624   3        }
1625   2       }
1626   1       
1627   1       if(0==have_dot) //Ã»ÓĞµã
1628   1       {
1629   2        mainfn_len=(UINT8)fn_len;
1630   2        extfn_len=0;
1631   2      
1632   2        if((mainfn_len>0 && mainfn_len<=8))
1633   2        {
1634   3         return ERR_SUCC;
1635   3        }
1636   2        else
1637   2        {
1638   3         return ERR_FAIL;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 28  

1639   3        }
1640   2       }
1641   1       else //ÓĞµã
1642   1       {
1643   2        mainfn_len=dot_pos;
1644   2        extfn_len=(UINT8)(((UINT8)fn_len)-(UINT8)(dot_pos+1));
1645   2      
1646   2        if(( mainfn_len>0  && mainfn_len<=8) 
1647   2         && (/*extfn_len>=0  && */extfn_len <=3))
1648   2        {
1649   3         return ERR_SUCC;
1650   3        }
1651   2        else
1652   2        {
1653   3         return ERR_FAIL;
1654   3        }
1655   2       }  
1656   1      }
1657          #endif
1658          //--------------------------------ÒÔÉÏº¯ÊıÓÃÓÚ¼ìÑéSFNµÄºÏ·¨ĞÔ----------------------------------
1659          
1660          /******************************************************************************************
1661           ¹¦ÄÜ£º½«Ò»¸öÎÄ¼şÄ¿Â¼ÏîÖĞµÄÇ°11¸ö×Ö½Ú£¨ÓÃÓÚ¼ÇÂ¼8.3¶ÌÎÄ¼şÃû£©×ªÎªÎÄ¼şÃû
1662           ĞÎ²Î£ºname_in_fdi:Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÖĞÓÃÓÚ¼ÇÂ¼ÎÄ¼şÃûµÄ×Ö½ÚĞòÁĞµÄÖ¸Õë pfilename:ÓÃÓÚ¼ÇÂ¼×ª»»ºóµÄ
1663                 ÎÄ¼şÃûµÄÊı×éµÄÖ¸Õë
1664           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
1665           Ïê½â£ºÔÚ´ò¿ªÎÄ¼şºÍÄ¿Â¼µÈº¯ÊıÖĞ£¬°ÑÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼şÃû×Ö¶Î×ªÎªÎÄ¼şÃû£¬ÒÔ·½±ãÓëÄ¿±êÎÄ¼ş½øĞĞ
1666                 Æ¥ÅäºÍ±È¶Ô¡£±ÈÈçÒª´ò¿ªABC.TXT ËüËù¶ÔÓ¦µÄÎÄ¼şÄ¿Â¼Ïî¼ÇÂ¼µÄĞÎÊ½ÎªABC     TXT£¬¶şÕßÊÇ²»ÄÜ
1667                 Ö±½Ó½øĞĞ±È½ÏµÄ£¬ÒªÏÈ½«ABC     TXT×ªÎªABC.TXT£¬È»ºóÔÙ±È½Ï¡£
1668          ******************************************************************************************/
1669          #ifdef TO_FILE_NAME
1670          UINT8 To_File_Name(INT8 *name_in_fdi,INT8 *pfileName)
1671          {
1672   1       UINT8 i=0,n=7,m=10;
1673   1      
1674   1       while(' '==name_in_fdi[n])
1675   1       {
1676   2        n--;
1677   2       }
1678   1       n++;
1679   1      
1680   1       while(' '==name_in_fdi[m] && m>=8)
1681   1       {
1682   2        m--;
1683   2       }
1684   1       m-=7;
1685   1      
1686   1       for(i=0;i<n;i++)
1687   1       {
1688   2        pfileName[i]=name_in_fdi[i];
1689   2       }
1690   1       pfileName[i]='.';
1691   1      
1692   1       for(i=0;i<m;i++)
1693   1       {
1694   2        pfileName[n+i+1]=name_in_fdi[8+i];
1695   2       }
1696   1      
1697   1       if('.'==pfileName[n+m]) pfileName[n+m]=0;
1698   1       else pfileName[n+m+1]=0;
1699   1      
1700   1       return 0;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 29  

1701   1      }
1702          #endif
1703          
1704          /******************************************************************************************
1705           ¹¦ÄÜ£º½âÎöÒ»¸öÎÄ¼şÄ¿Â¼Ïî£¬½«½âÎöµÃµ½µÄ²ÎÊı×°Èëµ½ÎÄ¼şĞÅÏ¢¼¯ºÏÖĞ
1706           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë pFDI:Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë
1707           ·µ»Ø£º0
1708           Ïê½â£º´Ëº¯Êı±»´ò¿ªÎÄ¼şµÄº¯Êıµ÷ÓÃ£¬¶Ô·ûºÏÆ¥ÅäÌõ¼şµÄÎÄ¼şÄ¿Â¼Ïî½øĞĞ½âÎö£¬²¢½«²ÎÊı×°Èëµ½ÎÄ¼şĞÅ
1709                 Ï¢¼¯ºÏÖĞ£¬ÒÔ±ã¶ÔÎÄ¼ş½øĞĞ½øÒ»²½µÄ²Ù×÷Ê±Ê¹ÓÃ¡£
1710          ******************************************************************************************/
1711          #ifdef ANALYSE_FDI
1712          UINT8 Analyse_FDI(struct FileInfo *pfi,struct FDI *pFDI)
1713          {
1714   1       UINT32 temp=0,i=0;
1715   1      
1716   1       //==========================================================
1717   1      
1718   1       just_file=pfi;
1719   1      
1720   1       To_File_Name((INT8 *)pFDI,pfi->File_Name);
1721   1       
1722   1       temp=(StringLen(pfi->File_Name)-1);
1723   1       while('.'!=(pfi->File_Name)[temp] && temp>0)
1724   1       {
1725   2        if(((pFDI->LowerCase)&0x10)!=0) 
1726   2        {
1727   3         (pfi->File_Name)[temp]=(INT8)Upper2Low((pfi->File_Name)[temp]);
1728   3        }
1729   2        temp--;
1730   2       }
1731   1       if(((pFDI->LowerCase)&0x08)!=0) 
1732   1       {
1733   2        for(i=0;i<temp;i++)
1734   2        {
1735   3         (pfi->File_Name)[i]=(INT8)Upper2Low((pfi->File_Name)[i]);   
1736   3        }
1737   2       }
1738   1      
1739   1       temp=(StringLen(pfi->File_Name)-1); 
1740   1       if(CHK_ATTR_DIR(pFDI->Attributes)) //Èç¹ûÊÇÄ¿Â¼Ôò½«×îºóµÄ.È¥µô
1741   1       {
1742   2        (pfi->File_Name)[temp+1]='\0';
1743   2       }
1744   1       //==ÒÔÉÏÊÇ°´ÕÕLowerCase×Ö½Ú¶ÔÖ÷ÎÄ¼şÃûÓëÀ©Õ¹ÎÄ¼şÃû½øĞĞĞ¡Ğ´»¯
1745   1      
1746   1       pfi->File_Attr=pFDI->Attributes; //ÎÄ¼şÊôĞÔ
1747   1       pfi->File_StartClust=Bytes2Value(pFDI->LowClust,2)+Bytes2Value(pFDI->HighClust,2)*65536;
1748   1       pfi->File_Size=Bytes2Value(pFDI->FileSize,4);
1749   1        
1750   1       //½âÎöÎÄ¼ş´´½¨Ê±¼äÓëÈÕÆÚ
1751   1       temp=Bytes2Value(pFDI->CTime,2);
1752   1       pfi->File_CTime.sec=(UINT8)((temp&TIME_SEC_MARK)*2); temp>>=TIME_SEC_NBITS;  //´´½¨Ê±¼äµÄ2ÃëÎ»
1753   1       pfi->File_CTime.min=(UINT8)(temp&TIME_MIN_MARK);   temp>>=TIME_MIN_NBITS; //´´½¨Ê±¼äµÄ·ÖÎ»
1754   1       pfi->File_CTime.hour=(UINT8)(temp&TIME_HOUR_MARK); //´´½¨Ê±¼äµÄÊ±Î»
1755   1       pfi->File_CTime.sec+=(UINT8)((UINT16)(pFDI->CTime10ms)/100); //ÔÚÃëÉÏ¼ÓÉÏ10ºÁÃëÎ»
1756   1      
1757   1       temp=Bytes2Value(pFDI->CDate,2);
1758   1       pfi->File_CDate.day=(UINT8)(temp&DATE_DAY_MARK);     temp>>=DATE_DAY_NBITS;   //´´½¨ÈÕÆÚµÄÈÕÎ»
1759   1       pfi->File_CDate.month=(UINT8)(temp&DATE_MONTH_MARK); temp>>=DATE_MONTH_NBITS; //´´½¨ÈÕÆÚµÄÔÂÎ»
1760   1       pfi->File_CDate.year=(UINT16)((temp&DATE_YEAR_MARK)+DATE_YEAR_BASE); //´´½¨ÈÕÆÚµÄÄêÎ»£¨¼ÓÉÏÄê·İ»ùÊı£©
1761   1      
1762   1       //½âÎöÎÄ¼şĞŞ¸ÄÊ±¼äÓëÈÕÆÚ
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 30  

1763   1       //temp=Bytes2Value(pFDI->MTime,2);
1764   1       //pfi->File_MTime.sec=(UINT8)((temp&TIME_SEC_MARK)*2); temp>>=TIME_SEC_NBITS;  //´´½¨Ê±¼äµÄ2ÃëÎ»
1765   1       //pfi->File_MTime.min=(UINT8)(temp&TIME_MIN_MARK);   temp>>=TIME_MIN_NBITS; //´´½¨Ê±¼äµÄ·ÖÎ»
1766   1       //pfi->File_MTime.hour=(UINT8)(temp&TIME_HOUR_MARK); //´´½¨Ê±¼äµÄÊ±Î»
1767   1       //ÎÄ¼şµÄĞŞ¸ÄÊ±¼äÃ»ÓĞ10ºÁÃëÎ»£¬ËùÒÔËüÖ»ÄÜ±í´ïÅ¼ÊıÃë
1768   1      
1769   1       //temp=Bytes2Value(pFDI->MDate,2);
1770   1       //pfi->File_MDate.day=(UINT8)(temp&DATE_DAY_MARK);     temp>>=DATE_DAY_NBITS;   //´´½¨ÈÕÆÚµÄÈÕÎ»
1771   1       //pfi->File_MDate.month=(UINT8)(temp&DATE_MONTH_MARK); temp>>=DATE_MONTH_NBITS; //´´½¨ÈÕÆÚµÄÔÂÎ»
1772   1       //pfi->File_MDate.year=(UINT8)((temp&DATE_YEAR_MARK)+DATE_YEAR_BASE); //´´½¨ÈÕÆÚµÄÄêÎ»
1773   1      
1774   1       //½âÎöÎÄ¼ş·ÃÎÊÈÕÆÚ
1775   1       //temp=Bytes2Value(pFDI->ADate,2);
1776   1       //pfi->File_ADate.day=(UINT8)(temp&DATE_DAY_MARK);     temp>>=DATE_DAY_NBITS;   //´´½¨ÈÕÆÚµÄÈÕÎ»
1777   1       //pfi->File_ADate.month=(UINT8)(temp&DATE_MONTH_MARK); temp>>=DATE_MONTH_NBITS; //´´½¨ÈÕÆÚµÄÔÂÎ»
1778   1       //pfi->File_ADate.year=(UINT8)((temp&DATE_YEAR_MARK)+DATE_YEAR_BASE); //´´½¨ÈÕÆÚµÄÄêÎ»
1779   1      
1780   1       pfi->File_CurClust=pfi->File_StartClust;
1781   1       pfi->File_CurSec=(pfi->File_CurClust)?SOC(pfi->File_CurClust):0;
1782   1       pfi->File_CurPos=0;
1783   1       pfi->File_CurOffset=0;
1784   1       pfi->File_IsEOF=(UINT8)((pfi->File_StartClust)?BOOL_FALSE:BOOL_TRUE);
1785   1      
1786   1       return 0;
1787   1      }
1788          #endif
1789          
1790          /******************************************************************************************
1791           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûÊÇ·ñÊÇÍ¨ÅäÃû£¬Í¨ÅäÃûÖĞº¬ÓĞ*Óë?
1792           ĞÎ²Î£ºpfn:Ö¸ÏòÎÄ¼şÃûµÄÖ¸Õë
1793           ·µ»Ø£ºÔËĞĞ½á¹û ÊÇ»ò·ñ
1794           Ïê½â£ºznFATÊÇÖ§³ÖÍ¨ÅäÃûµÄ£¬¶ÔÓÚÍ¨ÅäÃûznFATÖĞÊÇ²»¶ÔÆä½øĞĞÎÄ¼şÃûºÏ·¨ĞÔ¼ì²éµÄ¡£ÇëÊ¹ÓÃÕß×ÔĞĞ
1795                 ×¢Òâ¡£
1796          ******************************************************************************************/
1797          #ifdef IS_WILDFILENAME
1798          UINT8 Is_WildFileName(INT8 *pfn)
1799          { 
1800   1       UINT8 i=0;
1801   1       while('\0'!=pfn[i])
1802   1       {
1803   2        if('*'==pfn[i] || '?'==pfn[i])
1804   2        {
1805   3         return 1;
1806   3        }
1807   2        i++;
1808   2       }
1809   1       return 0;
1810   1      }
1811          #endif
1812          
1813          /******************************************************************************************
1814           ¹¦ÄÜ£ºÔÚÒ»¸ö×Ö·û´®ÖĞ²éÕÒÒ»¸ö×Ó´®
1815           ĞÎ²Î£ºstr:×Ö·û´® substr:×Ó´® pos:´Ó×Ö·û´®µÄposÎ»ÖÃ¿ªÊ¼²éÕÒ×Ó´®
1816           ·µ»Ø£º×Ó´®ÔÚ×Ö·û´®ÖĞµÄ¿ªÊ¼Î»ÖÃ
1817           Ïê½â£º
1818          ******************************************************************************************/
1819          #ifdef FINDSUBSTR
1820          UINT8 FindSubStr(INT8 *str,INT8 *substr,UINT8 pos)
1821          {
1822   1       UINT8 i=pos,j=0,lens=(UINT8)StringLen(str),lent=(UINT8)StringLen(substr);
1823   1      
1824   1       while(i<lens && j<lent)
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 31  

1825   1       {
1826   2        if(str[i]==substr[j] || '?'==substr[j])
1827   2        {
1828   3         i++;
1829   3         j++;
1830   3        }
1831   2        else
1832   2        {
1833   3         i=(UINT8)(i-j+1);
1834   3         j=0;
1835   3        }
1836   2       }
1837   1       if(j==lent) return (UINT8)(i-lent); 
1838   1       else return (UINT8)0XFF;
1839   1      }
1840          #endif
1841          
1842          /*********************************************************************************************
1843           ¹¦ÄÜ£ºÎÄ¼şÃûÆ¥Åä£¬Ö§³Ö*Óë?Í¨Åä
1844           ĞÎ²Î£ºt:Ä£°åÎÄ¼şÃû£¬¼´Ê¹ÓÃÕßÊäÈëµÄÎÄ¼şÃû s:Ä¿±êÎÄ¼şÃû  ÀıÈçtÎªa*b.txt sÎªaxxb.txt£¬ËüÃÇÊÇÆ¥ÅäµÄ
1845                 ÔÙÈçtÎªa???x.t* sÎªaxyzx.txt£¬ËüÃÇÊÇÆ¥ÅäµÄ¡£
1846           ·µ»Ø£ºÔËĞĞ½á¹û ÊÇ»ò·ñ
1847           Ïê½â£ºÕâÒ»Æ¥ÅäËã·¨»ùÓÚ×Ó´®Æ¥Åä£¬²¢²»±£Ö¤Âú×ãÒ»ÇĞÇé¿ö¡£ÆäËã·¨Ç¿¶È²»¿ÉÓëDOSÉÏµÄÍ¨ÅäÏàÌá²¢ÂÛ¡£
1848          **********************************************************************************************/
1849          #ifdef SFN_MATCH
1850          UINT8 SFN_Match(INT8 *t,INT8 *s)
1851          {
1852   1       UINT8 i=0,j=0,lens=(UINT8)StringLen(s);
1853   1       UINT8 lent=(UINT8)StringLen(t);
1854   1       INT8 buf[20];
1855   1       UINT8 bufp=0;
1856   1      
1857   1       //======================================================
1858   1       
1859   1       while(j<lent && '*'!=t[j])
1860   1       {
1861   2        buf[bufp]=(INT8)Lower2Up(t[j]);
1862   2        bufp++;
1863   2        j++;
1864   2       }
1865   1      
1866   1       if('\0'==t[j] && (lent!=lens)) return ERR_FAIL;
1867   1      
1868   1       buf[bufp]='\0';
1869   1       
1870   1       if(FindSubStr(s,buf,0)!=0) return ERR_FAIL;
1871   1       i=bufp;
1872   1       
1873   1       while(1)
1874   1       {
1875   2        while(j<lent && '*'==t[j]) j++;
1876   2        if(j==lent) return ERR_SUCC;
1877   2        bufp=0;
1878   2      
1879   2        while(j<lent && '*'!=t[j])
1880   2        {
1881   3         buf[bufp]=(INT8)Lower2Up(t[j]);
1882   3         bufp++;
1883   3         j++;
1884   3        }
1885   2        buf[bufp]='\0';
1886   2        
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 32  

1887   2        if(j==lent)
1888   2        {
1889   3         if(FindSubStr(s,buf,i)!=(lens-bufp)) return ERR_FAIL;
1890   3         return ERR_SUCC;
1891   3        }
1892   2      
1893   2        i=FindSubStr(s,buf,i);
1894   2        if(0XFF==i) return ERR_FAIL;
1895   2        i+=bufp;
1896   2       }
1897   1      }
1898          #endif
1899          
1900          /*********************************************************************************************
1901           ¹¦ÄÜ£ºĞŞ¸ÄFAT±íµÄÄ³¸ö±íÏî
1902           ĞÎ²Î£ºcluster:ÒªĞŞ¸ÄµÄ´ØÏîºÅ next_cluster:ÒªÏò´ØÏîÖĞĞ´ÈëµÄÖµ 
1903           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»òÊ§°Ü
1904           Ïê½â£º´Ëº¯ÊıÊ¹clusterÁ´Ïònext_cluster Èç¹ûclusterÎª0»ò1Ôò·ÅÆú²Ù×÷£¬ÒòÎªÓĞĞ§µÄ´ØºÅÊÇ´Ó2¿ªÊ¼µÄ
1905          **********************************************************************************************/
1906          #ifdef MODIFY_FAT
1907          UINT8 Modify_FAT(UINT32 cluster,UINT32 next_cluster) //¹¹ÔìFAT´ØÁ´
1908          {
1909   1       UINT32 temp1=0,temp2=0;
1910   1      
1911   1       if(0==cluster || 1==cluster) return ERR_FAIL; //´ØÏî0Óë1ÊÇ²»ÄÜ¸ü¸ÄµÄ
1912   1      
1913   1       temp1=pInit_Args->FirstFATSector+(cluster*4/pInit_Args->BytesPerSector);
1914   1       temp2=((cluster*4)%pInit_Args->BytesPerSector);
1915   1      
1916   1       znFAT_Device_Read_Sector(temp1,znFAT_Buffer);
1917   1       znFAT_Buffer[temp2+0]=(UINT8)( next_cluster&0x000000ff)     ;
1918   1       znFAT_Buffer[temp2+1]=(UINT8)((next_cluster&0x0000ff00)>>8 );
1919   1       znFAT_Buffer[temp2+2]=(UINT8)((next_cluster&0x00ff0000)>>16);
1920   1       znFAT_Buffer[temp2+3]=(UINT8)((next_cluster&0xff000000)>>24);
1921   1       znFAT_Device_Write_Sector(temp1,znFAT_Buffer);
1922   1       
1923   1       znFAT_Device_Read_Sector(temp1+pInit_Args->FATsectors,znFAT_Buffer);
1924   1       znFAT_Buffer[temp2+0]=(UINT8)( next_cluster&0x000000ff)     ;
1925   1       znFAT_Buffer[temp2+1]=(UINT8)((next_cluster&0x0000ff00)>>8 );
1926   1       znFAT_Buffer[temp2+2]=(UINT8)((next_cluster&0x00ff0000)>>16);
1927   1       znFAT_Buffer[temp2+3]=(UINT8)((next_cluster&0xff000000)>>24);
1928   1       znFAT_Device_Write_Sector(temp1+pInit_Args->FATsectors,znFAT_Buffer);
1929   1      
1930   1       return ERR_SUCC;
1931   1      }
1932          #endif
1933          
1934          /********************************************************************************************
1935           ¹¦ÄÜ£º¶Ôcluster´Ø½øĞĞÇå0
1936           ĞÎ²Î£ºcluster:Òª½øĞĞÇå0²Ù×÷µÄ´Ø
1937           ·µ»Ø£º0
1938           Ïê½â£ºÔÚÄ³¸öÄ¿Â¼ÏÂ´´½¨ÎÄ¼ş»òÄ¿Â¼Ê±£¬´ËÄ¿Â¼µÄÏÖÓĞ´ØÒÑÎŞ¿ÕÏĞ¿Õ¼äÀ´Ğ´ÈëÎÄ¼şÄ¿Â¼ÏîÊ±£¬ĞèÒªÀ©Õ¹¿Õ
1939                 ´Ø£¬¼´½«¿Õ´ØÁ´µ½Ä¿Â¼µÄ´ØÁ´ÉÏ£¬½ø¶ø¼ÌĞøĞ´ÈëÎÄ¼şÄ¿Â¼Ïî£¬À´Íê³ÉÎÄ¼ş»òÄ¿Â¼µÄ´´½¨¡£ÔÚÏò¿Õ´Ø
1940                 Ğ´ÈëÎÄ¼şÄ¿Â¼ÏîÒÔÇ°±ØĞë°ÑÕâ¸ö¿Õ´ØÇå¿ÕÎª0¡£ÒòÎªÏòÄ¿Â¼µÄ´ØÖĞĞ´ÈëÎÄ¼şÄ¿Â¼Ïî£¬ÊÇÒÔ0À´ÅĞ¶ÏÊÇ
1941                 ·ñÓĞ¿ÕÏĞµÄÎ»ÖÃ¡£
1942          ********************************************************************************************/
1943          #ifdef CLEAR_CLUSTER
1944          UINT8 Clear_Cluster(UINT32 cluster)
1945          {
1946   1       znFAT_Device_Clear_nSector((pInit_Args->SectorsPerClust),SOC(cluster));
1947   1      
1948   1       return 0;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 33  

1949   1      }
1950          #endif
1951          
1952          /********************************************************************************************
1953           ¹¦ÄÜ£º¸üĞÂÏÂÒ»¿Õ´Ø²Î¿¼Öµ ¼´znFATÖĞÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏÖĞµÄNext_Free_Cluster
1954           ĞÎ²Î£ºÎŞ
1955           ·µ»Ø£ºÔËĞĞ½á¹û 
1956           Ïê½â£ºÔÚÃ¿´ÎĞèÒªÊ¹ÓÃ¿Õ´ØµÄÊ±ºò£¬ÎÒÃÇ¶¼¿ÉÒÔÖ±½ÓÈ¥È¡pInit_Args->Next_Free_Cluster£¬µ«ÊÇÓÃÍêÖ®
1957                 Òª¼°Ê±¸üĞÂÆäÖµ£¬ÒÔÎªÏÂÒ»´ÎÊ¹ÓÃ¿Õ´Ø×÷ºÃ×¼±¸¡£
1958          ********************************************************************************************/
1959          #ifdef UPDATE_NEXT_FREE_CLUSTER
1960          UINT8 Update_Next_Free_Cluster(void)
1961          {
1962   1       UINT32 clu_sec,iItem,iSec;
1963   1       struct FAT_Sec *pFAT_Sec;
1964   1      
1965   1       if(0!=pInit_Args->Free_nCluster) //´ÅÅÌÈÔÓĞ¿Õ¼ä
1966   1       {
1967   2        pInit_Args->Free_nCluster--; //¿ÕÏĞ´ØÊı¼õ1
1968   2      
1969   2        clu_sec=(pInit_Args->Next_Free_Cluster/NITEMSINFATSEC); //Ö¸¶¨´ØµÄ´ØÏîËùÔÚµÄÉÈÇøÎªÆäFATÇøÄÚµÄÆ«ÒÆÁ¿     
             -                                                                            //FATµÄÊ×ÉÈÇø                               
             -                          
1970   2        znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer); //½«´ØÏîËùÔÚµÄÉÈÇøÊı¾İ¶ÁÈë»
             -º³åÇø
1971   2        pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer; //½«Êı¾İ»º³åÇøÊ×µØÖ·Ç¿×ªÎªFAT_Sec½á¹¹ÌåµÄÖ¸ÕëÀàĞÍ
1972   2      
1973   2        for(iItem=((pInit_Args->Next_Free_Cluster)%NITEMSINFATSEC)+1;iItem<NITEMSINFATSEC;iItem++) //¼ì²âÔÚµ±Ç°F
             -ATÉÈÇøÄÚµ±Ç°´ØÏîÖ®ºóÊÇ·ñÓĞ¿Õ´Ø
1974   2        {
1975   3         if(0==(((pFAT_Sec->items)[iItem]).Item)[0]
1976   3         && 0==(((pFAT_Sec->items)[iItem]).Item)[1]
1977   3         && 0==(((pFAT_Sec->items)[iItem]).Item)[2]
1978   3         && 0==(((pFAT_Sec->items)[iItem]).Item)[3])
1979   3         {
1980   4          pInit_Args->Next_Free_Cluster=(clu_sec*NITEMSINFATSEC)+iItem;
1981   4          #ifdef RT_UPDATE_FSINFO
1982   4          Update_FSINFO();
1983   4          #endif
1984   4        return ERR_SUCC;
1985   4         }
1986   3        }
1987   2      
1988   2        for(iSec=(clu_sec+1);iSec<(pInit_Args->FATsectors);iSec++) //ÔÚºóÃæµÄFATÉÈÇøÖĞ¼ÌĞø²éÕÒ
1989   2        {
1990   3         znFAT_Device_Read_Sector(iSec+(pInit_Args->FirstFATSector),znFAT_Buffer);
1991   3         pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer;
1992   3         for(iItem=0;iItem<NITEMSINFATSEC;iItem++) //¼ì²âÔÚµ±Ç°FATÉÈÇøÄÚµ±Ç°´ØÏîÖ®ºóÊÇ·ñÓĞ¿Õ´Ø
1993   3         {
1994   4          if(0==(((pFAT_Sec->items)[iItem]).Item)[0]
1995   4          && 0==(((pFAT_Sec->items)[iItem]).Item)[1]
1996   4          && 0==(((pFAT_Sec->items)[iItem]).Item)[2]
1997   4          && 0==(((pFAT_Sec->items)[iItem]).Item)[3])
1998   4          {
1999   5           pInit_Args->Next_Free_Cluster=(iSec*NITEMSINFATSEC)+iItem;
2000   5           #ifdef RT_UPDATE_FSINFO
2001   5           Update_FSINFO();
2002   5           #endif
2003   5         return ERR_SUCC;
2004   5          }
2005   4         }
2006   3        }
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 34  

2007   2       }
2008   1       pInit_Args->Next_Free_Cluster=2; //Èç¹ûÒÑÎŞ¿Õ¼ä£¬¼´nFreeClusterÎª0£¬Ôò½«ÏÂÒ»¿Õ´ØÉèÎª2
2009   1                                        //WINDOWS¾ÍÊÇÕâÑù×÷µÄ
2010   1       return ERR_NO_SPACE;
2011   1      }
2012          #endif
2013          
2014          //=================for LFN=====ÒÔÏÂ´úÂëÓÃÓÚÊµÏÖ³¤ÎÄ¼şÃû===ÒªÊ¹ÓÃ³¤Ãû¹¦ÄÜ ĞèÒª¶ÔUSE_LFNÕâ¸öºê½øĞĞ¶¨Òå===
2015          
2016          /********************************************************************************************
2017           ¹¦ÄÜ£ºÅĞ¶ÏÒ»¸öÎÄ¼şÃûÊÇ·ñÊÇ³¤ÎÄ¼şÃû
2018           ĞÎ²Î£ºfilename:Ö¸ÏòÎÄ¼şÃûµÄÖ¸Õë
2019           ·µ»Ø£ºÔËĞĞ½á¹û£¬ÊÇ»ò·ñ
2020           Ïê½â£ºÅĞ¶ÏÒ»¸öÎÄ¼şÃûÊÇ·ñ³¤ÎÄ¼şÃû£¬·Ç³£ÖØÒª¡£FAT32ÖĞ¶Ô³¤ÃûµÄ¶¨Òå±È½ÏÁãËé¶ø¸´ÔÓ£¬Ò»Ğ©¿´ËÆ¶ÌÃû
2021                 µÄÎÄ¼şÃûÊµÎª³¤Ãû¡£ÕâÀïÖ»Ê¹ÓÃ³¤ÃûÅĞ¶ÏµÄÖ÷ÒªÌõ¼ş£¬½¨ÒéÔÚÊ¹ÓÃ³¤ÃûÊ±£¬Ê¹ÓÃÕßÒÔÃ÷È·µÄĞÎÊ½
2022                 ¸ø³ö³¤Ãû¡£
2023          ********************************************************************************************/
2024          #ifdef IS_LFN
              UINT8 Is_LFN(INT8 *filename)
              {
               UINT8 is_lfn=BOOL_FALSE;
              
               if(Check_SFN_Illegal_Length(filename)) is_lfn=BOOL_TRUE;
               if(Check_SFN_Dot(filename))            is_lfn=BOOL_TRUE;
               if(Check_SFN_Special_Char(filename))   is_lfn=BOOL_TRUE;
               if(((UINT8)(-1))==Check_SFN_Illegal_Lower(filename)) is_lfn=BOOL_TRUE;
              
               return is_lfn;
              }
              #endif
2037          
2038          /***********************************************************************************************
2039           ¹¦ÄÜ£º´Ó³¤ÃûÏîÖĞÌáÈ¡ÆäÖĞËùº¬µÄ²¿·Ö³¤ÃûµÄUNIÂë£¬´Ëº¯ÊıÍ¨¹ı¶à´Îµ÷ÓÃ£¬ÊµÏÖÁË¶ÔÕû¸ö³¤ÃûUNIÂëµÄÆ´½Ó
2040           ĞÎ²Î£ºlfn_buf:Ö¸ÏòÓÃÓÚ×°ÔØ³¤ÃûUNIÂëµÄ»º³åÇø plfndi:Ö¸Ïò³¤ÃûÏîµÄÖ¸Õë n:ËµÃ÷ÕâÊÇ³¤ÃûµÄµÚn²¿·Ö
2041           ·µ»Ø£ºÔËĞĞ½á¹û
2042           Ïê½â£ºFAT32ÖĞµÄ³¤ÃûÊÇÓÉ¶à¸ö³¤ÃûÏî¹²Í¬±í´ïµÄ£¬Ã¿¸ö³¤ÃûÏî¼ÇÂ¼×Å³¤ÃûµÄÄ³Ò»¶Î£¬´Ëº¯Êı¾ÍÊÇ½«³¤ÃûÏîÖĞ
2043                 µÄ³¤ÃûUNIÂëÌáÈ¡³öÀ´£¬·Åµ½»º³åÇøµÄÏàÓ¦Î»ÖÃÉÏ¡£¾­¹ı¶à´Îµ÷ÓÃ´Ëº¯Êı£¬×îÖÕ¿ÉÒÔÆ´½ÓµÃµ½³¤Ãû¡£
2044          ************************************************************************************************/
2045          #ifdef GET_PART_NAME
              UINT8 Get_Part_Name(UINT16 *lfn_buf,struct LFN_FDI *plfndi,UINT8 n)
              {
               UINT8 i=0;
               UINT16 temp=0;
              
               if((plfndi->AttrByte[0])&0X40) Memory_Set(((UINT8 *)lfn_buf),2*(MAX_LFN_LEN+1),0); //Èç¹ûÊÇ×îºóÒ»¸ö³¤ÃûÏî
             -£¬ÔòÇå¿Õlfn_buf
              
               for(i=0;i<5;i++) //µÚÒ»²¿·Ö³¤Ãû
               {
                if(n>=MAX_LFN_LEN) return ERR_LFN_BUF_OUT;
                temp=(((UINT16)(((plfndi->Name1)+i*2)[0]))&0X00FF)|((((UINT16)(((plfndi->Name1)+i*2)[1]))&0X00FF)<<8);
                if(0==temp)
                {
                 lfn_buf[n]=0;
                 return 0;
                }
                else
                {
                 lfn_buf[n]=temp;n++;
                }
               }
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 35  

               for(i=0;i<6;i++) //µÚ¶ş²¿·Ö³¤Ãû
               {
                if(n>=MAX_LFN_LEN) return ERR_LFN_BUF_OUT;  
                temp=(((UINT16)(((plfndi->Name2)+i*2)[0]))&0X00FF)|((((UINT16)(((plfndi->Name2)+i*2)[1]))&0X00FF)<<8);
                if(0==temp)
                {
                 lfn_buf[n]=0;
                 return 0;
                }
                else
                {
                 lfn_buf[n]=temp;n++;
                }
               }
              
               for(i=0;i<2;i++) //µÚÈı²¿·Ö³¤Ãû
               {
                if(n>=MAX_LFN_LEN) return ERR_LFN_BUF_OUT;  
                temp=(((UINT16)(((plfndi->Name3)+i*2)[0]))&0X00FF)|((((UINT16)(((plfndi->Name3)+i*2)[1]))&0X00FF)<<8);
                if(0==temp)
                {
                 lfn_buf[n]=0;
                 return 0;
                }
                else
                {
                 lfn_buf[n]=temp;n++;
                }
               }
              
               n--;
               if((plfndi->AttrByte[0])&0X40)
               {
                while(((UINT16)(0XFFFF))==lfn_buf[n]) n--;
                lfn_buf[n+1]=0;
               }
              
               return 0;
              }
              #endif
2108          
2109          /***********************************************************************************************
2110           ¹¦ÄÜ£º½«OEMÂë£¨¶ÔÓÚºº×ÖÀ´Ëµ£¬OEMÂë¾ÍÊÇGB2312£©×ªÎªUNICODEÂë
2111           ĞÎ²Î£ºoem_code:OEMÂë uni_code:Ö¸ÏòÓÃÓÚ¼ÇÂ¼oem_codeËù¶ÔÓ¦µÄUNICODE±àÂëµÄ±äÁ¿µÄÖ¸Õë
2112           ·µ»Ø£ºÔËĞĞ½á¹û  ³É¹¦»òÊ§°Ü
2113           Ïê½â£ºOEMÂëÊÇ¸÷µØÇøµÄ¼ÆËã»úÉú²úÉÌÔÚ¼ÆËã»ú¹Ì»¯µÄ±¾µØÎÄ×Ö±àÂë£¬±ÈÈçÔÚÖĞ¹úOEMÂë¾ÍÊÇGB2312Âë£¬¼´Çø
2114                 Î»Âë£¬µ«ÊÇFAT32µÄ³¤ÎÄ¼şÃûÊÇÒÔUNICODEÀ´±àÂëµÄ£¬Òò´ËĞèÒªÒ»¸ö±àÂë×ª»»µÄ¹ı³Ì¡£±¾º¯ÊıµÄÊµÏÖ»ùÓÚ
2115                 ¶ş·ÖËÑË÷£¬¿É¿ìËÙ²éÕÒµ½OEMÂë¶ÔÓ¦µÄUNICODE±àÂë¡£
2116          ************************************************************************************************/
2117          #ifdef OEMTOUNI
              UINT8 OEM2UNI(UINT16 oem_code,UINT16 *uni_code) //Í¨¹ı¶ş·Ö·¨²é±í½«OEMÂë×ªÎªUNIÂë
              {  
               UINT32 low=0,high=MAX_UNI_INDEX-1,mid;//ÖÃµ±Ç°²éÕÒÇø¼äÉÏÏÂ½çµÄ³õÖµ 
               
               if(oem_code<GET_PGM_WORD(&(oem_uni[0][1]))) return ERR_FAIL;
               if(oem_code>GET_PGM_WORD(&(oem_uni[MAX_UNI_INDEX-1][1]))) return ERR_FAIL; //Èç¹ûÊäÈëµÄoem_code²»ÊÇ±íµÄ·¶
             -Î§ÄÚ£¬ÔòÖ±½Ó·µ»Ø
              
               while(low<=high) //µ±Ç°²éÕÒÇø¼ä[low..high]·Ç¿Õ
               {
                mid=low+(high-low)/2;
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 36  

                if(oem_code==GET_PGM_WORD(&(oem_uni[mid][1])))
                {
                 *uni_code=GET_PGM_WORD(&(oem_uni[mid][0]));
              
                 return ERR_SUCC; //²éÕÒ³É¹¦·µ»Ø
                }
              
                if(GET_PGM_WORD(&(oem_uni[mid][1]))>oem_code)
                {
                 high=mid-1;  //¼ÌĞøÔÚ[low..mid-1]ÖĞ²éÕÒ
                }
                else
                {
                 low=mid+1; //¼ÌĞøÔÚ[mid+1..high]ÖĞ²éÕÒ
                }
               }                      
              
               return ERR_FAIL; //µ±low>highÊ±±íÊ¾²éÕÒÇø¼äÎª¿Õ£¬²éÕÒÊ§°Ü
              }
              #endif
2149          
2150          /***********************************************************************************************
2151           ¹¦ÄÜ£º½«OEM±àÂëµÄ×Ö·û´®×ªÎªÓÉUNICODE±àÂëµÄ×Ö·û´®
2152           ĞÎ²Î£ºoemstr:Ö¸Ïòoem±àÂëµÄ×Ö·û´®  unistr:Ö¸ÏòUNICODE±àÂëµÄ×Ö·û´®
2153           ·µ»Ø£ºÔËĞĞ½á¹û  ³É¹¦ ×Ö·û¼¯²»ÍêÕû »ò ³¤Ãû»º³åÒç³ö
2154           Ïê½â£ºÒıÈë³¤ÎÄ¼şÃûÖ®ºó£¬Éæ¼°µ½³¤ÎÄ¼şÃûµÄ±È¶ÔºÍÆ¥Åä£¬Òò´Ë±ØÈ»Òª½«oem±àÂëµÄ×Ö·û´®×ªÎªUNICODE±àÂë
2155                 µÄ×Ö·û´®£¬ÒÔ±ãÓëÓÉ³¤ÃûÏîÖĞÌáÈ¡Æ´½Ó¶ø³ÉµÄUNICODE×Ö·û´®½øĞĞ±È¶Ô¡£
2156          ************************************************************************************************/
2157          #ifdef OEMSTRTOUNISTR
              UINT8 oemstr2unistr(INT8 *oemstr,UINT16 *unistr)
              {
               UINT32 len=StringLen(oemstr);
               UINT32 i=0,pos=0;
               UINT8 res=0;
               UINT16 temp=0;
              
               for(i=0;i<len;i++)
               {
                if(IS_ASC(oemstr[i])) //¼ì²éÊÇ·ñÊÇASCIIÂë£¬ASCIIÂëµÄÊıÖµ·¶Î§Îª0X00~0X7F£¬OEM±àÂëÖµ²»ÔÚ´Ë·¶Î§£¬ÒÔ´ËÇø·ÖÊÇ
             -ASCII»¹ÊÇOEM
                {
                 unistr[pos]=(UINT16)(((UINT16)oemstr[i])&0X00FF);
                 pos++;
                }
                #ifdef USE_OEM_CHAR
                else //²»ÊÇASCIIÂë£¬¶øÊÇOEM±àÂë
                {
                 temp=((((UINT16)oemstr[i])<<8)&0xff00);
                 temp|=(((UINT16)oemstr[i+1])&0x00ff);
                 res=OEM2UNI(temp,unistr+pos);
                 if(res) 
                 {
                  unistr[0]=0;
                  return ERR_OEM_CHAR_NOT_COMPLETE;
                 }
                 pos++;i++;
                }
                #endif
              
                if(pos>MAX_LFN_LEN) 
                {
                 unistr[0]=0;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 37  

                 return ERR_LFN_BUF_OUT; 
                }
               }
              
               unistr[pos]=0;
              
               return ERR_SUCC;
              }
              #endif
2199          
2200          /***********************************************************************************************
2201           ¹¦ÄÜ£º¶Ô¿í×Ö·û´®£¨¼´Ã¿¸ö×Ö·û¾ùÕ¼ÓÃÁ½¸ö×Ö½Ú£¬ÈçUNICODE£©½øĞĞ×Ó´®²éÕÒ
2202           ĞÎ²Î£ºstr:Ö¸Ïò¿í×Ö·û´®µÄÖ¸Õë  substr:Ö¸Ïò×Ó´®µÄÖ¸Õë  pos:Òª²éÕÒµÄÆğÊ¼Î»ÖÃ
2203           ·µ»Ø£º×Ó´®ÔÚ¿í×Ö·û´®ÖĞµÄÆğÊ¼Î»ÖÃ£¬Èç¹ûÎ´ÕÒµ½£¬Ôò·µ»Ø-1
2204           Ïê½â£º´Ëº¯Êı»ù±¾ÓëÇ°ÃæSFNµÄÆ¥ÅäÖĞµÄ²éÕÒ×Ó´®µÄº¯ÊıÍ¬Àí£¬Ö»²»¹ı×Ö·û´®±»À©Õ¹ÎªÁË¿í×Ö·û´®
2205          ************************************************************************************************/
2206          #ifdef WFINDSUBSTR
              UINT32 WFindSubStr(UINT16 *str,UINT16 *substr,UINT32 pos)
              {
               UINT32 i=pos,j=0,lens=WStringLen(str),lent=WStringLen(substr);
              
               while(i<lens && j<lent)
               {
                if(WLower2Up(str[i])==substr[j] || (UINT16)'?'==substr[j])
                {
                 i++;
                 j++;
                }
                else
                {
                 i=i-j+1;
                 j=0;
                }
               }
              
               if(j==lent) return i-lent; 
               else return (UINT32)-1;
              }
              #endif
2229          
2230          /***********************************************************************************************
2231           ¹¦ÄÜ£º¶ÔÁ½¸ö¿í×Ö·û´®½øĞĞÆ¥Åä£¬ÊµÎª³¤ÎÄ¼şÃûµÄÍ¨Åä±È¶Ô
2232           ĞÎ²Î£ºt:Ö¸ÏòÄ£°æ¿í×Ö·û´®µÄÖ¸Õë  s:Ö¸Ä¿±ê×Ö·û´®µÄÖ¸Õë  Àıt:ÕñÄÏ*ÎŞÏŞ.txt s:ÕñÄÏµç×ÓÔ­´´ÎŞÏŞ.txt
2233                 ËüÃÇÊÇÆ¥ÅäµÄ¡£
2234           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»òÊ§°Ü
2235           Ïê½â£º´Ëº¯Êı»ù±¾ÓëÇ°ÃæSFNµÄÆ¥Åäº¯ÊıSFN_MatchÍ¬Àí¡£
2236          ************************************************************************************************/
2237          #ifdef LFN_MATCH
              UINT8 LFN_Match(UINT16 *t,UINT16 *s)
              {
               UINT32 i=0,j=0,lens=WStringLen(s),lent=WStringLen(t);
               UINT16 bufp=0;
              
               UINT16 buf[MAX_LFN_LEN+1];
              
               //======================================================
               
               while(j<lent && (UINT16)'*'!=t[j])
               {
                buf[bufp]=WLower2Up(t[j]);
                bufp++;
                j++;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 38  

               }
              
               if(0==t[j] && (lent!=lens)) return ERR_FAIL;
              
               buf[bufp]=0;
               
               if(WFindSubStr(s,buf,0)!=0) return ERR_FAIL;
               i=bufp;
               
               while(1)
               {
                while(j<lent && (UINT16)'*'==t[j]) j++;
                if(j==lent) return ERR_SUCC;
                bufp=0;
              
                while(j<lent && (UINT16)'*'!=t[j])
                {
                 buf[bufp]=(UINT16)WLower2Up(t[j]);
                 bufp++;
                 j++;
                }
                buf[bufp]=0;
                
                if(j==lent)
                {
                 if(WFindSubStr(s,buf,i)!=(lens-bufp)) return ERR_FAIL;
                 return 0;
                }
              
                i=WFindSubStr(s,buf,i);
                if(((UINT32)(-1))==i) return ERR_FAIL;
                i+=bufp;
               }
              }
              #endif
2287          
2288          /***********************************************************************************************
2289           ¹¦ÄÜ£º´Ó¶ÌÃûÎÄ¼şÄ¿Â¼ÏîÖĞ»ñÈ¡°ó¶¨Ğ£ÑéºÍ
2290           ĞÎ²Î£ºpdi:Ö¸Ïò¶ÌÃûÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë 
2291           ·µ»Ø£º°ó¶¨Ğ£ÑéºÍµÄÖµ
2292           Ïê½â£º´Ëº¯ÊıËùÊ¹ÓÃµÄĞ£ÑéËã·¨À´×ÔÓÚÎ¢ÈíµÄFAT32Ïà¹ØÎÄµµ¡£Ò»¸öÎÄ¼şµÄÎÄ¼şÃûÈç¹ûÎª³¤ÎÄ¼şÃû£¬ÔòËü½«ÓĞ
2293                 Èô¸É¸ö³¤ÃûÏîÀ´¹²Í¬±í´ï³¤Ãû£¬Í¬Ê±»¹ÓĞÓëÖ®¶ÔÓ¦µÄ¶ÌÃûÏî¡£±ÈÈç ABCDEFGHI.RMVB ÓĞ2¸ö³¤ÃûÏî£¨Ã¿
2294                 ¸ö³¤ÃûÏî¿É¼ÇÂ¼13¸öUNICODEÂë£©£¬ÓëÖ®¶ÔÓ¦µÄ¶ÌÃû¿ÉÄÜÎªABCDEF~1.RMV¡£Í¨³£Çé¿öÏÂ£¬¶ÌÃû½ô½ô¸úÔÚ
2295                 ³¤ÃûÏîºóÃæ£¬µ«ËüÃÇÖ®¼ä²¢²»¹â¿¿Î»ÖÃ¹ØÏµÀ´±£Ö¤ÆäÁªÏµ£¬»¹ÓĞÒ»ÖÖ°ó¶¨Ğ£ÑéºÍËã·¨£ºÍ¨¹ı¶ÌÃû¿ÉÒÔ
2296                 ¼ÆËãµÃµ½Ò»¸öÖµ£¬³¤ÃûÏîÖĞÓĞ×¨ÃÅµÄ×Ö¶ÎÒ²¼ÇÂ¼ÁËÕâ¸öÖµ£¬Èç¹ûÕâÁ½¸öÖµÏàµÈ£¬ÔòÈÏÎª³¤ÃûÏîÓë¶ÌÃû
2297                 ÏîÊÇÓĞ¹ØÁªµÄ£¬Åä¶Ô³É¹¦¡£
2298          ************************************************************************************************/
2299          #ifdef GET_BINDING_SUMCHK
              UINT8 Get_Binding_SumChk(struct FDI *pdi)
              {
               UINT8 i=0,c=0;
              
               for(i=0;i<11;i++)
               {
                c=(UINT8)(((c&0X01)?0X80:0)+(c>>1)+((pdi->Name)[i]));
               }
              
               return c;
              }
              #endif
2312          
2313          /***********************************************************************************************
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 39  

2314           ¹¦ÄÜ£ºELF¹şÏ£Ëã·¨£¬ÓÃÓÚÓÉÒ»¸ö×Ö·û´®¼ÆËãµÃµ½Ò»¸öÖµ£¬Õâ¸öÖµÓë×Ö·û´®ÊÇÎ¨Ò»¶ÔÓ¦µÄ
2315           ĞÎ²Î£ºstr:Ö¸Ïò×Ö·û´®µÄÖ¸Õë
2316           ·µ»Ø£º¼ÆËãµÃµ½µÄ¹şÏ£Öµ
2317           Ïê½â£ºÔÚ´´½¨ÎÄ¼şºÍÄ¿Â¼Ê±£¬Èç¹ûÊÇ³¤Ãû£¬ÔÚÏòÄ¿Â¼´ØÖĞĞ´Èë³¤ÃûÏîµÄÍ¬Ê±£¬Ò²ÒªĞ´ÈëÆä¶ÔÓ¦µÄ¶ÌÃûÏî£¬¶ø
2318                 ¶ÌÃûÈçºÎÈ·¶¨£¨FAT32ÖĞÊ¹ÓÃ¼ÓÊı×Öºó×ºµÄ·½·¨£¬ÈçXXXXXX~n.YYY£¬µ«n<=5£¬n>5µÄÊ±ºò¾ÍĞèÒªÒ»ÖÖËã
2319                 ·¨ÓÉ³¤ÃûÖ±½Ó¼ÆËãµÃµ½Ò»¸öÎ¨Ò»ÓëÖ®¶ÔÓ¦µÄ¶ÌÎÄ¼şÃû£¬´ËËã·¨¼´¿ÉÓÉHASHËã·¨À´ÊµÏÖ£©¡£ELF¹şÏ£ÊÇ
2320                 ÖÚ¶à¹şÏ£Ëã·¨ÖĞÓÃµÃ±È½Ï¹ã·ºµÄ£¬Ëü¸ßĞ§¶øÇÒ±£Ö¤ÁË¹şÏ£ÖµÓë×Ö·û´®µÄÎ¨Ò»¶ÔÓ¦£¨²»Í¬µÄ×Ö·û´®ÓµÓĞ
2321                 ÏàÍ¬µÄ¹şÏ£ÖµµÄ¸ÅÂÊÊÇ¼«Ğ¡µÄ£©¡£»ùÓÚÕâ¸öÎ¨Ò»µÄ¹şÏ£ÖµÎÒÃÇ¿ÉÒÔ¿ìËÙ¹¹Ôì³ö³¤Ãû¶ÔÓ¦µÄ¶ÌÃû¡£
2322          ************************************************************************************************/
2323          #ifdef  ELFHASH
              UINT32 ELFHash(INT8 *str)
              {
               UINT32 hash=0;
               UINT32 x=0;
              
               while(*str)
               {
                hash=(hash<<4)+(*str++); //hash×óÒÆ4Î»£¬µ±Ç°×Ö·ûASCII´æÈëhashµÍËÄÎ»¡£ 
                x=hash&0xF0000000;
                if(0!=x)
                { //Èç¹û×î¸ßµÄËÄÎ»²»Îª0£¬ÔòËµÃ÷×Ö·û¶àÓà7¸ö£¬Èç¹û²»´¦Àí£¬ÔÙ¼ÓµÚ¾Å¸ö×Ö·ûÊ±£¬µÚÒ»¸ö×Ö·û»á±»ÒÆ³ö£¬Òò´ËÒªÓĞÈç
             -ÏÂ´¦Àí¡£
                  //¸Ã´¦Àí£¬Èç¹û¶ÔÓÚ×Ö·û´®(a-z »òÕßA-Z)¾Í»á½ö½öÓ°Ïì5-8Î»£¬·ñÔò»áÓ°Ïì5-31Î»£¬ÒòÎªCÓïÑÔÊ¹ÓÃµÄËãÊıÒÆÎ»
                 hash ^= (x >> 24);
                 //Çå¿Õ28-31Î»¡£
                 hash &= ~x;
                }
               }
              
               //·µ»ØÒ»¸ö·ûºÅÎ»Îª0µÄÊı£¬¼´¶ªÆú×î¸ßÎ»£¬ÒÔÃâº¯ÊıÍâ²úÉúÓ°Ïì¡£(ÎÒÃÇ¿ÉÒÔ¿¼ÂÇ£¬Èç¹ûÖ»ÓĞ×Ö·û£¬·ûºÅÎ»²»¿ÉÄÜÎª¸º)
               return (hash&0X7FFFFFFF);
              }
              #endif
2346          
2347          /***********************************************************************************************
2348           ¹¦ÄÜ£º½«Ò»¸ö32Î»µÄÕûĞÎÖµ×ªÎª16½øÖÆ×Ö·û´® Àı£º0X12345678×ªÎª"12345678"
2349           ĞÎ²Î£ºhex:Ò»¸ö32Î»µÄÕûĞÎÊı str:Ö¸Ïò×Ö·û´®µÄÖ¸Õë
2350           ·µ»Ø£º0
2351           Ïê½â£º´Ëº¯ÊıÓÃÓÚ½«ÉÏÃæµÄ¹şÏ£º¯Êı¼ÆËãµÃµ½µÄ32Î»µÄ¹şÏ£Öµ×ªÎª×Ö·û´®£¬ÒÔ±ã½øĞĞ¶ÌÎÄ¼şÃûµÄ¹¹Ôì¡£
2352          ************************************************************************************************/
2353          #ifdef HEX2STR_32B
              UINT8 Hex2Str_32b(UINT32 hex,INT8 *str)
              {
               UINT8 i=0,temp=0;
               for(i=0;i<8;i++)
               {
                temp=((unsigned char)((hex&(0X0000000F<<(i*4)))>>(i*4)));
                str[7-i]=(INT8)((temp>=10)?('A'+temp-10):(temp+0X30));  
               }
               str[i]=0;
               
               return 0;
              }
              #endif
2367          
2368          /***********************************************
2369           ¹¦ÄÜ£ºÓÉ³¤Ãû¹¹ÔìÆä¶ÔÓ¦µÄ¶ÌÃû
2370           ĞÎ²Î£ºpfn:Ö¸ÕëÏò³¤ÃûµÄÖ¸Õë psfn:Ö¸Ïò¶ÌÃûµÄÖ¸Õë
2371           ·µ»Ø£º0
2372           Ïê½â£º´Ëº¯Êı»¹ĞèÒª½øÒ»²½ĞŞ¸Ä£¬µ«Ôİ¿ÉÓÃ¡£
2373          ************************************************/
2374          #ifdef MAKE_SHORT_NAME
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 40  

              UINT8 Make_Short_Name(char *pfn,char *psfn) //´Ëº¯ÊıÓÃÓÚÉú³É³¤Ãû¶ÔÓ¦µÄ¶ÌÃû£¬Ê¹ÓÃÁËELFHASHËã·¨ÓÃÓÚÉú³ÉÎ¨Ò»µ
             -Ä¶ÌÃû
              {
               //psfn[0]=Lower2Up(pfn[0]);
               //psfn[1]='~';
               UINT32 temp=ELFHash(pfn);
               Hex2Str_32b(temp,psfn);
               //psfn[0]='*';
               psfn[8]='.';
               psfn[9]=psfn[10]=psfn[11]='A';
               psfn[12]=0;
              
               return 0;
              }
              #endif
2389          
2390          /******************************************************************************
2391           ¹¦ÄÜ£º¹¹ÔìµÚn¸ö³¤ÃûÏî
2392           ĞÎ²Î£ºunifn:Ö¸ÏòUNICODE±àÂëµÄ³¤ÎÄ¼şÃû plfni:Ö¸ÏòÓÃÓÚ´æ´¢¹¹ÔìµÄ³¤ÃûÏîµÄ±äÁ¿Ö¸Õë 
2393                 ChkSum:ÓÉ¶ÌÃûÏî¼ÆËãµÃµ½µÄ°ó¶¨Ğ£ÑéºÍ n:Ö¸Ê¾ÊÇµÚ¼¸¸ö³¤ÃûÏî
2394           ·µ»Ø£º0
2395           Ïê½â£º¹¹Ôì³¤ÃûÏîÊÇznFATÖĞÊµÏÖ³¤ÎÄ¼şÃûµÄÒ»¸ö¹Ø¼ü¹¦ÄÜº¯Êı
2396          *******************************************************************************/
2397          #ifdef FILL_LFN_FDI
              UINT8 Fill_LFN_FDI(UINT16 *unifn,struct LFN_FDI *plfni,UINT8 ChkSum,UINT8 n)
              {
               UINT8 temp=(UINT8)(n*13),i=0,j=0;
               UINT16 len=(UINT16)WStringLen(unifn+temp);
              
               (plfni->AttrByte[0])=(UINT8)(n+1); //³¤ÃûÏîµÄĞòºÅ×Ö½Ú
               if(len<=13) (plfni->AttrByte[0])|=0X40; //Èç¹û·¢ÏÖ´Óµ±Ç°Î»ÖÃ¿ªÊ¼µÄUNI´®³¤¶ÈĞ¡ÓÚµÈÓÚ13£¬ÔòËµÃ÷ÊéÕâÊÇ×îºóÒ»
             -¸ö³¤ÃûÏî
              
               (plfni->ChkVal[0])=ChkSum; //Ğ´ÈëÓëSFNµÄ°ó¶¨Ğ£ÑéÖµ
               (plfni->LFNSign[0])=0X0F; //³¤ÃûÏîµÄ±êÖ¾
              
               (plfni->Resv[0])=(plfni->StartClu[0])=(plfni->StartClu[1])=0;
              
               for(i=0;i<10;i++) (plfni->Name1)[i]=0XFF; 
               for(i=0;i<12;i++) (plfni->Name2)[i]=0XFF;
               for(i=0;i<4;i++)  (plfni->Name3)[i]=0XFF; //ÏÈ°Ñ³¤ÃûUNIµÄ×Ö¶ÎÓÃ0XFFÌî³ä
               
               for(i=0;i<5;i++)
               {
                (plfni->Name1)[2*i]=(UINT8)(unifn[j+temp]&0X00FF);
                (plfni->Name1)[2*i+1]=(UINT8)((unifn[j+temp]&0XFF00)>>8);
                j++;
                if(j>=len) 
                {
                 if(4==i) 
                 {
                  (plfni->Name2)[0]=(plfni->Name2)[1]=0;
                 }
                 else
                 {
                i++;
                  (plfni->Name1)[2*i]=(plfni->Name1)[2*i+1]=0;
                 }
                 return ERR_SUCC; 
                }
               }
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 41  

               for(i=0;i<6;i++)
               {
                (plfni->Name2)[2*i]=(UINT8)(unifn[j+temp]&0X00FF);
                (plfni->Name2)[2*i+1]=(UINT8)((unifn[j+temp]&0XFF00)>>8);
                j++;
                if(j>=len)
                {
                 if(5==i) 
                 {
                  (plfni->Name3)[0]=(plfni->Name3)[1]=0;
                 }
                 else
                 {
                i++;
                  (plfni->Name2)[2*i]=(plfni->Name2)[2*i+1]=0;
                 }
                 return ERR_SUCC; 
                }
               }
              
               for(i=0;i<2;i++)
               {
                (plfni->Name3)[2*i]=(UINT8)(unifn[j+temp]&0X00FF);
                (plfni->Name3)[2*i+1]=(UINT8)((unifn[j+temp]&0XFF00)>>8);
                j++;
                if(j>=len)
                {
                 if(1!=i) 
                 {
                i++;
                  (plfni->Name3)[2*i]=(plfni->Name3)[2*i+1]=0;
                 }
                 return ERR_SUCC; 
                }
               }
               
               return ERR_SUCC;
              }
              #endif
2474          
2475          /********************************************************************************
2476           ¹¦ÄÜ£ºÏòÄ¿Â¼´ØÖĞ×¢²á³¤ÃûÏî¼°Æä¶ÔÓ¦µÄ¶ÌÃûÏî£¬²¢·µ»Ø¶ÌÃûÏîËùÔÚµÄÉÈÇøÓëÉÈÇøÄÚµÄÎ»ÖÃ
2477           ĞÎ²Î£ºcluster:Òª´´½¨µÄÎÄ¼ş»òÄ¿Â¼ËùÔÚµÄÄ¿Â¼µÄÊ×´Ø pfdi:Ö¸Ïò¶ÌÃûÏîµÄÖ¸Õë 
2478                 unifn:Ö¸ÏòUNICODE±àÂëµÄ³¤ÃûµÄÖ¸Õë psec:Ö¸ÏòÓÃÓÚ´æ´¢¶ÌÃûÏîËùÔÚÉÈÇøµÄ±äÁ¿Ö¸Õë
2479                 pn:Ö¸ÏòÓÃÓÚ¼ÇÂ¼¶ÌÃûÏîÔÚÆäËùÔÚÉÈÇøÖĞµÄÎ»ÖÃµÄ±äÁ¿µÄÖ¸Õë
2480           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»ò´íÎóºÅ
2481           Ïê½â£ºÒòÎª³¤ÃûÊÇÓÉ¶à¸ö³¤ÃûÏîºÍÒ»¸ö¶ÌÃûÏîËù¹²Í¬À´½øĞĞ±í´ïµÄ£¬Òò´Ë´´½¨³¤ÃûµÄÎÄ¼ş»ò
2482                 Ä¿Â¼£¬ÆäºËĞÄ²Ù×÷¾ÍÊÇ¿ÉÒÔÒ»´ÎĞÔÏòÄ¿Â¼´ØÖĞ×¢²á¶à¸öÎÄ¼şÄ¿Â¼Ïî¡£´Ëº¯Êı»ù±¾ÉÏÊÇ
2483                 ¶ÔRefigster_FDI£¨ËüÓÃÓÚÊµÏÖÎª¶ÌÃû×¢²áÎÄ¼şÄ¿Â¼Ïî£©µÄÀ©Õ¹¡£
2484          *********************************************************************************/
2485          #ifdef REGISTER_LFN_FDI
              UINT8 Register_LFN_FDI(UINT32 cluster,struct FDI *pfdi,UINT16 *unifn,UINT32 *psec,UINT8 *pn)
              {
               UINT32 temp_sec=0,old_cluster=0;
               UINT8 iClu=0,iSec=0,iFDI=0,res=0;
               struct FDIesInSEC *pitems;
               struct FDI *pitem;
              
               struct LFN_FDI *plfni;
              
               UINT8 have_lfn=0; //ÔÚÎÄ¼şÄ¿Â¼ÏîÉ¨Ãè¹ı³ÌÖÖ£¬ÓÃÓÚ±ê¼ÇÊÇ·ñÓĞ³¤Ãû
               UINT8 is_lfn_buf_err=0,cur_binding_sumchk=0,flag=0,chksum=Get_Binding_SumChk(pfdi);
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 42  

               UINT16 lfn_buf[MAX_LFN_LEN+1]; //ÓÃÓÚ×°ÔØ³¤ÃûUNIÂëµÄ»º³å
               struct LFN_FDI temp_lfni; //ÓÃÓÚ¹¹Ôì³¤ÃûÏîµÄÁÙÊ±½á¹¹Ìå±äÁ¿
              
               UINT16 len=(UINT16)WStringLen(unifn),xlen=0; //¼ÆËãUNI´®³¤¶È
               UINT8 nclu=0,nsec=0,nlfni=(UINT8)(len/13);
               if(len%13) nlfni++; //¼ÆËãUNI´®»á·ÖÎª¶àÉÙ¸ö³¤ÃûÏî
              
               //===========================================================================================
              
               if(0==pInit_Args->Free_nCluster) return ERR_NO_SPACE; //Èç¹ûÃ»ÓĞ¿Õ¼ä£¬ÔòÖ±½Ó·µ»Ø
               
               //ÒÔÏÂ´úÂë¼ì²éÊÇ·ñÒÑ¾­´æÔÚÖØ¸´µÄÎÄ¼ş»òÄ¿Â¼£¬ÒÔ¼°²éÑ¯¿ÕÎ»²¢ÌîÈëÄ¿Â¼Ïî
               do
               {
                temp_sec=SOC(cluster);
                for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++)
                {
                 znFAT_Device_Read_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                 pitems=((struct FDIesInSEC *)znFAT_Buffer);
              
                 for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++)
                 {
                pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
              
                if((0X08!=pitem->Attributes) && (0X0F!=pitem->Attributes)  //²»ÊÇ¾í±ê¡¢²»ÊÇ³¤ÃûÏî¡¢Ã»ÓĞÉ¾³ı¡¢²»ÊÇ.Óë..
                     && (0XE5!=pitem->Name[0]) && ('.'!=pitem->Name[0])) //¼´Óöµ½Ò»¸öºÏ·¨µÄSFNÏî
                {
                 if(have_lfn && !is_lfn_buf_err) //Óöµ½SFNÏîºó£¬ËüÇ°Ãæ¿ÉÄÜÓĞ³¤ÃûÏî£¬Èç¹ûÓĞÔòÓëÊäÈëµÄUNI´®±È¶Ô£¬ÒÔÈ·¶¨ÊÇ·ñ
             -ÓĞÍ¬ÃûÎÄ¼ş»òÄ¿Â¼
                 {                               //¶øÇÒÃ»ÓĞ·¢Éúlfn_bufµÄÒç³ö´íÎó
                    if(cur_binding_sumchk==Get_Binding_SumChk(pitem)) //Èç¹ûLFNÓëSFNÄ¿Â¼Ïî°ó¶¨Ğ£ÑéºÍÏàµÈ£¬ÔòÈÏÎª³¤ÃûÓĞĞ§
                  { 
                   xlen=(UINT16)WStringLen(lfn_buf); //¼ÆËã´Ó¸÷³¤ÃûÏîºÏ³ÉºóµÄUNI´®µÄ³¤¶È
                   if(xlen==len && Memory_Compare(((UINT8 *)unifn),((UINT8 *)lfn_buf),2*((UINT32)len))) //¶ÔUNI´®½øĞĞ±È¶Ô
             -£¬³¤¶ÈºÍÄÚÈİÒªÏàµÈ
                   {
                          *psec=temp_sec+(UINT32)iSec;
                          *pn=iFDI; //¼ÇÂ¼ÖØÃûÎÄ¼şÄ¿Â¼ÏîµÄÎ»ÖÃ£¬ÒÔ±ã¶ÔÆä½øĞĞ½âÎö
                    return ERR_FDI_ALREADY_EXISTING; //ÒÑÓĞÍ¬ÃûÎÄ¼ş»òÄ¿Â¼
                   }
                  }
                 }
                       if(is_lfn_buf_err) is_lfn_buf_err=0; //»Ö¸´³¤ÃûÏîUNIÌáÈ¡µÄ´íÎó±ê¼Ç
                }
              
                  if(CHK_ATTR_LFN(pitem->Attributes) && (0XE5!=pitem->Name[0])) //ÊÇ³¤ÃûÏî£¬¶øÇÒÃ»ÓĞ±»É¾³ı
                {
                 have_lfn=1;
                 
                 plfni=(struct LFN_FDI *)pitem;
              
                   cur_binding_sumchk=(plfni->ChkVal)[0]; //»ñÈ¡³¤ÃûÏîµÄ°ó¶¨Ğ£ÑéºÍ
              
                   res=Get_Part_Name(lfn_buf,plfni,(UINT8)((((plfni->AttrByte[0])&0XBF)-1)*13)); //½«µ±Ç°LFNÏîÖĞµÄÎÄ¼şÃû
             -UNICODEÂëÆ´ÈëÁÙÊ±»º³å
                                                                                    //´ËÁÙÊ±»º³å³¤¶ÈÎªMAX_LFN_LEN£¬Èç¹ûÔ
             -½½ç£¬Ôò
                                                                                  //²»ÔÙ×°Èë£¬×îÖÕÔì³ÉLFNµÄ½Ø¶Ï¡£
                 if(res) is_lfn_buf_err=1; //·¢ÉúLFN_BUFÒç³ö´íÎó
                }
                else
                {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 43  

                 have_lfn=0;
                }
              
                if(0==(pitem->Name)[0])
                {
                   flag=1; //±ê¼Ç´ËÉÈÇøÒÑ¾­±»ĞŞ¸Ä
              
                 if(nlfni>0)
                 {
                  Fill_LFN_FDI(unifn,&temp_lfni,chksum,(UINT8)(nlfni-1));
                    Memory_Copy(((UINT8 *)pitem),((UINT8 *)(&temp_lfni)),FDI_NBYTES); //½«ºÏ³ÉµÄ³¤ÃûÏî¿½±´µ½ÉÈÇøÊı¾İÖĞ
                  nlfni--;
                 }
                 else
                 {
                  *psec=temp_sec+(UINT32)iSec;
                  *pn=iFDI; //¼ÇÂ¼¿ÕÎ»µÄÎ»ÖÃ
                  Memory_Copy(((UINT8 *)pitem),((UINT8 *)pfdi),FDI_NBYTES); //½«¶ÌÃûÏî¿½±´µ½ÉÈÇøÊı¾İÖĞ
                  znFAT_Device_Write_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                  return ERR_SUCC;
                 }   
                }
                 }
              
                 if(flag) 
                 {
                znFAT_Device_Write_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                flag=0;
                 }
                }
                old_cluster=cluster;
                cluster=Get_Next_Cluster(cluster);
               }while(!IS_END_CLU(cluster)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
               //===========================================================
               //Èç¹ûÔËĞĞµ½ÕâÀï£¬ÔòËµÃ÷µ±Ç°´ØÖĞÒÑÎŞ¿ÕÎ»
               if(0!=pInit_Args->Free_nCluster) //Èç¹ûÊ£Óà¿Õ´ØÊıÎª0£¬ÔòËµÃ÷´ÅÅÌÒÑÎŞ¿Õ¼ä
               {
                nsec=(UINT8)((nlfni+1)/NFDI_PER_SEC); //Ê£ÓàµÄ³¤ÃûÏî»¹ĞèÒª¶àÉÙ¸öÉÈÇø,+1ÊÇÒòÎª×îºó»¹ÓĞÒ»¸ö¶ÌÃûÏî
                if((nlfni+1)%NFDI_PER_SEC) nsec++; 
              
                nclu=(UINT8)(nsec/(pInit_Args->SectorsPerClust));
                if(nsec%(pInit_Args->SectorsPerClust)) nclu++;
              
                for(iClu=0;iClu<nclu;iClu++)
                {
                 Modify_FAT(old_cluster,pInit_Args->Next_Free_Cluster);
                 Modify_FAT(pInit_Args->Next_Free_Cluster,0X0FFFFFFF); //¹¹ÔìFAT´ØÁ´
                 Clear_Cluster(pInit_Args->Next_Free_Cluster); //Çå¿Õ¿ÕÏĞ´Ø
              
                 temp_sec=SOC(pInit_Args->Next_Free_Cluster);
              
                 old_cluster=pInit_Args->Next_Free_Cluster;
                 Update_Next_Free_Cluster();
              
                 for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++)
                 {
                  znFAT_Device_Read_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                pitems=((struct FDIesInSEC *)znFAT_Buffer);
                  
                for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++)
                {
                 pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 44  

              
                 if(nlfni>0)
                 {
                  Fill_LFN_FDI(unifn,&temp_lfni,chksum,(UINT8)(nlfni-1));
                    Memory_Copy(((UINT8 *)pitem),((UINT8 *)(&temp_lfni)),FDI_NBYTES); //½«ºÏ³ÉµÄ³¤ÃûÏî¿½±´µ½ÉÈÇøÊı¾İÖĞ
                  nlfni--;
                 }
                 else
                 {
                  *psec=temp_sec+(UINT32)iSec;
                  *pn=iFDI; //¼ÇÂ¼¿ÕÎ»µÄÎ»ÖÃ
                  Memory_Copy(((UINT8 *)pitem),((UINT8 *)pfdi),FDI_NBYTES); //½«¶ÌÃûÏî¿½±´µ½ÉÈÇøÊı¾İÖĞ
                  znFAT_Device_Write_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                  return ERR_SUCC;
                 }
                }
                znFAT_Device_Write_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                 }   
                }
                return ERR_SUCC;  
               }
               else
               {
                return ERR_NO_SPACE;
               } 
              }
              #endif
2644          
2645          //===================ÒÔÉÏ´úÂëÓÃÓÚÊµÏÖ³¤ÎÄ¼şÃû¹¦ÄÜ===for LFN=======================================
2646          
2647          /************************************************************************************
2648           ¹¦ÄÜ£º´ò¿ªÎÄ¼ş
2649           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë filepath:ÎÄ¼şµÄÂ·¾¶ n:ĞòºÅ is_file:Òª´ò¿ªÊÇ·ñÊÇÎÄ¼ş
2650           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦ »ò ´íÎóÂë
2651           Ïê½â£º´Ëº¯ÊıµÄ¹¦ÄÜ±È½Ï¶àÑùĞÔ£¬ÎÄ¼şµÄÂ·¾¶Ö§³ÖÎŞÏŞÉî²ãÄ¿Â¼ Èç /a/b/c/d/e/f/g/..../a.txt
2652                 Â·¾¶ÖĞµÄÄ¿Â¼·Ö¸ô·û¿ÉÒÔÎª/»ò\£¨ÔÚCÖĞ×Ö·û´®ÖĞ±í´ï\ÒªÕâÑùĞ´\\£©£¬ÎÄ¼şÃûÖĞÖ§³ÖÄÜÅä
2653                 ·û£¬Èç/a/b/c/d/.../a*.txt /??abc.txt £¬ÎÄ¼şÃûÖ§³Ö³¤ÎÄ¼şÃû£¬¶øÇÒÎŞÂÛ³¤Ãû¶ÌÃû¾ùÖ§
2654                 ³ÖÍ¨Åä£¬ÔÚÊ¹ÓÃÍ¨ÅäÎÄ¼şÃûÊ±£¬ÓëÖ®Æ¥ÅäµÄÎÄ¼ş¿ÉÄÜ»áÓĞ¶à¸ö£¬nÓÃÒÔÖ¸¶¨Òª´ò¿ªµÄÊÇµÚ¼¸
2655                 ¸öÎÄ¼ş£¬´Ëº¯ÊıÒà¿É´ò¿ªÄ¿Â¼£¬ÎÄ¼ş»òÄ¿Â¼´ò¿ªºó£¬ÆäĞÅÏ¢½«±»×°Èëµ½pfiËùÖ¸ÏòµÄÎÄ¼ş
2656                 ĞÅÏ¢¼¯ºÏÖĞ¡£×¢£º¶ÔÓÚÄ¿Â¼ËäÈ»´æ´¢ĞÎÊ½ÉÏÓëÎÄ¼şÏàËÆ£¬¶¼ÊÇÒÔÎÄ¼şÄ¿Â¼ÏîÀ´´æ´¢£¬µ«Ëü
2657                 Ã»ÓĞÎÄ¼ş´óĞ¡µÈ×Ö¶Î£¨ºã¶¨Îª0£©¡£
2658          *************************************************************************************/
2659          #ifdef ZNFAT_OPEN_FILE 
2660          UINT8 znFAT_Open_File(struct FileInfo *pfi,INT8 *filepath,UINT32 n,UINT8 is_file)
2661          {
2662   1       UINT8 result=0,flag=0;
2663   1       UINT32 sec_temp=0,Cur_Cluster=0,fn_pos=0,item=0;
2664   1       UINT32 iSec=0,iFDI=0;
2665   1      
2666   1       //===========for LFN=======
2667   1       #ifdef USE_LFN
               struct LFN_FDI *plfni;
              
               UINT8 cur_binding_sumchk=0;
               UINT8 is_wfn=0;
               UINT16 temp_lfn[MAX_LFN_LEN+1]; //ÓÃÓÚ×°ÔØ³¤ÃûUNICODEÂëµÄÁÙÊ±»º³å
               UINT8 is_lfn=0; //ÊäÈëµÄÎÄ¼şÃûÊÇ·ñÊÇ³¤Ãû
               UINT8 is_lfn_buf_err=0; //²úÉú³¤Ãû»º³åÒç³ö´íÎó£¬´Ë±ê¼ÇÎª1ÔòÖ±½ÓÌø¹ı³¤Ãû±È¶Ô
               #endif
2676   1       //===========for LFN=======
2677   1      
2678   1       INT8 temp_filename[13];
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 45  

2679   1       INT8 *filename;
2680   1      
2681   1       struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
2682   1       struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
2683   1      
2684   1       #ifdef USE_LFN
               pfi->have_lfn=BOOL_FALSE; //ÏÈÉè¶¨ÎÄ¼şÎŞ³¤Ãû
               #endif
2687   1      
2688   1       just_file=pfi;
2689   1      
2690   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               Memory_Set((UINT8 *)pcccb_buf,sizeof(UINT32)*CCCB_LEN,0);
               #endif
               #endif
2697   1      
2698   1       #ifdef USE_EXCHANGE_BUFFER
               #ifdef USE_ALONE_EXB
               //Memory_Set(just_file->exb_buf,512,0);
               just_file->exb_cursec=0;
               #endif
               #endif
2704   1      
2705   1       result=znFAT_Enter_Dir(filepath,&Cur_Cluster,&fn_pos); //»ñÈ¡Â·¾¶×îºóÒ»¼¶Ä¿Â¼µÄ¿ªÊ¼´Ø
2706   1       if(result) return result;
2707   1      
2708   1       filename=filepath+fn_pos; //filenameÖ¸ÏòfilepathÖĞµÄÎÄ¼şÃû
2709   1                                 //×¢£ºÈç¹û´ò¿ªµÄÊÇÄ¿Â¼£¬ÔòÂ·¾¶filepath²»ÒÔ/»ò\½áÊø£¬Èç´ò¿ªÄ¿Â¼\a\b\c 
2710   1                                 //²»ÒªĞ´³É\a\b\c\£¬ÕâÑù»áÔì³É´ò¿ªÊ§°Ü
2711   1                                 //znFATÈÏÎªÄãÒª´ò¿ªcÄ¿Â¼ÏÂµÄÒ»¸öÃû×ÖÎª¿ÕµÄÄ¿Â¼
2712   1                                 //´ò¿ªÄ¿Â¼Óë½øÈëÄ¿Â¼²»Í¬£¬½øÈëÄ¿Â¼½ö»ñÈ¡Ä¿Â¼Ê×´Ø£¬¶ø´ò¿ªÄ¿Â¼
2713   1                                 //Ôò¶ÔÄ¿Â¼½øĞĞ½âÎö£¬½«ÎÄ¼şÏà¹Ø²ÎÊıÌîÈëÎÄ¼şĞÅÏ¢¼¯ºÏ£¬ÈçÄ¿Â¼´´½¨Ê±¼äµÈ
2714   1      
2715   1       if(Check_Illegal_Char(filename)) return ERR_ILL_CHAR; //¼ì²éÎÄ¼şÃûÖĞÊÇ·ñÓĞ·Ç·¨×Ö·û£¬ÎŞÂÛ³¤Ãû»¹ÊÇ¶ÌÃû£¬»òÊ
             -ÇÍ¨ÅäÃû 
2716   1      
2717   1       //ÕâÀïÖ÷ÒªÕë¶ÔÓÚLFN¡¢SFN¼°Í¨ÅäÃû½øĞĞÏà¹Ø¼ì²â
2718   1       if(!Is_WildFileName(filename)) //Èç¹û²»ÊÇÍ¨ÅäÎÄ¼şÃû£¬¼´È·¶¨Ãû£¬ÔòĞèÒª½øĞĞÎÄ¼şÃûºÏ·¨ĞÔ¼ì²â
2719   1       {
2720   2        #ifdef USE_LFN
                if(!Is_LFN(filename)) //Èç¹û²»ÊÇ³¤Ãû,¼´ÊÇ¶ÌÃû
                {
                #endif
2724   2         //¼ì²éSFNºÏ·¨ĞÔ£¬Èô·Ç·¨ÔòÖ±½Ó·µ»Ø£¬²»ÔÙ½øĞĞºóÃæµÄ´¦Àí(´Ë´¦¶ÔSFNµÄºÏ·¨ĞÔ¼ì²é±È½ÏÑÏ¸ñ)
2725   2         //ÊÂÏÈ¼ì²éSFNµÄºÏ·¨ĞÔ£¬¼õÉÙºóÃæ´¦ÀíÉÏµÄÂé·³
2726   2      
2727   2         if(Check_SFN_Illegal_Length(filename)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
2728   2         if(Check_SFN_Dot(filename)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨ 
2729   2         if(Check_SFN_Special_Char(filename)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
2730   2         if(((UINT8)(-1))==Check_SFN_Illegal_Lower(filename)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´
             -óĞ¡Ğ´
2731   2      
2732   2        #ifdef USE_LFN
                }
                else //Èç¹ûÊÇ³¤Ãû
                {
                 is_lfn=1; //±ê¼ÇÊäÈëµÄÎÄ¼şÃûÎª³¤Ãû
                 result=oemstr2unistr(filename,temp_lfn);//°Ñfilename×ªÎªUNICODEÂë£¬´æÔÚtemp_lfnÀï£¬ÒÔ±ãºóÃæ½øĞĞÎÄ¼şÃû±È
             -¶Ô
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 46  

                 if(result) return result;
                }
                #endif
2741   2       }
2742   1       else //Èç¹ûÊÇÍ¨ÅäÃû£¬¼´º¬ÓĞ*»ò?
2743   1       {
2744   2        #ifdef USE_LFN
                is_wfn=1; //±êÖ¾ÊäÈëµÄÎÄ¼şÃûÎªÍ¨ÅäÃû
                is_lfn=1; //ÔÚÕâÖÖÇé¿öÏÂ£¬Ò²ÈÏÎªÊÇ³¤Ãû£¬Í¨ÅäÃûÒ²ÒªÓëLFNÏà±È¶Ô
                result=oemstr2unistr(filename,temp_lfn); //×ªÎª´øÍ¨Åä·ûµÄUNI´®
                if(result) return result; //OEM×Ö·û¼¯²»ÍêÈ«£¬OEM->UNI×ª»»ÖĞÓĞ×Ö·ûÕÒ²»µ½ »ò LFN»º³åÒç³ö
                #endif
2750   2       }
2751   1      
2752   1       //================================================
2753   1       do
2754   1       {
2755   2        sec_temp=SOC(Cur_Cluster); //µ±Ç°´ØÊ×ÉÈÇø
2756   2        for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++) 
2757   2        {
2758   3         znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer);
2759   3         pitems=(struct FDIesInSEC *)znFAT_Buffer; 
2760   3      
2761   3         for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++) //·ÃÎÊÉÈÇøÖĞ¸÷ÎÄ¼şÄ¿Â¼Ïî
2762   3         {
2763   4          pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
2764   4           
2765   4          if((is_file?CHK_ATTR_FILE(pitem->Attributes):CHK_ATTR_DIR(pitem->Attributes)) 
2766   4          && (0XE5!=pitem->Name[0]) && ('.'!=pitem->Name[0])) //ÒÀis_file¼ì²éÊôĞÔ£¬ÇÒÃ»ÓĞ±»É¾³ı
2767   4                                                              //²»ÊÇ.Óë..
2768   4          {
2769   5           To_File_Name((INT8 *)(pitem->Name),temp_filename); //½«FDIÖĞµÄÎÄ¼şÃû×Ö¶Î×ªÎª8.3ÎÄ¼şÃû
2770   5      
2771   5         #ifdef USE_LFN 
                   if(!is_lfn || is_wfn) //Èç¹ûÊäÈëµÄÎÄ¼şÃû²»ÊÇ³¤ÎÄ¼şÃû£¬¼´Îª¶ÌÎÄ¼şÃû£¬»òÕßÊÇÅäÍ¨Ãû£¬ÔòÒª½øĞĞSFN±È¶Ô
                 #endif                //Ö÷ÒªÊÇÎªÁË·ÀÖ¹¶àÓàµÄ²Ù×÷£¬Èç¹ûÊäÈëÎÄ¼şÃûÎª³¤ÎÄ¼şÃû£¬Ôò¸ù±¾²»ÓÃSFN±È¶Ô£¬¾Í
2774   5                             //Ëã±È¶Ô£¬½á¹ûÒ²Ò»¶¨ÊÇ²»Æ¥ÅäµÄ
2775   5           {
2776   6            if(!SFN_Match(filename,temp_filename)) //¶ÌÎÄ¼şÃûÍ¨Åä
2777   6          {
2778   7           if(n==item)
2779   7           {
2780   8              Analyse_FDI(pfi,pitem); //½âÎöÆ¥ÅäµÄÎÄ¼şÄ¿Â¼Ïî
2781   8            pfi->FDI_Sec=sec_temp+iSec; //ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
2782   8            pfi->nFDI=(UINT8)iFDI; //ÎÄ¼şÄ¿Â¼ÏîÔÚÉÈÇøÖĞµÄË÷Òı
2783   8      
2784   8              #ifdef USE_LFN
                    if(!pfi->have_lfn) (pfi->longname)[0]=0;
                      #endif
2787   8      
2788   8            return ERR_SUCC;
2789   8           } 
2790   7           flag=1;
2791   7          }
2792   6         }
2793   5      
2794   5           #ifdef USE_LFN
                   if(is_lfn && (pfi->have_lfn) && !is_lfn_buf_err) //Èç¹ûÊäÈëµÄÎÄ¼şÃûÎª³¤Ãû£¬¶øÇÒÒ²·¢ÏÖÁË³¤Ãû
                 {
                  if(cur_binding_sumchk==Get_Binding_SumChk(pitem)) //Èç¹ûLFNÓëSFNÄ¿Â¼Ïî°ó¶¨Ğ£ÑéºÍÏàµÈ£¬ÔòÈÏÎª
                  {                                                 //³¤ÃûÓĞĞ§
                     if(!LFN_Match(temp_lfn,(pfi->longname))) //³¤ÎÄ¼şÃûÍ¨Åä
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 47  

                   {
                    if(n==item)
                  {
                       Analyse_FDI(pfi,pitem); //½âÎöÆ¥ÅäµÄÎÄ¼şÄ¿Â¼Ïî
                     pfi->FDI_Sec=sec_temp+iSec; //ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
                     pfi->nFDI=(UINT8)iFDI; //ÎÄ¼şÄ¿Â¼ÏîÔÚÉÈÇøÖĞµÄË÷Òı
                     return ERR_SUCC;
                  }
                    flag=1;
                   }  
                  }
                 }
              
                 if(is_lfn_buf_err) is_lfn_buf_err=0;
                   #endif
2815   5      
2816   5         if(flag) {item++;flag=0;} //Èç¹ûLFN£¨Èç¹ûÓÃÁËLFNµÄ»°£©ÓëSFNÓĞÒ»Ïî±È¶Ô³É¹¦£¬µ«item²»Æ¥Åä£¬Ôòitem++
2817   5        }
2818   4      
2819   4          #ifdef USE_LFN
                  if((CHK_ATTR_DIR(pitem->Attributes))||(CHK_ATTR_FILE(pitem->Attributes))) //Èç¹ûÓöµ½¶ÌÃûÏî»Ö¸´³¤¶È´íÎó±ê
             -¼Ç
                    if(is_lfn_buf_err) is_lfn_buf_err=0;
              
                  if(CHK_ATTR_LFN(pitem->Attributes) && (0XE5!=pitem->Name[0]) && is_lfn) //ÊÇ³¤ÃûÏî£¬¶øÇÒÃ»ÓĞ±»É¾³ı£¬²¢
             -ÇÒÊäÈëµÄÎÄ¼şÃûÊÇ³¤Ãû
                {                                                                       //ÒòÎªÈç¹ûÎÒÃÇÊäÈëµÄÎÄ¼şÃû±¾Éí¾Í²
             -»ÊÇ³¤Ãû£¬ÄÇÎÒÃÇ¾ÍÃ»±ØÒªÈ¥¹ØĞÄ³¤ÃûÏî
                   pfi->have_lfn=1;
                 
                 plfni=(struct LFN_FDI *)pitem;
              
                 cur_binding_sumchk=(plfni->ChkVal)[0]; //»ñÈ¡³¤ÃûÏîµÄ°ó¶¨Ğ£ÑéºÍ
                  
                   result=Get_Part_Name(pfi->longname,plfni,(UINT8)((((plfni->AttrByte[0])&0XBF)-1)*13)); //½«µ±Ç°LFNÏîÖ
             -ĞµÄÎÄ¼şÃûUNICODEÂëÆ´ÈëÁÙÊ±»º³å
                                                                                    //´ËÁÙÊ±»º³å³¤¶ÈÎªMAX_LFN_LEN£¬Èç¹ûÔ
             -½½ç£¬Ôò
                                                                                  //²»ÔÙ×°Èë£¬×îÖÕÔì³ÉLFNµÄ½Ø¶Ï¡£
                 if(result) is_lfn_buf_err=1; //·¢ÉúLFN_BUFÒç³ö´íÎó
                }
                else
                {
                 pfi->have_lfn=0;
                }
                  #endif
2841   4      
2842   4         }
2843   3        }
2844   2      
2845   2        Cur_Cluster=Get_Next_Cluster(Cur_Cluster); //»ñÈ¡ÏÂÒ»´Ø
2846   2       }while(!IS_END_CLU(Cur_Cluster)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
2847   1      
2848   1       return ERR_NO_FILE;
2849   1      }
2850          #endif
2851          
2852          /************************************************************************************
2853           ¹¦ÄÜ£º»ñÈ¡Ò»¸öÄ¿Â¼µÄ¿ªÊ¼´Ø
2854           ĞÎ²Î£ºdir_name:Ä¿Â¼Ãû pCluster:Ö¸ÏòÓÃÓÚ´æ´¢´ØºÅµÄ±äÁ¿µÄÖ¸Õë ×¢£º´ËÖ¸Õë²»¹âÓÃÓÚ½«Ä¿Â¼
2855                 ËùÔÚµÄÄ¿Â¼´ØºÅ´«Èë£¬Í¬Ê±ÓÖ½ÓÊÕÄ¿Â¼µÄ¿ªÊ¼´Ø¡£±ÈÈç£ºÎÒÃÇÒª»ñÈ¡ /a/b/c cÄ¿Â¼µÄ¿ª
2856                 ´Ø£¬pClusterÊ×ÏÈ´«ÈëbµÄ¿ªÊ¼´Ø£¬È»ºó³ÌĞò»áÔÚÕâ¸ö¿ªÊ¼´Ø¼°Æäºó¼Ì´ØÖĞÑ°ÕÒÎªÃûdir_n
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 48  

2857                 ameµÄÄ¿Â¼Ïî£¬ÕÒµ½ºó£¬½«Æä¿ªÊ¼Í¨¹ıpCluster´«»Ø£¬¼´pClusterËùÖ¸ÏòµÄ±äÁ¿·¢ÉúÁË¸Ä
2858                 ±ä¡£
2859           ·µ»Ø£ºÔËĞĞ½á¹û   ³É¹¦»ò´íÎóºÅ
2860           Ïê½â£º´Ëº¯ÊıµÄÊµÏÖ¹ı³ÌÓë´ò¿ªÎÄ¼ş²î²»¶à£¬¶øÇÒ±ÈËü»¹¼òµ¥Ğ©¡£dir_nameÍ¬ÑùÖ§³Ö³¤ÎÄ¼şÃû¼°
2861                 Í¨Åä¡£
2862          *************************************************************************************/
2863          #ifdef GET_DIR_START_CLUSTER
2864          UINT8 Get_Dir_Start_Cluster(INT8 *dir_name,UINT32 *pCluster) //»ñÈ¡Ä¿Â¼ÏÂÃûÎªdir_nameµÄ×ÓÄ¿Â¼µÄ¿ªÊ¼´Ø
2865          {                                                            //Ä¿Â¼µÄÊ×´Ø´æÈëpClusterËùÖ¸ÈëµÄ±äÁ¿
2866   1       UINT32 sec_temp=0;
2867   1       UINT8 iSec=0,iFDI=0;
2868   1       UINT32 Cur_Clust=*pCluster;
2869   1      
2870   1       //===========for LFN=======
2871   1       #ifdef USE_LFN
               struct LFN_FDI *plfni;
              
               UINT8 cur_binding_sumchk=0,result=0;
               UINT16 temp_lfn[MAX_LFN_LEN+1]; //ÓÃÓÚ×°ÔØ³¤ÃûUNICODEÂëµÄÁÙÊ±»º³å
               UINT16 lfn_buf[MAX_LFN_LEN+1]; //´Ó³¤ÃûÏîÖĞÌáÈ¡µÄUNIÂë×°µ½Õâ¸ö»º³åÖĞ
               UINT8 is_lfn=0; //ÊäÈëµÄÎÄ¼şÃûÊÇ·ñÊÇ³¤Ãû
               UINT8 have_lfn=0; //ÔÚËÑË÷Ä¿Â¼ÏîÊ±·¢ÏÖÁË³¤ÃûÏî
               UINT8 is_lfn_buf_err=0; //²úÉú³¤Ãû»º³åÒç³ö´íÎó£¬´Ë±ê¼ÇÎª1ÔòÖ±½ÓÌø¹ı³¤Ãû±È¶Ô
               #endif
2881   1      
2882   1       //===========for LFN=======
2883   1      
2884   1       INT8 temp_dirname[13];
2885   1      
2886   1       struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
2887   1       struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
2888   1      
2889   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #endif
2892   1      
2893   1       if(Check_Illegal_Char(dir_name)) return ERR_ILL_CHAR; //¼ì²éÎÄ¼şÃûÖĞÊÇ·ñÓĞ·Ç·¨×Ö·û
2894   1      
2895   1       #ifdef USE_LFN
               if(!Is_LFN(dir_name)) //Èç¹û²»ÊÇ³¤Ãû,¼´ÊÇ¶ÌÃû
               {
               #endif
2899   1        //¼ì²é¶ÌÎÄ¼şÃûºÏ·¨ĞÔ£¬Èô·Ç·¨ÔòÖ±½Ó·µ»Ø£¬²»ÔÙ½øĞĞºóÃæµÄ´¦Àí(´Ë´¦¶ÔSFNµÄºÏ·¨ĞÔ¼ì²é·Ç³£ÑÏ¸ñ)
2900   1        //ÊÂÏÈ¼ì²éSFNµÄºÏ·¨ĞÔ£¬¼õÉÙºóÃæ´¦ÀíÉÏµÄÂé·³
2901   1        if(Check_SFN_Illegal_Length(dir_name)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
2902   1        if(Check_SFN_Dot(dir_name)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨  
2903   1        if(Check_SFN_Special_Char(dir_name)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
2904   1        if(((UINT8)(-1))==Check_SFN_Illegal_Lower(dir_name)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´ó
             -Ğ¡Ğ´
2905   1       #ifdef USE_LFN
               }
               else //Èç¹ûÊÇ³¤Ãû
               {
                is_lfn=1; //±ê¼ÇÊäÈëµÄÎÄ¼şÃûÎª³¤Ãû
                result=oemstr2unistr(dir_name,temp_lfn);//°Ñfilename×ªÎªUNICODEÂë£¬´æÔÚtemp_lfnÀï£¬ÒÔ±ãºóÃæ½øĞĞÎÄ¼şÃû±È¶
             -Ô
                if(result) return result;
               }
               #endif
2914   1      
2915   1       //================================================
2916   1       do
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 49  

2917   1       {
2918   2        sec_temp=SOC(Cur_Clust); //µ±Ç°´ØÊ×ÉÈÇø
2919   2        for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++) 
2920   2        {
2921   3         znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer);
2922   3         pitems=(struct FDIesInSEC *)znFAT_Buffer; 
2923   3      
2924   3         for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++) //·ÃÎÊÉÈÇøÖĞ¸÷ÎÄ¼şÄ¿Â¼Ïî
2925   3         {
2926   4          pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
2927   4           
2928   4          if((CHK_ATTR_DIR(pitem->Attributes)) && (0XE5!=pitem->Name[0])) //ÎÄ¼şÊôĞÔÎªÄ¿Â¼£¬ÇÒÃ»ÓĞ±»É¾³ı
2929   4          {
2930   5           To_File_Name((INT8 *)(pitem->Name),temp_dirname); //½«FDIÖĞµÄÄ¿Â¼Ãû×Ö¶Î×ªÎª8.3ÎÄ¼şÃû
2931   5           #ifdef USE_LFN
                   if(!is_lfn)
                   #endif
2934   5         {
2935   6            if(!SFN_Match(dir_name,temp_dirname)) //Ä¿Â¼ÃûÆ¥Åä
2936   6          {
2937   7           //»ñÈ¡Ä¿Â¼µÄ¿ªÊ¼´Ø 
2938   7           *pCluster=(Bytes2Value(pitem->LowClust,2))|(Bytes2Value(pitem->HighClust,2)<<16); 
2939   7           return ERR_SUCC;
2940   7          }
2941   6         }
2942   5      
2943   5           #ifdef USE_LFN
                   if(is_lfn && have_lfn && !is_lfn_buf_err) //Èç¹ûÊäÈëµÄÎÄ¼şÃûÎª³¤Ãû£¬¶øÇÒÒ²·¢ÏÖÁË³¤Ãû
                 {                                         //Í¬Ê±ÓÖÃ»ÓĞ·¢Éú³¤Ãû»º³åÒç³ö´íÎó
                  if(cur_binding_sumchk==Get_Binding_SumChk(pitem)) //Èç¹ûLFNÓëSFNÄ¿Â¼Ïî°ó¶¨Ğ£ÑéºÍÏàµÈ£¬ÔòÈÏÎª
                  {                                                 //³¤ÃûÓĞĞ§
                     if(!LFN_Match(temp_lfn,lfn_buf)) //³¤ÎÄ¼şÃûÍ¨Åä
                   {
                    //»ñÈ¡Ä¿Â¼µÄ¿ªÊ¼´Ø 
                    *pCluster=(Bytes2Value(pitem->LowClust,2))|(Bytes2Value(pitem->HighClust,2)<<16); 
                  return ERR_SUCC;
                   }  
                  }
                 }
                   #endif
2957   5      
2958   5          }
2959   4      
2960   4          #ifdef USE_LFN
                if((CHK_ATTR_DIR(pitem->Attributes))||(CHK_ATTR_FILE(pitem->Attributes))) //Èç¹ûÓöµ½¶ÌÃûÏî»Ö¸´³¤¶È´íÎó±ê¼
             -Ç
                    if(is_lfn_buf_err) is_lfn_buf_err=0;
              
                  if(CHK_ATTR_LFN(pitem->Attributes) && (0XE5!=pitem->Name[0]) && is_lfn) //ÊÇ³¤ÃûÏî£¬¶øÇÒÃ»ÓĞ±»É¾³ı,ÊäÈ
             -ëµÄÃû×ÓÎª³¤Ãû
                {
                   have_lfn=1;
                 
                 plfni=(struct LFN_FDI *)pitem;
              
                 cur_binding_sumchk=(plfni->ChkVal)[0]; //»ñÈ¡³¤ÃûÏîµÄ°ó¶¨Ğ£ÑéºÍ
                  
                   result=Get_Part_Name(lfn_buf,plfni,(UINT8)((((plfni->AttrByte[0])&0XBF)-1)*13)); //½«µ±Ç°LFNÏîÖĞµÄÎÄ¼
             -şÃûUNICODEÂëÆ´ÈëÁÙÊ±»º³å
                                                                                    //´ËÁÙÊ±»º³å³¤¶ÈÎªMAX_LFN_LEN£¬Èç¹ûÔ
             -½½ç£¬Ôò
                                                                                  //²»ÔÙ×°Èë£¬×îÖÕÔì³ÉLFNµÄ½Ø¶Ï¡£
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 50  

                 if(result) is_lfn_buf_err=1; //Èç¹û·¢ÉúLFN_BUFÒç³ö´íÎó
                }
                  #endif
2978   4         }
2979   3        }
2980   2      
2981   2        Cur_Clust=Get_Next_Cluster(Cur_Clust); //»ñÈ¡ÏÂÒ»´Ø
2982   2       }while(!IS_END_CLU(Cur_Clust)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
2983   1      
2984   1       return ERR_NO_DIR; 
2985   1      }
2986          #endif
2987          
2988          /************************************************************************************
2989           ¹¦ÄÜ£º½øÈëÒ»¸öÄ¿Â¼£¬ÊµÎª»ñÈ¡Ä¿Â¼µÄ¿ªÊ¼´Ø
2990           ĞÎ²Î£ºdirpath:Ä¿Â¼µÄÂ·¾¶ pCluster:Ö¸ÏòÓÃÓÚ¼ÇÂ¼´ØºÅµÄ±äÁ¿µÄÖ¸Õë pos:Â·¾¶ÖĞÎÄ¼şÃûµÄÎ»ÖÃ
2991           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
2992           Ïê½â£º´Ëº¯ÊıËäÈ»Ê¹ÓÃÕß¿É¼û£¬µ«ÓÃ´¦²»´ó¡£Ëü·µ»ØÄ¿Â¼µÄ¿ªÊ¼´Ø¡£dirpath¿ÉÒÔ´øÓĞÎÄ¼şÃû£¬Èç
2993                 /a/b/c/d/e/test.txt º¯ÊıÔËĞĞÖ®ºóposËùÖ¸ÏòµÄ±äÁ¿µÄÖµÎªtest.txtÔÚÂ·¾¶ÖĞµÄÎ»ÖÃ¡£Ö÷
2994                 ÒªÊÇ¿¼ÂÇµ½´Ëº¯ÊıÓë´ò¿ªÎÄ¼ş»òÄ¿Â¼µÄº¯ÊıÏàÅäºÏ£¬¿ÉÒÔºÜ·½±ãµÄ´ÓÂ·¾¶ÖĞÌáÈ¡ÖĞÎÄ¼şÃû
2995          *************************************************************************************/
2996          #ifdef ZNFAT_ENTER_DIR
2997          UINT8 znFAT_Enter_Dir(INT8 *dirpath,UINT32 *pCluster,UINT32 *pos) 
2998          {
2999   1       UINT8 index=0,res=0;
3000   1       UINT32 i=1;
3001   1      
3002   1       #ifndef USE_LFN
3003   1       INT8 dirname[13];
3004   1       #else
               INT8 dirname[MAX_LFN_LEN+1];
               #endif
3007   1      
3008   1       *pos=1;
3009   1       *pCluster=2;
3010   1      
3011   1       if(('\\'==dirpath[0] || '/'==dirpath[0]) && '\0'==dirpath[1]) //Èç¹ûÊÇ"\\"£¬ÔòÖ±½ÓÈ¡Ê×Ä¿Â¼´Ø£¬¼´µÚ2´Ø
3012   1       {
3013   2        return ERR_SUCC;
3014   2       }
3015   1      
3016   1       while('\0'!=dirpath[i])
3017   1       {
3018   2        if('\\'==dirpath[i] || '/'==dirpath[i])
3019   2        {
3020   3         dirname[index]='\0';
3021   3         index=0;
3022   3         
3023   3         res=Get_Dir_Start_Cluster(dirname,pCluster);
3024   3         if(res) 
3025   3         { 
3026   4        return res;  //·µ»Ø´íÎóÂë  
3027   4         }
3028   3         *pos=i+1;
3029   3        } 
3030   2        else
3031   2        {
3032   3         dirname[index]=dirpath[i];
3033   3         index++;
3034   3         #ifndef USE_LFN
3035   3         if(index>12) //Èç¹û²»Ê¹ÓÃ³¤Ãû£¬ÔòÄ¿Â¼ÃûÒÔ¼°ÎÄ¼şÃû×î³¤²»ÄÜ³¬¹ı8+1+3
3036   3         {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 51  

3037   4        return ERR_SFN_ILL_LEN; //Ä¿Â¼Ãû³¤ÓÚ8.3£¬Òà·ÀÖ¹dirnameÒç³ö
3038   4         }
3039   3         #else
                 if(index>MAX_LFN_LEN) //Èç¹ûÊ¹ÓÃ³¤Ãû£¬ÔòÄ¿Â¼ÃûÒÔ¼°ÎÄ¼şÃû×î³¤²»ÄÜ³¬¹ıÉè¶¨µÄ³¤Ãû×î³¤³¤¶È
                 {
                return ERR_LFN_BUF_OUT; //Ä¿Â¼Ãû³¤ÓÚMAX_LFN_LEN£¬Òà·ÀÖ¹dirnameÒç³ö
                 }   
                 #endif
3045   3        }
3046   2        i++;
3047   2       }
3048   1         
3049   1       return ERR_SUCC; //³É¹¦
3050   1      }
3051          #endif
3052          
3053          /************************************************************************************
3054           ¹¦ÄÜ£ºÓÉ¸ø¶¨µÄ¶ÌÎÄ¼şÃû¼°Ê±¼äĞÅÏ¢£¬¹¹Ôì³öÒ»¸öÎÄ¼şÄ¿Â¼Ïî
3055           ĞÎ²Î£ºpfdi:Ö¸ÏòÓÃÓÚ×°ÔØÎÄ¼şÄ¿Â¼ÏîµÄ±äÁ¿µÄÖ¸Õë pfn:Ö¸ÏòÎÄ¼şÃû pdt:Ö¸ÏòÊ±¼äĞÅÏ¢ 
3056                 is_file:¹¹ÔìµÄÎÄ¼şÄ¿Â¼ÏîÓÃÓÚ±í´ïÎÄ¼ş»¹ÊÇÄ¿Â¼
3057           ·µ»Ø£º0
3058           Ïê½â£ºÔÚ¹¹ÔìÄ¿Â¼µÄÎÄ¼şÄ¿Â¼ÏîÊ±£¬ÒªÊÂÏÈÎªÆä·ÖÅäºÃ¿Õ´Ø£¬Òò´ËÒıÈëÁËis_fileÓÃÒÔÇø·Ö¡£
3059          *************************************************************************************/
3060          #ifdef FILL_FDI
3061          UINT8 Fill_FDI(struct FDI *pfdi,INT8 *pfn,struct DateTime *pdt,UINT8 is_file)
3062          {
3063   1       UINT8 dot_pos=0,have_dot=0,lowcase=0;
3064   1       UINT8 i=0,j=0,fn_len=(UINT8)StringLen(pfn);
3065   1       UINT16 time=0,date=0;
3066   1      
3067   1       Memory_Set(((UINT8 *)pfdi),FDI_NBYTES,0); //¶ÔÎÄ¼şÄ¿Â¼ÏîÇå0
3068   1      
3069   1       for(i=(UINT8)(fn_len-1);i>0;i--) //·´ÏòÑ°ÕÒ. µÚÒ»¸ö.ÊÇÖ÷ÎÄ¼şÓëÀ©Õ¹ÃûµÄ·Ö½ç
3070   1       {
3071   2        if('.'==pfn[i]) 
3072   2        {
3073   3         dot_pos=i;
3074   3         have_dot=1;
3075   3         break;
3076   3        }
3077   2       } 
3078   1      
3079   1       if(have_dot) //Èç¹ûÓĞµã
3080   1       {
3081   2        //ÌîÈëÖ÷ÎÄ¼şÃû
3082   2        for(i=0;i<dot_pos;i++)
3083   2        {
3084   3         (pfdi->Name)[i]=(INT8)Lower2Up(pfn[i]); //×ªÎª´óĞ´
3085   3        }
3086   2        for(;i<8;i++)
3087   2        {
3088   3         (pfdi->Name)[i]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
3089   3        }
3090   2      
3091   2        //ÌîÈëÀ©Õ¹Ãû
3092   2        for(i=(UINT8)(dot_pos+1);i<fn_len;i++)
3093   2        {
3094   3         (pfdi->Extension)[j]=(UINT8)Lower2Up(pfn[i]); //×ªÎª´óĞ´
3095   3         j++;
3096   3        }
3097   2        for(;j<3;j++)
3098   2        {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 52  

3099   3         (pfdi->Extension)[j]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
3100   3        }
3101   2       }
3102   1       else //Èç¹ûÃ»ÓĞµã
3103   1       {
3104   2        //ÌîÈëÖ÷ÎÄ¼şÃû
3105   2        for(i=0;i<fn_len;i++)
3106   2        {
3107   3         (pfdi->Name)[i]=(UINT8)Lower2Up(pfn[i]); //×ªÎª´óĞ´
3108   3        }
3109   2        for(;i<8;i++)
3110   2        {
3111   3         (pfdi->Name)[i]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
3112   3        } 
3113   2        
3114   2        //ÌîÈëÀ©Õ¹Ãû
3115   2        for(j=0;j<3;j++)
3116   2        {
3117   3         (pfdi->Extension)[j]=' '; //À©Õ¹ÃûÌîÈë¿Õ¸ñ
3118   3        }
3119   2       }
3120   1       //=======================ÌîÈëÖ÷ÎÄ¼şÃûÓëÀ©Õ¹Ãû========
3121   1      
3122   1       pfdi->Attributes=(UINT8)(is_file?0X20:0X30); //ÉèÖÃÊôĞÔ
3123   1       //=======================ÌîÈëÊôĞÔ========
3124   1      
3125   1       lowcase=Check_SFN_Illegal_Lower(pfn); //»ñÈ¡Ö÷ÎÄ¼şÃûÓëÀ©Õ¹ÃûµÄ´óĞ¡Ğ´×´Ì¬
3126   1       if((lowcase&0X0F)==0X01) //Èç¹ûÖ÷ÎÄ¼şÃûÎªĞ¡Ğ´
3127   1       {
3128   2        pfdi->LowerCase|=0X08;
3129   2       }
3130   1       if((lowcase&0XF0)==0X10) //Èç¹ûÀ©Õ¹ÃûÎªĞ¡Ğ´
3131   1       {
3132   2        pfdi->LowerCase|=0X10;
3133   2       }
3134   1       //=======================ÌîÈë´óĞ¡Ğ´¿ØÖÆ×Ö============
3135   1      
3136   1       pfdi->CTime10ms=(UINT8)((((pdt->time).sec)%2)?0X78:0X00);
3137   1       //=======================ÌîÈë´´½¨Ê±¼ä10MSÎ»==========
3138   1      
3139   1       time=(UINT16)(MAKE_TIME((pdt->time).hour,(pdt->time).min,(pdt->time).sec));
3140   1       (pfdi->CTime)[0]=(UINT8)time;
3141   1       (pfdi->CTime)[1]=(UINT8)(time>>8);
3142   1       //=======================ÌîÈë´´½¨Ê±¼ä================
3143   1      
3144   1       date=(UINT16)(MAKE_DATE((pdt->date).year,(pdt->date).month,(pdt->date).day));
3145   1       (pfdi->CDate)[0]=(UINT8)date;
3146   1       (pfdi->CDate)[1]=(UINT8)(date>>8);
3147   1       //=======================ÌîÈë´´½¨ÈÕÆÚ================
3148   1      
3149   1       (pfdi->ADate)[0]=(UINT8)date;
3150   1       (pfdi->ADate)[1]=(UINT8)(date>>8);
3151   1       //=======================ÌîÈë·ÃÎÊÈÕÆÚ================
3152   1       
3153   1       (pfdi->MTime)[0]=(UINT8)time;
3154   1       (pfdi->MTime)[1]=(UINT8)(time>>8);
3155   1       //=======================ÌîÈëĞŞ¸ÄÊ±¼ä================ 
3156   1      
3157   1       (pfdi->MDate)[0]=(UINT8)date;
3158   1       (pfdi->MDate)[1]=(UINT8)(date>>8);
3159   1       //=======================ÌîÈëĞŞ¸ÄÈÕÆÚ================
3160   1      
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 53  

3161   1       //Ìî³ä¿ªÊ¼´Ø
3162   1       if(!is_file) //Èç¹ûÊÇÄ¿Â¼£¬ÔòÔÚfdiÖĞÌî³ä¿Õ´Ø
3163   1       {
3164   2        pfdi->HighClust[0]=(UINT8)(((pInit_Args->Next_Free_Cluster)>>16)&0X000000FF);//Ä¿Â¼ÓëÎÄ¼ş²»Í¬£¬Ä¿Â¼ÔÚ´´½
             -¨Ö®³õ
3165   2        pfdi->HighClust[1]=(UINT8)(((pInit_Args->Next_Free_Cluster)>>24)&0X000000FF);//¾ÍÒªÎªÆä·ÖÅä¿Õ´Ø£¬ÎªµÄÊÇĞ
             -´Èë.Óë..
3166   2        pfdi->LowClust [0]=(UINT8)(((pInit_Args->Next_Free_Cluster)    )&0X000000FF);//ÕâÁ½¸öÌØÊâµÄÎÄ¼şÄ¿Â¼Ïî
3167   2        pfdi->LowClust [1]=(UINT8)(((pInit_Args->Next_Free_Cluster)>>8 )&0X000000FF);                           
             -                                                                                                                        
             -               
3168   2       }
3169   1      
3170   1       //ÎÄ¼ş´óĞ¡×Ö¶ÎÔİÖÃÎª0
3171   1       return 0;
3172   1      }
3173          #endif
3174          
3175          /************************************************************************************
3176           ¹¦ÄÜ£ºÏò¹¹ÔìºÃµÄÎÄ¼şÄ¿Â¼Ïî×¢²áµ½Ä¿Â¼´ØÖĞÈ¥
3177           ĞÎ²Î£ºcluster:Ä¿Â¼´Ø pfdi:Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë psec:ÎÄ¼şÄ¿Â¼Ïî±»Ğ´µ½µÄÉÈÇøµØÖ· 
3178                 pn:ÎÄ¼şÄ¿Â¼ÏîÔÚÆäÉÈÇøÖĞµÄÎ»ÖÃ 
3179           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»ò´íÎóÎó
3180           Ïê½â£º´Ëº¯ÊıÊÇ´´½¨ÎÄ¼şºÍÄ¿Â¼µÄÖØÒªºËĞÄ²Ù×÷£¬ËüÊÇÕë¶Ô¶ÌÃûµÄ£¬ÓëRegister_LFN_FDIÏà¶ÔÓ¦
3181          *************************************************************************************/
3182          #ifdef REGISTER_FDI
3183          UINT8 Register_FDI(UINT32 cluster,struct FDI *pfdi,UINT32 *psec,UINT8 *pn)
3184          {
3185   1       UINT32 temp_sec=0,old_cluster=0;
3186   1       UINT8 iSec=0,iFDI=0;
3187   1       struct FDIesInSEC *pfdis;
3188   1      
3189   1       if(0==pInit_Args->Free_nCluster) return ERR_NO_SPACE; //Èç¹ûÃ»ÓĞ¿Õ¼ä£¬ÔòÖ±½Ó·µ»Ø
3190   1       
3191   1       //ÒÔÏÂ´úÂë¼ì²éÊÇ·ñÒÑ¾­´æÔÚÖØ¸´µÄÎÄ¼şÄ¿Â¼Ïî£¬ÒÔ¼°²éÑ¯¿ÕÎ»
3192   1       do
3193   1       {
3194   2        temp_sec=SOC(cluster);
3195   2        for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++)
3196   2        {
3197   3         znFAT_Device_Read_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
3198   3         pfdis=((struct FDIesInSEC *)znFAT_Buffer);
3199   3         for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++)
3200   3         {
3201   4          if(Memory_Compare((UINT8*)((pfdis->FDIes)+iFDI),(UINT8*)pfdi,11))  //±È½ÏÎÄ¼şÃû
3202   4          {
3203   5           *psec=temp_sec+(UINT32)iSec;
3204   5           *pn=iFDI; //¼ÇÂ¼ÖØÃûÎÄ¼şÄ¿Â¼ÏîµÄÎ»ÖÃ£¬ÒÔ±ã¶ÔÆä½øĞĞ½âÎö
3205   5           return ERR_FDI_ALREADY_EXISTING;
3206   5          }
3207   4          else
3208   4          {
3209   5         if(0==((((pfdis->FDIes)[iFDI]).Name)[0]))
3210   5         {
3211   6          *psec=temp_sec+(UINT32)iSec;
3212   6          *pn=iFDI; //¼ÇÂ¼¿ÕÎ»µÄÎ»ÖÃ
3213   6      
3214   6            znFAT_Device_Read_Sector(*psec,znFAT_Buffer);
3215   6            Memory_Copy((UINT8*)((((struct FDIesInSEC *)znFAT_Buffer)->FDIes)+*pn),(UINT8 *)pfdi,FDI_NBYTES);
3216   6            znFAT_Device_Write_Sector(*psec,znFAT_Buffer);
3217   6      
3218   6          return ERR_SUCC;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 54  

3219   6         }
3220   5          }
3221   4         }
3222   3        }
3223   2        old_cluster=cluster;
3224   2        cluster=Get_Next_Cluster(cluster);
3225   2       }while(!IS_END_CLU(cluster)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
3226   1       //===========================================================
3227   1       //Èç¹ûÔËĞĞµ½ÕâÀï£¬ÔòËµÃ÷µ±Ç°´ØÖĞÒÑÎŞ¿ÕÎ»
3228   1       if(0!=pInit_Args->Free_nCluster) //Èç¹ûÊ£Óà¿Õ´ØÊıÎª0£¬ÔòËµÃ÷´ÅÅÌÒÑÎŞ¿Õ¼ä
3229   1       {
3230   2        Modify_FAT(old_cluster,pInit_Args->Next_Free_Cluster);
3231   2        Modify_FAT(pInit_Args->Next_Free_Cluster,0X0FFFFFFF); //¹¹ÔìFAT´ØÁ´
3232   2        Clear_Cluster(pInit_Args->Next_Free_Cluster); //Çå¿Õ¿ÕÏĞ´Ø
3233   2      
3234   2        *psec=SOC(pInit_Args->Next_Free_Cluster);
3235   2        *pn=0; //¼ÇÂ¼¿ÕÎ»µÄÎ»ÖÃ
3236   2      
3237   2        znFAT_Device_Read_Sector(*psec,znFAT_Buffer);
3238   2        Memory_Copy((UINT8*)((((struct FDIesInSEC *)znFAT_Buffer)->FDIes)),(UINT8 *)pfdi,FDI_NBYTES);
3239   2        znFAT_Device_Write_Sector(*psec,znFAT_Buffer);
3240   2      
3241   2        Update_Next_Free_Cluster();
3242   2      
3243   2        return ERR_SUCC;  
3244   2       }
3245   1       else
3246   1       {
3247   2        return ERR_NO_SPACE;
3248   2       } 
3249   1      }
3250          #endif
3251          
3252          /************************************************************************************
3253           ¹¦ÄÜ£ºÎÄ¼ş´´½¨
3254           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏÖ¸Õë pfn:Ö¸ÏòÎÄ¼şÂ·¾¶ pdt:Ö¸ÏòÊ±¼äĞÅÏ¢
3255           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
3256           Ïê½â£º´Ëº¯Êı¿ÉÒÔÖ§³Ö¶ÌÃûÓë³¤Ãû£¬ÎŞÏŞÉî²ãÄ¿Â¼¡£ÎÄ¼ş´´½¨Íê³ÉÖ®ºó£¬ĞÂ½¨ÎÄ¼şµÄĞÅÏ¢½«±»
3257                 ×°ÈëÎÄ¼şĞÅÏ¢¼¯ºÏ£¬Ëæ¼´¿ÉÒÔ¶Ô´ËÎÄ¼ş½øĞĞ²Ù×÷£¬¶øÎŞĞè´ò´Îµ÷open_file´ò¿ªËü¡£Èç¹û
3258                 Òª´´½¨µÄÎÄ¼şÒÑ¾­ÓĞÖØÃû£¬Ôò·µ»ØÖØÃû´íÎó£¬²¢½«ÒÑ¾­´æÔÚµÄÎÄ¼şµÄĞÅÏ¢×°ÈëÎÄ¼şĞÅÏ¢
3259                 ¼¯ºÏ¡£Òò´ËËüÄ³Ğ©Çé¿öÏÂÒ²¿ÉÒÔÓÃÀ´³äµ±open_fileº¯Êı£ºÃ»ÓĞÖØÃûÎÄ¼ş¾Í´´½¨Ò»¸öĞÂµÄ£¬
3260                 Èç¹ûÓĞÖØÃûÎÄ¼şÔò´ò¿ª¡£
3261          *************************************************************************************/
3262          #ifdef ZNFAT_CREATE_FILE
3263          UINT8 znFAT_Create_File(struct FileInfo *pfi,INT8 *pfn,struct DateTime *pdt)
3264          {
3265   1       UINT32 Cur_Cluster=0,pos=0,sec=0;
3266   1       UINT8 res=0,n=0;
3267   1       struct FDI fdi;
3268   1       INT8 *filename;
3269   1      
3270   1       #ifdef USE_LFN
               UINT8 is_lfn=0;
               INT8 temp_filename[13];
               #endif
3274   1      
3275   1       just_file=pfi;
3276   1      
3277   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 55  

               Memory_Set((UINT8 *)pcccb_buf,sizeof(UINT32)*CCCB_LEN,0);
               #endif
               #endif
3284   1      
3285   1       #ifdef USE_EXCHANGE_BUFFER
               #ifdef USE_ALONE_EXB
               //Memory_Set(just_file->exb_buf,512,0);
               just_file->exb_cursec=0;
               #endif
               #endif
3291   1      
3292   1       res=znFAT_Enter_Dir(pfn,&Cur_Cluster,&pos); //½øÈëÄ¿Â¼
3293   1       if(res)
3294   1       {
3295   2        return res;
3296   2       }
3297   1      
3298   1       filename=pfn+pos;
3299   1      
3300   1       if(Check_Illegal_Char(filename)) return ERR_ILL_CHAR; //¼ì²éÎÄ¼şÃûÖĞÊÇ·ñÓĞ·Ç·¨×Ö·û
3301   1       
3302   1       #ifdef USE_LFN
               if(!Is_LFN(filename))
               {
               #endif
3306   1        //¼ì²é¶ÌÎÄ¼şÃûºÏ·¨ĞÔ£¬Èô·Ç·¨ÔòÖ±½Ó·µ»Ø£¬²»ÔÙ½øĞĞºóÃæµÄ´¦Àí(´Ë´¦¶ÔSFNµÄºÏ·¨ĞÔ¼ì²é·Ç³£ÑÏ¸ñ)
3307   1        //ÊÂÏÈ¼ì²éSFNµÄºÏ·¨ĞÔ£¬¼õÉÙºóÃæ´¦ÀíÉÏµÄÂé·³
3308   1        if(Check_SFN_Illegal_Length(filename)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
3309   1        if(Check_SFN_Dot(filename)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨ 
3310   1        if(Check_SFN_Special_Char(filename)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
3311   1        if(((UINT8)(-1))==Check_SFN_Illegal_Lower(filename)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´ó
             -Ğ¡Ğ´
3312   1       #ifdef USE_LFN
               }
               else
               {
                is_lfn=1;
                res=oemstr2unistr(filename,pfi->longname); //Èç¹ûÊÇ³¤Ãû£¬Ôò½«filename×ªÎªUNI´®
                if(res) return res;
               }
              
               if(!is_lfn) //Èç¹û²»ÊÇ³¤Ãû
               {
               #endif
3324   1        Fill_FDI(&fdi,filename,pdt,BOOL_TRUE); //¹¹ÔìÎÄ¼şÄ¿Â¼Ïî
3325   1        res=Register_FDI(Cur_Cluster,&fdi,&sec,&n);//ÔÚµ±Ç°´ØÖĞ½øĞĞÎÄ¼şÄ¿Â¼ÏîµÄ"×¢²á"
3326   1      
3327   1       #ifdef USE_LFN
               }
               else //Èç¹ûÊÇ³¤Ãû
               {
                Make_Short_Name(filename,temp_filename);
                Fill_FDI(&fdi,temp_filename,pdt,BOOL_TRUE); //¹¹ÔìÎÄ¼şÄ¿Â¼Ïî
                res=Register_LFN_FDI(Cur_Cluster,&fdi,(pfi->longname),&sec,&n); //ÔÚµ±Ç°´ØÖĞ½øĞĞ³¤ÃûÏî¼°ÏàÓ¦¶ÌÃûÏî¡°×¢²á
             -¡±
               }
               #endif
3336   1       
3337   1       if(!res)
3338   1       {
3339   2        //½«ĞÂ½¨ÎÄ¼şµÄĞÅÏ¢×°ÈëÎÄ¼şĞÅÏ¢¼¯ºÏ
3340   2        #ifdef USE_LFN
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 56  

                if(is_lfn)
                {
                 StringCopy(pfi->File_Name,temp_filename);
                 pfi->have_lfn=1;
                }
                else
                #endif
3348   2        {
3349   3         StringCopy(pfi->File_Name,filename);
3350   3        }
3351   2        pfi->File_Attr=0X20;
3352   2        (pfi->File_CTime).hour=(pdt->time).hour;
3353   2        (pfi->File_CTime).min=(pdt->time).min;
3354   2        (pfi->File_CTime).sec=(pdt->time).sec;
3355   2        (pfi->File_CDate).year=(pdt->date).year;
3356   2        (pfi->File_CDate).month=(pdt->date).month;
3357   2        (pfi->File_CDate).day=(pdt->date).day;
3358   2        //(pfi->File_ADate).year=(pdt->date).year;
3359   2        //(pfi->File_ADate).month=(pdt->date).month;
3360   2        //(pfi->File_ADate).day=(pdt->date).day;
3361   2        //(pfi->File_MTime).hour=(pdt->time).hour;
3362   2        //(pfi->File_MTime).min=(pdt->time).min;
3363   2        //(pfi->File_MTime).sec=(pdt->time).sec;
3364   2        //(pfi->File_MDate).year=(pdt->date).year;
3365   2        //(pfi->File_MDate).month=(pdt->date).month;
3366   2        //(pfi->File_MDate).day=(pdt->date).day;
3367   2      
3368   2        pfi->File_StartClust=0;
3369   2        pfi->File_Size=0;
3370   2      
3371   2        pfi->File_CurClust=0;
3372   2        pfi->File_CurSec=0;
3373   2        pfi->File_CurPos=0;
3374   2      
3375   2        pfi->File_CurOffset=0;
3376   2        pfi->File_IsEOF=BOOL_TRUE;
3377   2      
3378   2        pfi->FDI_Sec=sec;
3379   2        pfi->nFDI=n;
3380   2      
3381   2        return ERR_SUCC;
3382   2       }
3383   1       else
3384   1       {
3385   2        if(res==ERR_FDI_ALREADY_EXISTING) //Èç¹ûÎÄ¼şÒÑ¾­´æÔÚ£¬ÔòÖ±½Ó½âÎöËü
3386   2        {
3387   3         znFAT_Device_Read_Sector(sec,znFAT_Buffer); //Èç¹ûÖØÃûÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
3388   3         Analyse_FDI(pfi,(((struct FDIesInSEC *)znFAT_Buffer)->FDIes)+n); //½âÎöÆ¥ÅäµÄÎÄ¼şÄ¿Â¼Ïî
3389   3         pfi->FDI_Sec=sec;
3390   3         pfi->nFDI=n;
3391   3         
3392   3         #ifdef USE_LFN
                 if(is_lfn)
                 {
                  pfi->have_lfn=1;
                 }
                 else
                 {
                  pfi->have_lfn=0;
                 }
                 #endif 
3402   3        }
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 57  

3403   2        return res;
3404   2       }
3405   1      }
3406          #endif
3407          
3408          /************************************************************************************
3409           ¹¦ÄÜ£ºÔÚÒ»¸öÄ¿Â¼ÖĞ´´½¨Ò»¸öÄ¿Â¼
3410           ĞÎ²Î£ºcluster:Ä¿Â¼´Ø pdn:Ö¸ÏòÄ¿Â¼Ãû pdt:Ö¸ÏòÊ±¼äĞÅÏ¢
3411           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
3412           Ïê½â£ºÖ§³Ö³¤Ä¿Â¼Ãû´´½¨ cluster×îÖÕ»á·µ»ØĞÂ´´½¨µÄÄ¿Â¼µÄ¿ªÊ¼´Ø
3413                 ´Ëº¯ÊıÊÇznFATÊµÏÖ¶à¼¶Ä¿Â¼´´½¨µÄÖØÒªº¯Êı
3414          *************************************************************************************/
3415          #ifdef CREATE_DIR_IN_CLUSTER
              UINT8 Create_Dir_In_Cluster(UINT32 *cluster,INT8 *pdn,struct DateTime *pdt)
              {
               UINT8 res=0,i=0;
               UINT32 dummy=0;
               struct FDI fdi;
              
               #ifdef USE_LFN
               UINT8 is_lfn=0; //±ê¼ÇÊäÈëµÄÄ¿Â¼ÃûÊÇ·ñ³¤Ãû
               UINT16 temp_lfn_buf[MAX_LFN_LEN+1]; //ÓÃÓÚ×°ÔØ³¤ÃûUNI´®µÄÁÙÊ±»º³å
               INT8 temp_dirname[13];
               #endif
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #endif
              
               if(Check_Illegal_Char(pdn)) return ERR_ILL_CHAR; //¼ì²éÄ¿Â¼ÃûÖĞÊÇ·ñÓĞ·Ç·¨×Ö·û
               
               #ifdef USE_LFN
               if(!Is_LFN(pdn))
               {
               #endif
                //¼ì²é¶ÌÎÄ¼şÃûºÏ·¨ĞÔ£¬Èô·Ç·¨ÔòÖ±½Ó·µ»Ø£¬²»ÔÙ½øĞĞºóÃæµÄ´¦Àí(´Ë´¦¶ÔSFNµÄºÏ·¨ĞÔ¼ì²é·Ç³£ÑÏ¸ñ)
                //ÊÂÏÈ¼ì²éSFNµÄºÏ·¨ĞÔ£¬¼õÉÙºóÃæ´¦ÀíÉÏµÄÂé·³
                if(Check_SFN_Illegal_Length(pdn)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
                if(Check_SFN_Dot(pdn)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨ 
                if(Check_SFN_Special_Char(pdn)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
                if(((UINT8)(-1))==Check_SFN_Illegal_Lower(pdn)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´óĞ¡Ğ´
               #ifdef USE_LFN
               }
               else
               {
                is_lfn=1;
                res=oemstr2unistr(pdn,temp_lfn_buf); //Èç¹ûÊÇ³¤Ãû£¬Ôò½«pdn×ªÎªUNI´®
                if(res) return res;
               }
              
               if(!is_lfn) //Èç¹û²»ÊÇ³¤Ãû
               {
               #endif
                Fill_FDI(&fdi,pdn,pdt,BOOL_FALSE); //¹¹ÔìÄ¿Â¼Ïî
                res=Register_FDI(*cluster,&fdi,&dummy,&i);//ÔÚµ±Ç°´ØÖĞ½øĞĞÎÄ¼şÄ¿Â¼ÏîµÄ"×¢²á"
              
               #ifdef USE_LFN
               }
               else //Èç¹ûÊÇ³¤Ãû
               {
                Make_Short_Name(pdn,temp_dirname);
                Fill_FDI(&fdi,temp_dirname,pdt,BOOL_FALSE); //¹¹ÔìÎÄ¼şÄ¿Â¼Ïî
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 58  

                res=Register_LFN_FDI(*cluster,&fdi,temp_lfn_buf,&dummy,&i); //ÔÚµ±Ç°´ØÖĞ½øĞĞ³¤ÃûÏî¼°ÏàÓ¦¶ÌÃûÏî¡°×¢²á¡±
               }
               #endif
              
               if(res)
               {
                return res;
               }
              
               //====================================================================================
              
               //ÏòÄ¿Â¼´ØÖĞĞ´Èë.Óë..
               Modify_FAT(pInit_Args->Next_Free_Cluster,0X0FFFFFFF); //¹¹ÔìFAT´ØÁ´
               Clear_Cluster(pInit_Args->Next_Free_Cluster); //Çå¿Õ¿ÕÏĞ´Ø 
              
               //°ÑfdiÖĞµÄÃû×ÖÌæ»»Îª. ÃûÎª.µÄÄ¿Â¼Ö¸ÏòÁËÏàÇ°´Ø
               fdi.Name[0]='.';
               for(i=1;i<11;i++)
               {
                fdi.Name[i]=' '; //.ºóÃæÈ«²¿Ìî³ä¿Õ¸ñ
               }
              
               Memory_Copy(znFAT_Buffer,((UINT8 *)(&fdi)),FDI_NBYTES); //½«ÎÄ¼şÄ¿Â¼Ïî.×°Èëµ½ÄÚ²¿»º³åÇøÖĞ
              
               //°ÑfdiÖĞµÄÃû×ÖÌæ»»Îª.. ÃûÎª..µÄÄ¿Â¼Ö¸ÏòÁËÉÏÒ»´Ø(DOSÖĞÊ¹ÓÃCD..¿ÉÒÔ»Øµ½ÉÏÒ»¼¶Ä¿Â¼¾ÍÊÇÕâ¸öµÀÀí)
               fdi.Name[1]='.';
               
               //°ÑfdiÖĞµÄ´ØÖµ¸ÄÎªÉÏÒ»¼¶Ä¿Â¼µÄÊ×´Ø 
               if(2!=(*cluster)) //Èç¹ûÉÏÒ»¼¶Ä¿Â¼Ê×´Ø²»ÊÇ"¸ùÄ¿Â¼"(Ê×Ä¿Â¼)
               {
                fdi.HighClust[0]=(UINT8)(((*cluster)>>16)&0X000000FF);
                fdi.HighClust[1]=(UINT8)(((*cluster)>>24)&0X000000FF);
                fdi.LowClust [0]=(UINT8)(((*cluster)    )&0X000000FF);
                fdi.LowClust [1]=(UINT8)(((*cluster)>>8 )&0X000000FF); 
               }
               else
               {
                fdi.HighClust[0]=fdi.HighClust[1]=fdi.LowClust[0]=fdi.LowClust[1]=0;
               }
              
               Memory_Copy(znFAT_Buffer+FDI_NBYTES,((UINT8 *)(&fdi)),FDI_NBYTES); //½«ÎÄ¼şÄ¿Â¼Ïî..×°Èëµ½ÄÚ²¿»º³åÇøÖĞ
              
               znFAT_Device_Write_Sector(SOC(pInit_Args->Next_Free_Cluster),znFAT_Buffer);
              
               *cluster=(pInit_Args->Next_Free_Cluster); //·µ»ØĞÂ´´½¨µÄÄ¿Â¼Ê×´Ø
              
               Update_Next_Free_Cluster();
              
               return ERR_SUCC;
              }
              #endif
3516          
3517          /************************************************************************************
3518           ¹¦ÄÜ£º´´½¨Ä¿Â¼
3519           ĞÎ²Î£ºpdp:Ö¸ÏòÄ¿Â¼Â·¾¶ pdt:Ö¸ÏòÊ±¼äĞÅÏ¢ 
3520           ·µ»Ø£ºÔËĞĞ½á¹û  ³É¹¦»ò´íÎóÂë
3521           Ïê½â£ºÖ§³ÖÎŞÏŞÉîÄ¿Â¼´´½¨ Èç Ä¿Â¼Â·¾¶¿ÉÒÔÊÇ /a/b/c/d/e/f/g/h/ ×¢Òâ×îÖÕÒ»¶¨ÒªÒÔ/»ò"\\"
3522                 ½áÊø¡£·ñÔòznFAT»áÈÏÎª×îºóÒ»¼¶Ä¿Â¼ÃûÊÇÎÄ¼şÃû£¬¶ø²»ÓèÒÔ´´½¨¡£Ö§³Ö³¤Ä¿Â¼Ãû
3523          *************************************************************************************/
3524          #ifdef ZNFAT_CREATE_DIR
              UINT8 znFAT_Create_Dir(INT8 *pdp,struct DateTime *pdt)
              {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 59  

               UINT32 Cur_Cluster=0,i=0;
               UINT8 index=0,res=0;
              
               #ifndef USE_LFN
               UINT8 dirname[13];
               #else
               UINT8 dirname[MAX_LFN_LEN+1];
               #endif
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #endif
              
               if(znFAT_Enter_Dir(pdp,&Cur_Cluster,&i)) //½øÈëÄ¿Â¼£¬Èç¹ûÖĞÍ¾·¢Éú´íÎó
               {                                        //±ÈÈçÄ³Ò»¼¶Ä¿Â¼Ãû²»ºÏ·¨£¬»ò
                while('\0'!=pdp[i])                     //Ä¿Â¼²»´æÔÚ£¬Ôò½«×î½üµÄÒ»²ã
                {                                       //Ä¿Â¼µÄÊ×´Ø¼ÇÂ¼ÔÚCur_ClusterÀï
                 if('\\'==pdp[i] || '/'==pdp[i])                       //¶ø½«Ê§°ÜµÄÄÇÒ»¼¶Ä¿Â¼ÃûµÄµÚÒ»
                 {                                      //×Ö·ûµÄÎ»ÖÃ¼ÇÂ¼ÔÚiÖĞ
                  dirname[index]='\0';                  //±ÈÈç\a1\b2\c3\e4\f5\£¬Ä¿Â¼c3²»´æÔÚ
                  index=0;                              //ÔòCur_ClusterÎªÄ¿Â¼b2µÄÊ×´Ø£¬i¼ÇÂ¼µÄÊÇ'c'µÄÎ»ÖÃ¼´7
                 
                  res=Create_Dir_In_Cluster(&Cur_Cluster,(INT8 *)dirname,pdt); //ÔÚ´ØCur_ClusterÖĞ´´½¨Ä¿Â¼
                  if(res) 
                  { 
                 return res;  //·µ»Ø´íÎóÂë  
                  }
                 }
                 else
                 {
                  dirname[index]=pdp[i];
                  index++;
                  #ifndef USE_LFN
                  if(index>12) //Èç¹û²»Ê¹ÓÃ³¤Ãû£¬ÔòÄ¿Â¼ÃûÒÔ¼°ÎÄ¼şÃû×î³¤²»ÄÜ³¬¹ı8+1+3
                  {
                 return ERR_SFN_ILL_LEN; //Ä¿Â¼Ãû³¤ÓÚ8.3£¬Òà·ÀÖ¹dirnameÒç³ö
                  }
                  #else
                  if(index>MAX_LFN_LEN) //Èç¹ûÊ¹ÓÃ³¤Ãû£¬ÔòÄ¿Â¼ÃûÒÔ¼°ÎÄ¼şÃû×î³¤²»ÄÜ³¬¹ıÉè¶¨µÄ³¤Ãû×î³¤³¤¶È
                  {
                 return ERR_LFN_BUF_OUT; //Ä¿Â¼Ãû³¤ÓÚMAX_LFN_LEN£¬Òà·ÀÖ¹dirnameÒç³ö
                  }   
                  #endif
                 }
                 i++;
                }
                
                return ERR_SUCC; //³É¹¦  
               }
               else
               {
                return ERR_DIR_ALREADY_EXISTING; //Òª´´½¨µÄÄ¿Â¼ÒÑ¾­´æÔÚÁË
               }
              }
              #endif
3582          
3583          //========================ÒÔÏÂ´úÂë³¢ÊÔÊµÏÖÄ¿Â¼É¾³ı¹¦ÄÜ=====================
3584          
3585          /************************************************************************************
3586           ¹¦ÄÜ£ºÏú»ÙÒ»¸öFAT´ØÁ´
3587           ĞÎ²Î£ºcluster:´ØÁ´µÄ¿ªÊ¼´ØºÅ
3588           ·µ»Ø£º0
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 60  

3589           Ïê½â£ºÕñÄÏÔ­À´Ê¹ÓÃModify_FAT+Ñ­»·À´ÊµÏÖ´Ëº¯Êı£¬Ğ§ÂÊ¼«µÍ£¬ËÙ¶ÈºÜÂı£¬ÏÖÔÚ½øĞĞÁË¸Ä½ø£¬
3590                 Ğ§ÂÊ½Ï¸ß¡£
3591          *************************************************************************************/
3592          #ifdef DESTROY_FAT_CHAIN
              UINT8 Destroy_FAT_Chain(UINT32 cluster)
              {
               UINT32 clu_sec=0,temp1=0,temp2=0,old_clu=0,nclu=1;
              
               struct FAT_Sec *pFAT_Sec;
              
               if(cluster<(pInit_Args->Next_Free_Cluster)) //Èç¹ûÒªÏú»ÙµÄ´ØÁ´Í·´Ø±ÈÏÂÒ»¿Õ´ØÖµĞ¡£¬Ôò½«ÏÂÒ»¿Õ´ØÖµÖÃÎªËü
               {
                pInit_Args->Next_Free_Cluster=cluster;
               }
              
               old_clu=cluster;
              
               znFAT_Device_Read_Sector((old_clu/NITEMSINFATSEC)+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
               pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer;
              
               cluster=Bytes2Value(((pFAT_Sec->items)[cluster%NITEMSINFATSEC]).Item,4);
              
               while(!IS_END_CLU(cluster))
               {
                nclu++;
              
                clu_sec=cluster/NITEMSINFATSEC;
              
                temp1=old_clu%NITEMSINFATSEC;
                temp2=old_clu/NITEMSINFATSEC;
              
                ((pFAT_Sec->items)[temp1]).Item[0]=0;
                ((pFAT_Sec->items)[temp1]).Item[1]=0;
                ((pFAT_Sec->items)[temp1]).Item[2]=0;
                ((pFAT_Sec->items)[temp1]).Item[3]=0;
              
                if(temp2!=clu_sec)
                {     
                 znFAT_Device_Write_Sector(temp2+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 znFAT_Device_Write_Sector(temp2+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
              
                 znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                }
              
                old_clu=cluster;
                cluster=Bytes2Value(((pFAT_Sec->items)[cluster%NITEMSINFATSEC]).Item,4);
               }
              
               temp1=old_clu%NITEMSINFATSEC;
               temp2=old_clu/NITEMSINFATSEC;
              
               ((pFAT_Sec->items)[temp1]).Item[0]=0;
               ((pFAT_Sec->items)[temp1]).Item[1]=0;
               ((pFAT_Sec->items)[temp1]).Item[2]=0;
               ((pFAT_Sec->items)[temp1]).Item[3]=0;
              
               znFAT_Device_Write_Sector(temp2+(pInit_Args->FirstFATSector),znFAT_Buffer);
               znFAT_Device_Write_Sector(temp2+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
              
               pInit_Args->Free_nCluster+=nclu; //¸üĞÂÊ£Óà¿Õ´ØÊı
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 61  

               return ERR_SUCC;
              }
              #endif
3654          
3655          /************************************************************************************
3656           ¹¦ÄÜ£ºÏú»ÙÒ»¸öÎÄ¼şÄ¿Â¼ÏîËù¶ÔÓ¦µÄÕûÌõ´ØÁ´
3657           ĞÎ²Î£ºpitem:Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë
3658           ·µ»Ø£º0
3659           Ïê½â£ºÖ÷ÒªÊÇÓÃÓÚÎÄ¼şºÍÄ¿Â¼µÄÉ¾³ı
3660          *************************************************************************************/
3661          #ifdef DESTROY_FDI
              UINT8 Destroy_FDI(struct FDI *pitem)
              {
               UINT32 start_cluster=Bytes2Value(pitem->LowClust,2)+Bytes2Value(pitem->HighClust,2)*65536;
              
               if(0==start_cluster) return ERR_SUCC;
              
               Destroy_FAT_Chain(start_cluster); //Ïú»Ù´ØÁ´
              
               return ERR_SUCC;
              } 
              #endif
3673          
3674          /************************************************************************************
3675           ¹¦ÄÜ£º¶ÔÄ³¸öÄ¿Â¼´Ø½øĞĞËÑË÷£¬¿´ÆäÖĞÊÇ·ñÓĞÄ¿Â¼Ïî£¬¼´¸ÃÄ¿Â¼ÏÂÓĞ×ÓÄ¿Â¼£¬ËÑË÷¹ı³ÌÖĞÓöµ½µÄ
3676                 ÎÄ¼şÏî½«È«²¿Ïú»Ù¡£
3677           ĞÎ²Î£ºcluster:Òª½øĞĞËÑË÷µÄÄ¿Â¼¿ªÊ¼´ØºÅ 
3678                 for_del_dir:ÔÚÓöµ½Ä¿Â¼ÏîÖ®ºó£¬ÊÇ·µ»ØÆä¿ªÊ¼´Ø£¬»¹ÊÇ½«ÆäÖ±½ÓÏú»Ù
3679           ·µ»Ø£ºÔËĞĞ½á¹û ÕÒµ½×ÓÄ¿Â¼»òÎ´ÕÒµ½ ×¢£ºÈç¹ûÔÚÄ¿Â¼ÖĞÎ´ÕÒµ½×ÓÄ¿Â¼£¬Ôò´ËÄ¿Â¼ÖĞµÄËùÓĞÎÄ¼ş
3680                 ½«±»È«²¿Ïú»Ù£¬ÔÚÕâÖÖÇé¿öÏÂ£¬Õâ¸öÄ¿Â¼Ëæ¼´Ò²»á±»Ïú»Ù£¬È»ºó½øĞĞÄ¿Â¼»ØËİ.....
3681           Ïê½â£ºÄ¿Â¼É¾³ıµÄÏà¹ØËã·¨¾ù½ÏÎª¸´ÔÓ£¬µ«Èç¹ûÁìÎò£¬Ôò»á¾õµÃ±È½Ï¼òµ¥¡£Ä¿Â¼ÒòÎªÓĞ×ÓÄ¿Â¼
3682                 ¶øÇÒÊÇÒ»ÖÖÊ÷ĞÎµÄ½á¹¹£¬Òò´ËÉ¾³ıÄ¿Â¼µÄ¹ı³ÌÆäÊµÊÇÒ»¸ö¡°µİ¹é»ØËİ¡±µÄ¹ı³Ì£¬Ö±µ½»Øµ½
3683                 ¶¥²ãÄ¿Â¼¡£
3684          *************************************************************************************/
3685          #ifdef HAVE_ANY_SUBDIR_WITH_DEL_FOREFILE
              UINT8 Have_Any_SubDir_With_Del_ForeFile(UINT32 *cluster,UINT8 for_del_dir)
              {
               UINT8 iSec=0,iFDI=0;
               UINT32 sec_temp=0;
               UINT32 temp=*cluster;
              
               struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
               struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #endif
              
               do
               {
                sec_temp=SOC(temp); //µ±Ç°´ØÊ×ÉÈÇø
                for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++) 
                {
                 znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer);
                 pitems=(struct FDIesInSEC *)znFAT_Buffer; 
              
                 for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++) //·ÃÎÊÉÈÇøÖĞ¸÷ÎÄ¼şÄ¿Â¼Ïî
                 {
                  pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
              
                if((CHK_ATTR_FILE(pitem->Attributes)) && (0XE5!=pitem->Name[0])) //ÎÄ¼şÊôĞÔÎªÎÄ¼ş£¬ÇÒÃ»ÓĞ±»É¾³ı
                  {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 62  

                   Destroy_FDI(pitem); //Ïú»ÙÎÄ¼şÄ¿Â¼Ïî¼°Æä¶ÔÓ¦µÄ´ØÁ´ ×¢£ºÄÚ²¿»º³åÇøÊı¾İ±»±ä¸ü
                 znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer); //ÖØĞÂ¶ÁÈ¡ÉÈÇøÊı¾İ£¬»Ö¸´ÄÚ²¿»º³åÇøµÄÊı¾İ
              
                 pitem->Name[0]=0XE5; //¸øÎÄ¼şÄ¿Â¼Ïî´òÉÏ"ÒÑÉ¾³ı"µÄ±ê¼Ç
                   pitem->HighClust[0]=pitem->HighClust[1]=0; //¿ªÊ¼´ØµÄ¸ß×ÖÇå0
              
                   znFAT_Device_Write_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer); //Èç¹ûÓĞÏú»Ù²Ù×÷£¬Ôò»ØĞ´ÉÈÇø
                }
              
                  if((CHK_ATTR_DIR(pitem->Attributes)) && (0XE5!=pitem->Name[0]) //ÎÄ¼şÊôĞÔÎªÄ¿Â¼£¬ÇÒÃ»ÓĞ±»É¾³ı
                   && ('.'!=pitem->Name[0]))                          //²»ÊÇ.Óë..
                  { 
                 if(!for_del_dir) //²»ÊÇÎªÁË°Ñ×ÓÄ¿Â¼±¾ÉíÉ¾³ı£¬¶øÊÇÎªÁË»ñÈ¡ÆäÊ×´Ø£¬½ø¶ø½øÈë¸üÉî×ÓÄ¿Â¼
                 {
                  *cluster=Bytes2Value(pitem->LowClust,2)+Bytes2Value(pitem->HighClust,2)*65536;
                 }
                   else
                 {
                    Destroy_FDI(pitem); //Ïú»ÙÎÄ¼şÄ¿Â¼Ïî¼°Æä¶ÔÓ¦µÄ´ØÁ´ ×¢£ºÄÚ²¿»º³åÇøÊı¾İ±»±ä¸ü
                  znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer); //ÖØĞÂ¶ÁÈ¡ÉÈÇøÊı¾İ£¬»Ö¸´ÄÚ²¿»º³åÇøµÄÊı¾İ
              
                  pitem->Name[0]=0XE5; //¸øÎÄ¼şÄ¿Â¼Ïî´òÉÏ"ÒÑÉ¾³ı"µÄ±ê¼Ç
                    pitem->HighClust[0]=pitem->HighClust[1]=0; //¿ªÊ¼´ØµÄ¸ß×ÖÇå0
              
                    znFAT_Device_Write_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer); //Èç¹ûÓĞÏú»Ù²Ù×÷£¬Ôò»ØĞ´ÉÈÇø 
                 }
                   return BOOL_TRUE;
                  }
                 }
                }
              
                temp=Get_Next_Cluster(temp); //»ñÈ¡ÏÂÒ»´Ø
               }while(!IS_END_CLU(temp)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
                
               return BOOL_FALSE;
              }
              #endif
3750          
3751          /************************************************************************************
3752           ¹¦ÄÜ£º½øÈë´ÓÄ³¸öÄ¿Â¼¿ªÊ¼µÄ×îÉî×î¡°×ó¡±µÄÄ¿Â¼
3753           ĞÎ²Î£ºcluster:Ö¸ÏòÄ¿Â¼´ØµÄÖ¸Õë
3754           ·µ»Ø£º0
3755           Ïê½â£º´Ëº¯ÊıÊÇÄ¿Â¼É¾³ı¹¦ÄÜµÄÒ»¸ö»ù±¾¶ø¹Ø¼üµÄ²Ù×÷¡£ËüÓÃÀ´½øÈëµ½¡°×îÉî×î×ó¡±µÄÄ¿Â¼£¬
3756                 Í¬Ê±ÔÚ´Ë¹ı³ÌÖĞ£¬É¾³ı¡°×î×ó¡±Ä¿Â¼¡°×ó±ß¡±µÄËùÓĞÎÄ¼ş¡££¨´Ëº¯ÊıµÄË¼Ïë½ÏÎª³éÏó£©
3757          *************************************************************************************/
3758          #ifdef ENTER_DEEP_AHEAD_DIR
              UINT8 Enter_Deep_Ahead_Dir(UINT32 *cluster)
              {
               UINT32 dir_cluster=*cluster; 
              
               while(Have_Any_SubDir_With_Del_ForeFile(&dir_cluster,BOOL_FALSE));
              
               *cluster=dir_cluster;
              
               return ERR_SUCC;
              }
              #endif
3770          
3771          /************************************************************************************
3772           ¹¦ÄÜ£º»ñÈ¡Ò»¸öÄ¿Â¼µÄÉÏÒ»¼¶Ä¿Â¼¿ªÊ¼´Ø
3773           ĞÎ²Î£ºcluster:Ä¿Â¼µÄ¿ªÊ¼´Ø£¬Í¬Ê±ÓÖÓÃÓÚ½ÓÊÕ¼ÆËãµÃµ½µÄÉÏÒ»¼¶Ä¿Â¼µÄ¿ªÊ¼´Ø
3774           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë 
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 63  

3775           Ïê½â£ºÔÚÄ¿Â¼µÄ×îÍ·ÉÏ£¬ÓĞ.Óë..£¬ÔÚ..ÖĞ¼ÇÂ¼ÁËÉÏÒ»²ãÄ¿Â¼µÄ¿ªÊ¼´Ø£¬´Ëº¯Êı¾ÍÊÇ»ùÓÚÕâÒ»µã
3776                 À´»ñÈ¡Ä¿Â¼ÉÏÒ»¼¶Ä¿Â¼¿ªÊ¼´ØµÄ¡£
3777          *************************************************************************************/
3778          #ifdef GET_UPPER_DIR
              UINT8 Get_Upper_Dir(UINT32 *cluster)
              {
               struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
               struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
              
               znFAT_Device_Read_Sector(SOC(*cluster),znFAT_Buffer);
               pitems=(struct FDIesInSEC *)znFAT_Buffer; 
                 
               pitem=&(pitems->FDIes[1]); //Ö¸Ïò..ÎÄ¼şÄ¿Â¼Ïî£¬ÓÃÒÔ»ñÈ¡ÉÏÒ»¼¶Ä¿Â¼µÄÊ×´Ø
              
               if('.'==pitem->Name[0] && '.'==pitem->Name[1])
                *cluster=Bytes2Value(pitem->LowClust,2)+Bytes2Value(pitem->HighClust,2)*65536;
               else
                return ERR_FS_DIR; //Èç¹ûÔÚÄ¿Â¼µÄ×îÍ·ÉÏ²»ÊÇ.Óë..£¬ÔòËµÃ÷ÎÄ¼şÏµÍ³ÒÑ±»Ëğ»µ
               
               if(0==(*cluster)) (*cluster)=2; //Èç¹ûÉÏÒ»¼¶Ä¿Â¼Îª¸ùÄ¿Â¼(Ê×Ä¿Â¼)£¬½«´ØÖµÖÃÎª2
              
               return ERR_SUCC;
              }
              #endif
3799          
3800          /************************************************************************************
3801           ¹¦ÄÜ£ºÉ¾³ıÄ¿Â¼
3802           ĞÎ²Î£ºdirpath:Ö¸ÕëÏòÄ¿Â¼Â·¾¶ Ä¿Â¼ÃûÖ§³ÖÍ¨Åä
3803           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
3804           Ïê½â£ºdirpathÈç\a\b\c£¬É¾³ıÄ¿Â¼c£¬×îºó²»ÒªÒÔ\½áÊø¡£É¾³ıÄ¿Â¼½«»áÉ¾³ıÄ¿Â¼ÏÂµÄËùÓĞ×ÓÄ¿Â¼
3805                 ÓëÎÄ¼ş£¬×ÓÄ¿Â¼ÏÂ¿ÉÒÔÔÙÓĞ×ÓÄ¿Â¼ÓëÎÄ¼ş£¬ÒÀ´Îµİ¹é¡£dirpathÒ²¿ÉÒÔÎª/a/b/c* £¬Ëü½«
3806                 É¾³ıbÄ¿Â¼ÏÂËùÓĞÒÔc´òÍ·µÄÄ¿Â¼¡£
3807          *************************************************************************************/
3808          #ifdef ZNFAT_DELETE_DIR
              UINT8 znFAT_Delete_Dir(INT8 *dirpath) 
              {
               UINT32 top_dir_first_cluster=0,sub_dir_first_cluster=0;
               UINT8 res=0;
              
               struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
              
               struct FileInfo fi;
              
               res=znFAT_Open_File(&fi,dirpath,0,BOOL_FALSE); //³¢ÊÔ´ò¿ªÄ¿Â¼
              
               if(res) return res; //Èç¹û´ò¿ªÄ¿Â¼Ê§°Ü£¬ÔòÖ±½Ó·µ»Ø´íÎóÂë
              
               while(!res) //Ä¿Â¼´ò¿ª³É¹¦
               {
                top_dir_first_cluster=fi.File_StartClust; //¶¥²ãÄ¿Â¼µÄÊ×´Ø
                sub_dir_first_cluster=top_dir_first_cluster;
              
                //ÒÔÏÂ´úÂë½«¶¥¼¶Ä¿Â¼ÏÂËùÓĞÄÚÈİ(ÎÄ¼ş¡¢×ÓÄ¿Â¼¼°×ÓÄ¿Â¼ÖĞµÄÄÚÈİ£¬º¬µİ¹é)Ïú»Ù
              
                Enter_Deep_Ahead_Dir(&sub_dir_first_cluster); //»ñÈ¡×îÉî×î¿¿Ç°µÄÄ¿Â¼Ê×´Ø
              
                while(sub_dir_first_cluster!=top_dir_first_cluster) //Èç¹û×îÉî×î¿¿Ç°Ä¿Â¼Ê×´Ø¾ÍÊÇÒªÉ¾³ıµÄ¶¥¼¶Ä¿Â¼
                {                                                   //ÔòËµÃ÷¶¥¼¶Ä¿Â¼ÏÂµÄËùÓĞÄÚÈİ¶¼ÒÑ¾­Çå¿Õ
                 Get_Upper_Dir(&sub_dir_first_cluster); //»ñÈ¡ÉÏÒ»²ãÄ¿Â¼Ê×´Ø 
                 
                 Have_Any_SubDir_With_Del_ForeFile(&sub_dir_first_cluster,BOOL_TRUE); //°ÑÒÑÇå¿ÕÆäÄÚÈİµÄ×ÓÄ¿Â¼Ïú»Ù 
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 64  

                 Enter_Deep_Ahead_Dir(&sub_dir_first_cluster); //»ñÈ¡×îÉî×î¿¿Ç°µÄÄ¿Â¼Ê×´Ø
                }  
              
                //Ïú»Ù¶¥¼¶Ä¿Â¼¶ÔÓ¦µÄÎÄ¼şÄ¿Â¼Ïî¼°Æä´ØÁ´
              
                znFAT_Device_Read_Sector(fi.FDI_Sec,znFAT_Buffer); //¶ÁÈ¡ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
                pitems=(struct FDIesInSEC *)znFAT_Buffer;
              
                Destroy_FDI((pitems->FDIes)+fi.nFDI); //Ïú»Ù¶¥¼¶Ä¿Â¼
              
                znFAT_Device_Read_Sector(fi.FDI_Sec,znFAT_Buffer); //¶ÁÈ¡ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
                (pitems->FDIes)[fi.nFDI].Name[0]=0XE5;
                (pitems->FDIes)[fi.nFDI].HighClust[0]=(pitems->FDIes)[fi.nFDI].HighClust[1]=0;
              
                znFAT_Device_Write_Sector(fi.FDI_Sec,znFAT_Buffer); //»ØĞ´ÉÈÇø
              
                res=znFAT_Open_File(&fi,dirpath,0,BOOL_FALSE); //³¢ÊÔ´ò¿ªÄ¿Â¼
               }
               
               znFAT_Close_File(&fi);
              
               #ifdef RT_UPDATE_FSINFO
               Update_FSINFO();
               #endif
              
               return ERR_SUCC; 
              }
              #endif
3865          
3866          //========================ÒÔÉÏ´úÂëÓÃÓÚÊµÏÖÄ¿Â¼É¾³ı¹¦ÄÜ====================
3867          
3868          /************************************************************************************
3869           ¹¦ÄÜ£ºÎÄ¼şÉ¾³ı
3870           ĞÎ²Î£ºfilepath:ÎÄ¼şÂ·¾¶ 
3871           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
3872           Ïê½â£ºÉ¾³ıÎÄ¼ş±ÈÉ¾³ıÄ¿Â¼Òª¼òµ¥µÄ¶à¡£filepathÈç\a\b\test.txt£¬É¾³ıÎÄ¼ştest.txt
3873                 ÔËĞĞÍ¨Åä£¬filepath¿ÉÒÔÎª/a/b/c/d/t*.txt É¾³ıdÄ¿Â¼ÏÂËùÓĞµÄt´òÍ·µÄtxtÎÄ¼ş
3874          *************************************************************************************/
3875          #ifdef ZNFAT_DELETE_FILE
              UINT8 znFAT_Delete_File(INT8 *filepath) 
              {
               UINT8 res=0;
               struct FileInfo fi; 
              
               struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
               struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
              
               res=znFAT_Open_File(&fi,filepath,0,BOOL_TRUE);
               if(res) return res;
              
               while(!res) //´ò¿ªÎÄ¼ş³É¹¦
               {
                znFAT_Device_Read_Sector(fi.FDI_Sec,znFAT_Buffer); //¶ÁÈ¡ÎÄ¼şµÄÎÄ¼şÄ¿Â¼ÏîËùÔÚÉÈÇø
                pitems=(struct FDIesInSEC *)znFAT_Buffer;
                pitem=(pitems->FDIes)+fi.nFDI;
              
                if(0!=fi.File_StartClust) Destroy_FAT_Chain(fi.File_StartClust); //Ïú»ÙÕûÌõ´ØÁ´
              
                znFAT_Device_Read_Sector(fi.FDI_Sec,znFAT_Buffer); //¶ÁÈ¡ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
              
                pitem->Name[0]=0XE5; //¸øÎÄ¼şÄ¿Â¼Ïî´òÉÏ"ÒÑÉ¾³ı"µÄ±ê¼Ç
                pitem->HighClust[0]=pitem->HighClust[1]=0; //¿ªÊ¼´ØµÄ¸ß×ÖÇå0
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 65  

              
                znFAT_Device_Write_Sector(fi.FDI_Sec,znFAT_Buffer); //»ØĞ´ÉÈÇø
              
                res=znFAT_Open_File(&fi,filepath,0,BOOL_TRUE);
               }
              
               znFAT_Close_File(&fi);
              
               #ifdef RT_UPDATE_FSINFO
               Update_FSINFO();
               #endif
              
               return ERR_SUCC; 
              }
              #endif
3914          
3915          //==========================ÒÔÏÂ´úÂëÓÃÓÚÊµÏÖ¸ñÊ½»¯¹¦ÄÜ============================
3916          
3917          /************************************************************************************
3918           ¹¦ÄÜ£º»ñÈ¡ÔÚÄ³ÖÖ´ÅÅÌÈİÁ¿ÏÂ´Ø´óĞ¡µÄÍÆ¼öÖµ
3919           ĞÎ²Î£ºnsec:×ÜÉÈÇøÊı
3920           ·µ»Ø£º0
3921           Ïê½â£ºÈç¹û·µ»Ø0£¬ÔòËµÃ÷´ÅÅÌÈİÁ¿¶ÔÓÚFAT32ÎÄ¼şÏµÍ³À´ËµÌ«Ğ¡ÁË£¬ÎŞ·¨ÓÃFAT32À´¸ñÊ½»¯¡£
3922          *************************************************************************************/
3923          #ifdef GET_RECMD_SZCLU
              UINT8 Get_Recmd_szClu(UINT32 nsec)
              {
               if(nsec<(14336)) return 0;
              
               if((nsec>=(14336)) && (nsec<=(32767))) return 0;
               if((nsec>=(32768)) && (nsec<=(65535))) return 1;
               if((nsec>=(65536)) && (nsec<=(131071))) return 1;
               if((nsec>=(131072)) && (nsec<=(262143))) return 2;
               if((nsec>=(262144)) && (nsec<=(524287))) return 4;
               if((nsec>=(524288)) && (nsec<=(16777215))) return 8;
               if((nsec>=(16777216)) && (nsec<=(33554431))) return 16;
               if((nsec>=(33554432)) && (nsec<=(67108863))) return 32;
               if((nsec>=(67108864)) && (nsec<=(4294967295UL))) return 64;
              
               return 0;
              }
              #endif
3941          
3942          /************************************************************************************
3943           ¹¦ÄÜ£ºÔÚ´ÅÅÌÉÏ´´½¨Ò»¸öFAT32µÄÎÄ¼şÏµÍ³£¬¼´¸ñÊ½»¯
3944           ĞÎ²Î£ºtt_sec:×ÜÉÈÇøÊı clu_sz:Ê¹ÓÃÕßÖ¸¶¨µÄ´Ø´óĞ¡£¬Èç¹ûÎª0£¬ÔòÈ¡ÍÆ¼öÖµ
3945           ·µ»Ø£º0
3946           Ïê½â£ºFAT32µÄ¸ñÊ½»¯·ÖÎªÁ½ÖÖ²ßÂÔ£ºFDISKÓëSFD¡£FDISKÊÇÖ§³Ö¶à·ÖÇøµÄ£¬Òò´ËĞèÒª¹¹ÔìMBR
3947                 ¹¹ÔìMBR»áÉæ¼°µ½Ò»Ğ©±È½Ïµ×²ãµÄÄÚÈİ£¬½ÏÓĞÄÑ¶È£¬Òò´ËÎªÁË¼òµ¥¶ø¸ßĞ§£¬znFATÖĞÊ¹ÓÃÁË
3948                 SFD²ßÂÔ£¬Ëü½«Õû¸ö´ÅÅÌ¾Íµ±×÷Ò»¸öÄ¬ÈÏµÄ´ó·ÖÇø£¬Òò´ËËüÃ»ÓĞMBR¡£¸ñÊ½»¯ºó´ÅÅÌµÄ¾í
3949                 ±êÎªZN'ZNFATOK!
3950          *************************************************************************************/
3951          #ifdef ZNFAT_MAKE_FS
              UINT8 znFAT_Make_FS(UINT32 tt_sec,UINT16 clu_sz) //¸ñÊ½»¯ tt_sec ×ÜÉÈÇøÊı clu_sz Ö¸¶¨µÄ´Ø´óĞ¡
              {                                          //ÈôÎª0Ôò°´´ÅÅÌ´óĞ¡Ñ¡¶¨Ä¬ÈÏÖµ ¸ñÊ½»¯²ßÂÔ²ÉÓÃ±È½Ï¼òµ¥µÄSFD²ßÂÔ
                                                       //ÎŞMBR£¬²»Ö§³Ö·ÖÇø£¬Ö±½Ó´ÓDBR¿ªÊ¼
               struct DBR      *pdbr;
               struct FSInfo   *pfsinfo;
              
               UINT32 temp=0,temp1=0,temp2=0;
              
               tt_sec/=(UINT32)(NSECPERCYLINDER); 
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 66  

               tt_sec*=(UINT32)(NSECPERCYLINDER);//ÉáÈ¥¡°Ê£ÓàÉÈÇø¡±£¬Ê£ÓàÉÈÇøÊÇÖ¸²»×ãÒ»¸öÖùÃæµÄÉÈÇøÊı
              
               //=================ºÏ³ÉDBRÉÈÇøÊı¾İ=============================================================
               PGM2RAM(znFAT_Buffer,_dbr,512); //´ÓÄ£°æÊı×éÖĞ°ÑÊı¾İ°áµ½ÄÚ²¿»º³åÇø
               pdbr=(struct DBR *)znFAT_Buffer;
              
               pdbr->BPB_SecPerClus=(UINT8)(clu_sz/512); //Ã¿´ØÉÈÇøÊı
               if(0==pdbr->BPB_SecPerClus) pdbr->BPB_SecPerClus=Get_Recmd_szClu(tt_sec);
               if(0==pdbr->BPB_SecPerClus) return ERR_FMT_TOO_LOW_VOLUME; //ÈİÁ¿Ì«Ğ¡£¬²»ÄÜÓÃFAT32½øĞĞ¸ñÊ½»¯
              
               temp1=pdbr->BPB_SecPerClus;
              
               pdbr->BPB_TotSec32[0]=(UINT8)((tt_sec)    &0X000000FF);
               pdbr->BPB_TotSec32[1]=(UINT8)((tt_sec>>8) &0X000000FF);
               pdbr->BPB_TotSec32[2]=(UINT8)((tt_sec>>16)&0X000000FF);
               pdbr->BPB_TotSec32[3]=(UINT8)((tt_sec>>24)&0X000000FF); //¸Ã·ÖÇøµÄ×ÜÉÈÇøÊı
              
               temp=(tt_sec-32)/(((UINT32)NITEMSINFATSEC)*((UINT32)(pdbr->BPB_SecPerClus)));
               if((tt_sec-32)%((UINT32)NITEMSINFATSEC)*((UINT32)pdbr->BPB_SecPerClus)) temp++; //((tt_sec-32)-2*FATsz)/(
             -SecPerClus*128)=FATsz ½âÕâ¸öµÈÊ½
               temp2=temp;
               
               pdbr->BPB_FATSz32[0]=(UINT8)((temp)    &0X000000FF);
               pdbr->BPB_FATSz32[1]=(UINT8)((temp>>8) &0X000000FF);
               pdbr->BPB_FATSz32[2]=(UINT8)((temp>>16)&0X000000FF);
               pdbr->BPB_FATSz32[3]=(UINT8)((temp>>24)&0X000000FF); //FAT±íµÄÉÈÇøÊı
              
               znFAT_Device_Write_Sector(0,znFAT_Buffer); //½«ºÏ³ÉºÃµÄDBRÊı¾İĞ´Èëµ½0ÉÈÇøÖĞÈ¥
              
               //===============================ÒÔÉÏ´úÂëÍê³É¶ÔDBRÉÈÇøÊı¾İµÄºÏ³É===============================
              
               //===================================ÒÔÏÂ´úÂëÍê³É¶ÔFSINFOÉÈÇøÊı¾İµÄºÏ³É========================
              
               Memory_Set(znFAT_Buffer,ZNFAT_BUF_SIZE,0); //½«ÄÚ²¿»º³åÇøÇå0
               PGM2RAM(znFAT_Buffer,_fsinfo_1,4); //½«FSINFOÄ£°åÊı¾İµÄµÚÒ»²¿·Ö°á¹ıÀ´
               PGM2RAM(znFAT_Buffer+484,_fsinfo_2,28); //½«FSINFOÄ£°åÊı¾İµÄµÚ¶ş²¿·Ö°á¹ıÀ´
                                                           //×¢£ºFSINFOÄ£°åÊı¾İ·ÖÎªÁ½²¿·Ö£¬Ö÷ÒªÊÇÒòÎªÆäÖĞÓĞ¾ø´ó
                                                           //²¿·ÖÊÇ0£¬ÎªÁË½ÚÊ¡¹Ì»¯Êı¾İÁ¿£¬¼õÉÙFLASHROM¿Õ¼äµÄÊ¹ÓÃÁ¿
               pfsinfo=(struct FSInfo *)znFAT_Buffer;
               
               temp=(tt_sec-32-2*temp)/((UINT32)(temp1))-1; //×Ü´ØÊı-1£¬ÒòÎªµÚ2´ØÎªÊ×Ä¿Â¼£¬ÒÑ¾­±»¾í±êÕ¼ÓÃ
               pfsinfo->Free_Cluster[0]=(UINT8)((temp)    &0X000000FF);
               pfsinfo->Free_Cluster[1]=(UINT8)((temp>>8) &0X000000FF);
               pfsinfo->Free_Cluster[2]=(UINT8)((temp>>16)&0X000000FF);
               pfsinfo->Free_Cluster[3]=(UINT8)((temp>>24)&0X000000FF); //Ê£Óà¿Õ´ØÊı
              
               znFAT_Device_Write_Sector(1,znFAT_Buffer); //½«ºÏ³ÉºÃµÄDBRÊı¾İĞ´Èëµ½64ÉÈÇøÖĞÈ¥£¬¼´DBRÉÈÇøµÄºóÒ»¸öÉÈÇø
              
               //=====================================ÒÔÉÏ´úÂëÍê³É¶ÔFSINFOÉÈÇøÊı¾İµÄºÏ³É=====================
              
               //=====================================ÒÔÏÂ´úÂëÍê³É¶ÔFAT±íµÄ³õÊ¼»¯============================
              
               znFAT_Device_Clear_nSector(temp1,32+2*temp2);
               znFAT_Device_Clear_nSector(temp2-1,33);
               znFAT_Device_Clear_nSector(temp2-1,33+temp2);
              
               PGM2RAM(znFAT_Buffer,_fatsec,12); //½«FAT±íÄ£°æÊı¾İ°áµ½ÄÚ²¿»º³åÇø
               znFAT_Device_Write_Sector(32,znFAT_Buffer); //ÏòFAT±í1ÖĞĞ´Èë0
               znFAT_Device_Write_Sector(32+temp2,znFAT_Buffer); //ÏòFAT±í2ÖĞĞ´Èë0
              
               //=====================================ÒÔÉÏ´úÂëÍê³É¶ÔFAT±íµÄ³õÊ¼»¯============================
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 67  

               //=====================================ÒÔÏÂ´úÂë¶ÔÊı¾İÇøÊ×ÉÈÇø½øĞĞ³õÊ¼»¯£¬Ğ´Èë¾í±ê=============
              
               PGM2RAM(znFAT_Buffer,_1stsec,26); 
               znFAT_Device_Write_Sector(32+2*temp2,znFAT_Buffer); //ÏòÊı¾İÇøµÚÒ»¸öÉÈÇøĞ´ÈëÊı¾İ
              
               //=====================================ÒÔÉÏ.....==============================================
               return ERR_SUCC;
              }  
              #endif
4031          
4032          //===================ÒÔÏÂ´úÂëÓÃÓÚÊµÏÖÎÄ¼şÊı¾İĞ´Èë=====================
4033          
4034          /************************************************************************************
4035           ¹¦ÄÜ£º¸üĞÂÎÄ¼şµÄ´óĞ¡£¬½«µ±Ç°ÎÄ¼şĞÅÏ¢¼¯ºÏÖĞµÄFile_SizeÖµĞ´Èëµ½ÎÄ¼şÄ¿Â¼ÏîÖĞÈ¥
4036           ĞÎ²Î£ºpfi:Ö¸ÕëÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë
4037           ·µ»Ø£º0
4038           Ïê½â£ºÔÚÏòÎÄ¼şĞ´ÈëÊı¾İ£¬»òÉ¾³ıÊı¾İÖ®ºó£¬Èç¹û²»µ÷ÓÃ´Ëº¯Êı½«ÎÄ¼ş´óĞ¡¸üĞÂµ½Ä¿Â¼ÏîÖĞÈ¥
4039                 ÔòÎÒÃÇÔÚµçÄÔÉÏÊÇ¿´²»µ½Ğ´ÈëµÄÊı¾İµÄ¡£´Ëº¯ÊıÔÚznFATÖĞÊÜµ½RT_UPDATE_FILESIZEÕâ¸ö
4040                 ºêµÄ¿ØÖÆ£¬ÒÔ¾ö¶¨ÊÇ·ñÊµÊ±¸üĞÂÎÄ¼ş´óĞ¡¡£
4041          *************************************************************************************/
4042          #ifdef UPDATE_FILE_SIZE
4043          UINT8 Update_File_Size(struct FileInfo *pfi) //¸üĞÂÎÄ¼ş´óĞ¡
4044          {
4045   1       struct FDI *pfdi;
4046   1      
4047   1       just_file=pfi;
4048   1      
4049   1       znFAT_Device_Read_Sector(pfi->FDI_Sec,znFAT_Buffer);
4050   1      
4051   1       pfdi=(((struct FDIesInSEC *)znFAT_Buffer)->FDIes)+(pfi->nFDI); //ÎÄ¼şµÄÎÄ¼şÄ¿Â¼Ïî
4052   1      
4053   1       (pfdi->FileSize)[0]=(UINT8)((pfi->File_Size)&0X000000FF)      ;
4054   1       (pfdi->FileSize)[1]=(UINT8)(((pfi->File_Size)&0X0000FF00)>>8) ;
4055   1       (pfdi->FileSize)[2]=(UINT8)(((pfi->File_Size)&0X00FF0000)>>16);
4056   1       (pfdi->FileSize)[3]=(UINT8)(((pfi->File_Size)&0XFF000000)>>24);
4057   1      
4058   1       znFAT_Device_Write_Sector(pfi->FDI_Sec,znFAT_Buffer);
4059   1      
4060   1       return 0;
4061   1      }
4062          #endif
4063          
4064          /************************************************************************************
4065           ¹¦ÄÜ£º¸üĞÂÎÄ¼şµÄ¿ªÊ¼´Ø
4066           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë clu:ÎÄ¼ş¿ªÊ¼´ØºÅ
4067           ·µ»Ø£º0
4068           Ïê½â£º¶ÔÓÚÒ»¸ö¸Õ¸Õ´´½¨µÄÎÄ¼ş£¨¿ÕÎÄ¼ş£©£¬ËüµÄ¿ªÊ¼´ØÎª0£¬Òò´ËÏòÆäĞ´ÈëÊı¾İÊ±£¬²»¹âÒª¸ü
4069                 ĞÂ´ØÁ´£¬»¹Òª¸üĞÂÎÄ¼şµÄ¿ªÊ¼´Ø£¬ËüÊÇÎÄ¼şÕûÌõ´ØÁ´µÄ¿ªÊ¼¡£
4070          *************************************************************************************/
4071          #ifdef UPDATE_FILE_SCLUST
              UINT8 Update_File_sClust(struct FileInfo *pfi,UINT32 clu) //¸üĞÂÎÄ¼ş¿ªÊ¼´Ø
              {
               struct FDI *pfdi;
              
               just_file=pfi;
              
               znFAT_Device_Read_Sector(pfi->FDI_Sec,znFAT_Buffer);
              
               pfdi=(((struct FDIesInSEC *)znFAT_Buffer)->FDIes)+(pfi->nFDI); //ÎÄ¼şµÄÎÄ¼şÄ¿Â¼Ïî
              
               pfi->File_StartClust=clu;
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 68  

               (pfdi->HighClust)[0]=(UINT8)((clu&0X00FF0000)>>16);
               (pfdi->HighClust)[1]=(UINT8)((clu&0XFF000000)>>24);
               (pfdi->LowClust )[0]=(UINT8)((clu&0X000000FF))    ;
               (pfdi->LowClust )[1]=(UINT8)((clu&0X0000FF00)>>8) ;
              
               znFAT_Device_Write_Sector(pfi->FDI_Sec,znFAT_Buffer);
              
               return 0; 
              }
              #endif
4094          
4095          /************************************************************************************
4096           ¹¦ÄÜ£º´´½¨Ò»Ìõ´ØÁ´
4097           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë cluster:´ØÁ´µÄ¿ªÊ¼´Ø datalen:Êı¾İ³¤¶È(×Ö½Ú)
4098           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
4099           Ïê½â£º´Ëº¯ÊıµÄ¹¦ÄÜÊÇÎªÁËÏòÎÄ¼şÖĞĞ´ÈëÊı¾İ¶øÔ¤ÏÈ½¨Á¢´ØÁ´£¬´Ó¶ø¿ÉÒÔÌá¹©Êı¾İĞ´ÈëµÄĞ§ÂÊ
4100                 £¨Ê¹Êı¾İĞ´ÈëµÄ¹ı³ÌÖĞ£¬²»ÔÙÇ£³¶´ØÁ´¹¹ÔìµÄ²Ù×÷£©¼ÓÖ®¶Ô´ØÁ´µÄÁ¬Ğø¶ÎµÄ·ÖÎö£¬¿ÉÒÔºÜ
4101                 ´ó³ÌĞòÉÏÌá¸ß¶àÉÈÇøÁ¬Ğø¶ÁĞ´Çı¶¯µÄÊ¹ÓÃÂÊ¡£ÕâÒ»º¯ÊıÊÇznFAT¡°´óÄ£Ê½¡±µÄ»ù´¡£¨´óÄ£
4102                 Ê½¾ÍÊÇÏÈÎªÎÄ¼şÔ¤ÏÈ½¨Á¢ºÃ´ØÁ´£¬È»ºó¾ÍÊÇµ¥´¿µÄÊı¾İĞ´ÈëÁË£¬ÕâÑù¼«´óµÄÌáÉıÁËÊı¾İĞ´
4103                 ÈëµÄËÙ¶ÈºÍĞ§ÂÊ£¬ÊÇÊı¾İ¸ßËÙ´æ´¢µÄ½â¾ö·½°¸£©¡£
4104          *************************************************************************************/
4105          #ifdef CREATE_CLUSTER_CHAIN
              UINT8 Create_Cluster_Chain(struct FileInfo *pfi,UINT32 cluster,UINT32 datalen)
              {
               UINT32 iSec=0,clu_sec=0,old_clu=cluster,ncluster=0,temp_ncluster=0;
               UINT8 iItem=0,temp=0;
               struct FAT_Sec *pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer; //½«Êı¾İ»º³åÇøÊ×µØÖ·Ç¿×ªÎªFAT_Sec½á¹¹ÌåµÄÖ¸ÕëÀàĞ
             -Í
              
               UINT32 Clu_Size=(pInit_Args->SectorsPerClust*pInit_Args->BytesPerSector); //´Ø´óĞ¡£¬ÒÔÃâºóÃæÖØ¸´¼ÆËã
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               ncluster=datalen/Clu_Size;
               if(0!=datalen%Clu_Size) ncluster++; //Èç¹ûÓĞÊı¾İÓàÁ¿£¨ÕûÉÈÇø£©£¬´ØÊı¼Ó1
              
               temp_ncluster=ncluster; //¼ÇÂ¼ÏÂ´ØÁ´µÄ´ØÊı
              
               if((pInit_Args->Free_nCluster)<ncluster) return ERR_NO_SPACE; //ÎŞ×ã¹»µÄ´æ´¢¿Õ¼ä
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifndef USE_ALONE_CCCB
               if(pfi!=pcccb_cur_oc) //Èç¹ûµ±Ç°Õ¼ÓÃCCCBµÄ²»ÊÇÏÖÔÚÒª²Ù×÷µÄÎÄ¼ş
               {
                CCCB_Update_FAT();
                pcccb_cur_oc=pfi;
                (*pcccb_curdev)=Dev_No;
                pcccb_cur_initargs=pInit_Args;
               }
               #endif
               (*pcccb_curval)=cluster;
               #endif
              
               //===================================ÕâÀï¿ÉÄÜ²úÉú·µÁ´==========================================
              
               cluster=(pInit_Args->Next_Free_Cluster);
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 69  

              
               pfi->File_CurClust=pInit_Args->Next_Free_Cluster; //µ±Ç°´ØÎªÏÂÒ»¿Õ´Ø
               pfi->File_CurSec=SOC(pfi->File_CurClust); //µ±Ç°´ØµÄÊ×ÉÈÇø
              
               ncluster--;
               //============================
              
               if(0!=old_clu)
               {
                clu_sec=(old_clu/NITEMSINFATSEC); //¼ÆËãÇ°Ò»´ØµÄ´ØÏîËùÔÚµÄFATÉÈÇø
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
                #ifdef RT_UPDATE_CLUSTER_CHAIN
                temp=(UINT8)(old_clu%NITEMSINFATSEC);
                (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cluster&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cluster&0X0000FF00)>>8) ;
                (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cluster&0X00FF0000)>>16);
                (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cluster&0XFF000000)>>24);
                #else
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                if(0==(*pcccb_counter)) 
                {
                 pcccb_buf[(*pcccb_counter)]=(*pcccb_curval);
                 (*pcccb_counter)++;
                }
              
                if(cluster==((*pcccb_curval)+1))
                {
                 (*pcccb_curval)++;
                }
                else
                {
                 if(((*pcccb_counter)+1)!=CCCB_LEN) //CCCBÃ»ÓĞÒç³ö
                 {
                  pcccb_buf[(*pcccb_counter)]=(*pcccb_curval);
              
                  (*pcccb_counter)++;
                  pcccb_buf[(*pcccb_counter)]=cluster;
                  (*pcccb_curval)=cluster;
                  (*pcccb_counter)++;
                 }
                 else //CCCBÒç³ö£¬´ËÊ±ĞèÒª½«CCCB¸üĞÂµ½FAT
                 {
                CCCB_Update_FAT();
                #ifndef USE_ALONE_CCCB
                pcccb_cur_oc=pfi;
                  (*pcccb_curdev)=Dev_No;
                  pcccb_cur_initargs=pInit_Args;
                  #endif
              
                  (*pcccb_counter)=0;
                  pcccb_buf[(*pcccb_counter)]=pcccb_buf[(*pcccb_counter)+1]=(*pcccb_curval);
                  pcccb_buf[(*pcccb_counter)+2]=cluster;
                  (*pcccb_curval)=cluster;
                  (*pcccb_counter)+=3;
                 }
                }
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                #endif
               }
               else
               {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 70  

                clu_sec=(cluster/NITEMSINFATSEC); //¼ÆËãÇ°Ò»´ØµÄ´ØÏîËùÔÚµÄFATÉÈÇø
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                
                #ifndef RT_UPDATE_CLUSTER_CHAIN
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                (*pcccb_counter)=0;
                pcccb_buf[(*pcccb_counter)]=cluster;
                (*pcccb_curval)=cluster;
                (*pcccb_counter)++;
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                #endif
               }
              
               #ifdef RT_UPDATE_CLUSTER_CHAIN
               if(clu_sec==(cluster/NITEMSINFATSEC)) //Èç¹ûÄ¿±ê´ØÏîÓëÇ°Ò»´ØÏîÔÚÍ¬Ò»ÉÈÇø
               {
                if(0==ncluster) 
                {
                 temp=(UINT8)(cluster%NITEMSINFATSEC);
                 (((pFAT_Sec->items)[temp]).Item)[0]=0XFF;  //´ØÁ´·â¿Ú  
                 (((pFAT_Sec->items)[temp]).Item)[1]=0XFF;
                 (((pFAT_Sec->items)[temp]).Item)[2]=0XFF;
                 (((pFAT_Sec->items)[temp]).Item)[3]=0X0F;   
              
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                }
               }
               else //Èç¹ûÄ¿±ê´ØÏîÓëÇ°Ò»´ØÏî²»ÔÚÍ¬Ò»ÉÈÇø
               {
                znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
              
                clu_sec=(cluster/NITEMSINFATSEC); //¼ÆËãÇ°Ò»´ØµÄ´ØÏîËùÔÚµÄFATÉÈÇø
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
                if(0==ncluster) 
                {
                 temp=(UINT8)(cluster%NITEMSINFATSEC);
              
                 (((pFAT_Sec->items)[temp]).Item)[0]=0XFF;  //´ØÁ´·â¿Ú  
                 (((pFAT_Sec->items)[temp]).Item)[1]=0XFF;
                 (((pFAT_Sec->items)[temp]).Item)[2]=0XFF;
                 (((pFAT_Sec->items)[temp]).Item)[3]=0X0F;   
              
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                }
               }
               #endif
               
               if(0==ncluster) //Èç¹û´ØÁ´¹¹ÔìÍê³É
               {
                pInit_Args->Free_nCluster-=temp_ncluster; //¸üĞÂÊ£Óà¿Õ´ØÊı
              
                Update_Next_Free_Cluster();
              
                #ifdef RT_UPDATE_FSINFO
                Update_FSINFO();
                #endif
              
                return ERR_SUCC;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 71  

               }
              
               old_clu=cluster; 
              
               //=============================================================================================
              
               clu_sec=(old_clu/NITEMSINFATSEC);
              
               if(((UINT8)((cluster%NITEMSINFATSEC)+1))!=((UINT8)NITEMSINFATSEC)) //Èç¹ûµ±Ç°µÄ´ØÏî²»ÊÇÆäËùÔÚFATÉÈÇøÖĞµÄ×
             -îºóÒ»¸ö´ØÏî
               {
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
                for(iItem=(UINT8)((cluster%NITEMSINFATSEC)+1);iItem<NITEMSINFATSEC;iItem++) //¼ì²âÔÚµ±Ç°FATÉÈÇøÄÚµ±Ç°´ØÏ
             -îÖ®ºóÊÇ·ñÓĞ¿Õ´Ø
                {
                 cluster++; //´ØºÅ×ÔÔö
              
                 if(0==(((pFAT_Sec->items)[iItem]).Item)[0]  //Èç¹û·¢ÏÖ¿Õ´Ø
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[1]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[2]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[3])
                 { 
                #ifdef RT_UPDATE_CLUSTER_CHAIN
                  temp=(UINT8)(old_clu%NITEMSINFATSEC);
              
                  (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cluster&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                  (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cluster&0X0000FF00)>>8) ;
                  (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cluster&0X00FF0000)>>16);
                  (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cluster&0XFF000000)>>24);
                  #else
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                  if(cluster==((*pcccb_curval)+1))
                {
                   (*pcccb_curval)++;
                }
                  else
                {
                   if(((*pcccb_counter)+1)!=CCCB_LEN) //CCCBÃ»ÓĞÒç³ö
                   {
                    pcccb_buf[(*pcccb_counter)]=(*pcccb_curval);
              
                    (*pcccb_counter)++;
                    pcccb_buf[(*pcccb_counter)]=cluster;
                    (*pcccb_curval)=cluster;
                    (*pcccb_counter)++;
                   }
                   else //CCCBÒç³ö£¬´ËÊ±ĞèÒª½«CCCB¸üĞÂµ½FAT£¬²¢Çå¿ÕCCCB£¬ÒÔ±ãÔÙ´ÎÀûÓÃ
                   {
                  CCCB_Update_FAT();
                  #ifndef USE_ALONE_CCCB
                  pcccb_cur_oc=pfi;
                    (*pcccb_curdev)=Dev_No;
                    pcccb_cur_initargs=pInit_Args;
                    #endif
              
                  (*pcccb_counter)=0;
                  pcccb_buf[(*pcccb_counter)]=pcccb_buf[(*pcccb_counter)+1]=(*pcccb_curval);
                  pcccb_buf[(*pcccb_counter)+2]=cluster;
                    (*pcccb_curval)=cluster;
                  (*pcccb_counter)+=3;
                   }
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 72  

                }
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                  #endif
                  ncluster--;
                  old_clu=cluster;
                 }
              
                 if(0==ncluster) 
                 {
                  #ifdef RT_UPDATE_CLUSTER_CHAIN
                (((pFAT_Sec->items)[iItem]).Item)[0]=0XFF;
                (((pFAT_Sec->items)[iItem]).Item)[1]=0XFF;
                (((pFAT_Sec->items)[iItem]).Item)[2]=0XFF;
                (((pFAT_Sec->items)[iItem]).Item)[3]=0X0F; //FATÁ´·â¿Ú
                  
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                  #endif
                  pInit_Args->Free_nCluster-=temp_ncluster; //¸üĞÂÊ£Óà¿Õ´ØÊı
                  pInit_Args->Next_Free_Cluster=cluster; 
              
                  Update_Next_Free_Cluster();
              
                  #ifdef RT_UPDATE_FSINFO
                  Update_FSINFO();
                  #endif
              
                  return ERR_SUCC;
                 }
                }
               }
               #ifdef RT_UPDATE_CLUSTER_CHAIN
               znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
               znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
               #endif
               //=============================================================================================
              
               for(iSec=(clu_sec+1);iSec<(pInit_Args->FATsectors);iSec++) //ÔÚºóÃæµÄFATÉÈÇøÖĞ¼ÌĞø²éÕÒ
               {
                znFAT_Device_Read_Sector(iSec+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
                for(iItem=0;iItem<NITEMSINFATSEC;iItem++) //¼ì²âÔÚµ±Ç°FATÉÈÇøÄÚµ±Ç°´ØÏîÖ®ºóÊÇ·ñÓĞ¿Õ´Ø
                {
                 cluster++;
              
                 if(0==(((pFAT_Sec->items)[iItem]).Item)[0]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[1]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[2]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[3])
                 {
                  #ifdef RT_UPDATE_CLUSTER_CHAIN
                clu_sec=(old_clu/NITEMSINFATSEC);
                  temp=(UINT8)(old_clu%NITEMSINFATSEC);
              
                  if(iSec!=clu_sec) //Èç¹ûÒª¸üĞÂµÄ´ØÏîËùÔÚµÄÉÈÇøÓëµ±Ç°ÉÈÇø²»ÊÇÍ¬Ò»ÉÈÇø
                {                 //ÔòĞèÒªÔÚ¸üĞÂ´ØÏîºó£¬»Ö¸´ÄÚ²¿¼¶³åµÄÊı¾İÎªµ±Ç°ÉÈÇø
                   Modify_FAT(old_clu,cluster);
              
                   znFAT_Device_Read_Sector(iSec+(pInit_Args->FirstFATSector),znFAT_Buffer);   
                }
                else //¶øÈç¹ûÒª¸üĞÂµÄ´ØÏîËùÔÚÉÈÇøÓëµ±Ç°ÉÈÇøÎªÍ¬Ò»ÉÈÇø£¬ÔòÖ»ĞèÒªÔÚÄÚ²¿»º³åÖĞ½øĞĞ¸üĞÂ
                {    //¶øÎŞĞèÏòÉÈÇøÖĞ»ØĞ´£¬ÕâÊÇÌá¹©´ØÁ´´´½¨ËÙ¶ÈµÄºËĞÄË¼Ïë
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 73  

                   (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cluster&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                   (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cluster&0X0000FF00)>>8) ;
                   (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cluster&0X00FF0000)>>16);
                   (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cluster&0XFF000000)>>24);
                }
                  #else
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                  if(cluster==((*pcccb_curval)+1))
                {
                   (*pcccb_curval)++;
                }
                  else
                {
                   if(((*pcccb_counter)+1)!=CCCB_LEN) //CCCBÃ»ÓĞÒç³ö
                   {
                    pcccb_buf[(*pcccb_counter)]=(*pcccb_curval);
              
                    (*pcccb_counter)++;
                    pcccb_buf[(*pcccb_counter)]=cluster;
                    (*pcccb_curval)=cluster;
                    (*pcccb_counter)++;
                   }
                   else //CCCBÃ»ÓĞÒç³ö£¬´ËÊ±ĞèÒª½«CCCB¸üĞÂµ½FAT
                   {
                  CCCB_Update_FAT();
                  #ifndef USE_ALONE_CCCB
                  pcccb_cur_oc=pfi;
                    (*pcccb_curdev)=Dev_No;
                    pcccb_cur_initargs=pInit_Args;
                    #endif
              
                  (*pcccb_counter)=0;
                  pcccb_buf[(*pcccb_counter)]=pcccb_buf[(*pcccb_counter)+1]=(*pcccb_curval);
                  pcccb_buf[(*pcccb_counter)+2]=cluster;
                    (*pcccb_curval)=cluster;
                  (*pcccb_counter)+=3;
                   }
                }
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                  #endif
                ncluster--;
                old_clu=cluster;
                 }
              
                 if(0==ncluster) 
                 {
                #ifdef RT_UPDATE_CLUSTER_CHAIN
                clu_sec=(old_clu/NITEMSINFATSEC);
              
                (((pFAT_Sec->items)[iItem]).Item)[0]=0XFF;
                (((pFAT_Sec->items)[iItem]).Item)[1]=0XFF;
                (((pFAT_Sec->items)[iItem]).Item)[2]=0XFF;
                (((pFAT_Sec->items)[iItem]).Item)[3]=0X0F; //FATÁ´·â¿Ú
              
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                  #endif
                  pInit_Args->Free_nCluster-=temp_ncluster; //¸üĞÂÊ£Óà¿Õ´ØÊı
                  pInit_Args->Next_Free_Cluster=cluster; 
              
                  Update_Next_Free_Cluster();
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 74  

                  #ifdef RT_UPDATE_FSINFO
                  Update_FSINFO();
                  #endif
              
                  return ERR_SUCC;
                 }
                }
                #ifdef RT_UPDATE_CLUSTER_CHAIN
                znFAT_Device_Write_Sector(iSec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                znFAT_Device_Write_Sector(iSec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                #endif
               } 
              
               return ERR_FAIL;
              }
              #endif
4469          
4470          /************************************************************************************
4471           ¹¦ÄÜ£º´ÓÎÄ¼şÕû´ØÎ»ÖÃ¿ªÊ¼Ğ´ÈëÊı¾İ
4472           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë len:ÒªĞ´ÈëµÄÊı¾İ³¤¶È pbuf:Ö¸ÏòÊı¾İ»º³åÇø
4473           ·µ»Ø£ºÊµ¼ÊĞ´ÈëµÄÊı¾İÁ¿
4474           Ïê½â£ºznFATÖĞÏòÎÄ¼şĞ´ÈëÊı¾İÊÇÒÔ×·¼Ó·½Ê½Ğ´ÈëµÄ£¬¼´×ÜÊÇ´ÓÎÄ¼şµÄÄ©Î²ÏòºóĞ´ÈëÊı¾İ¡£Ğ´Èë
4475                 Êı¾İµÄÒÀ¾İÊÇÎÄ¼şµ±Ç°µÄÎ»ÖÃ²ÎÊı£¬µ«ÊÇµ±ÎÄ¼şÎª¿ÕÎÄ¼ş£¬¼´ÆäÊı¾İÎª0£¬»òÊÇÊı¾İÎª´Ø
4476                 ´óĞ¡µÄÕûÊı±¶£¬´ËÊ±ÎÄ¼şµÄÎ»ÖÃ²ÎÊı½«²»ÄÜÈçÊµ±í´ïÎÄ¼şÊı¾İµÄµ±Ç°Î»ÖÃ£¨ÎÄ¼şÎª¿ÕÊ±
4477                 µ±Ç°´ØÎª0£¬Õû´ØÊ±µ±Ç°´ØÎª×îºóÒ»¸öÓĞĞ§´Ø£©£¬ÕâÖÖÇé¿ö¾ÍÊÇznFATÖĞµÄ¡°å´Ø¡±£¬´Ëº¯
4478                 Êı×¨ÃÅÓÃÒÔ´¦ÀíÕâÖÖÇé¿ö¡£
4479          *************************************************************************************/
4480          #ifdef WRITEDATA_FROM_NCLUSTER
              UINT32 WriteData_From_nCluster(struct FileInfo *pfi,UINT32 len,UINT8 *pbuf)
              {
               UINT32 CluSize=((pInit_Args->BytesPerSector)*(pInit_Args->SectorsPerClust)); //¼ÆËã´Ø´óĞ¡£¬ÒÔÃâºóÃæÖØ¸´¼Æ
             -Ëã
               UINT32 temp=len/CluSize;//¼ÆËãÒªĞ´ÈëµÄÊı¾İÁ¿¹»¼¸¸öÕû´Ø
               UINT32 iClu=0,start_clu=0,end_clu=0,next_clu=0; 
               UINT32 temp1=0,temp2=0;
               UINT8 res=0;
              
               #ifdef USE_EXCHANGE_BUFFER
               #ifndef USE_ALONE_EXB
               UINT8 old_devno=Dev_No;
               #else
               pexb_buf=(pfi->exb_buf);
               #endif
               #endif
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               if(0==len) return 0; //Èç¹ûÒªĞ´ÈëµÄÊı¾İ³¤¶ÈÎª0£¬ÔòÖ±½Ó·µ»Ø
              
               if(0==pfi->File_CurClust) //Èç¹ûÊÇ¿ÕÎÄ¼ş£¬Ôòµ±Ç°´ØÎª0£¬¼´ÉĞÎ´ÎªÆä·ÖÅä´Ø
               {
                pfi->File_StartClust=pInit_Args->Next_Free_Cluster;
                Update_File_sClust(pfi,pInit_Args->Next_Free_Cluster);
               }
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 75  

               res=Create_Cluster_Chain(pfi,pfi->File_CurClust,len); //ÎªÕû´ØÊı¾İÔ¤½¨´ØÁ´
               if(res) return res;
              
               if(0==temp) //Èç¹ûÒªĞ´ÈëµÄÊı¾İÉÙÓÚÒ»¸ö´Ø
               {
                temp=len/(pInit_Args->BytesPerSector); //ÒªĞ´ÈëµÄÊı¾İ¹»¼¸¸öÕûÉÈÇø
                znFAT_Device_Write_nSector(temp,SOC(pfi->File_CurClust),pbuf);
                pfi->File_CurSec+=temp;
                pbuf+=(temp*(pInit_Args->BytesPerSector));
              
                temp=len%(pInit_Args->BytesPerSector);
                if(0!=temp) //»¹ÓĞÊı¾İÒªĞ´Èë£¬²»×ãÉÈÇøµÄ×îºóÒ»µãÊı¾İ
                {
                 #ifndef USE_EXCHANGE_BUFFER
                 Memory_Copy(znFAT_Buffer,pbuf,temp); //°Ñ²»×ãÒ»ÉÈÇøµÄÊı¾İÏÈ·ÅÈëÄÚ²¿»º³åÇøÖĞ
                 znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer); //½«ÄÚ²¿»º³åÇøÖĞµÄÊı¾İĞ´ÈëÉÈÇøÖĞ
                                                                       //Èç¹ûÖ±½ÓÊ¹ÓÃpbuf×÷Êı¾İÔ´À´Ğ´Èë£¬Òò²»×ãÒ»¸öÉÈÇø
                                                                       //´Ó¶ø»áÔì³ÉÄÚ´æÒç³ö,³ÌĞò±ÀÀ£
                 #else
                 #ifndef USE_ALONE_EXB
                 if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                 {
                if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                {
                 Dev_No=sexb_cur_dev;
                 znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
              
                   Dev_No=old_devno;
                }
                 }
                 else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                 {
                if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                {
                 if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                 {
                  znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
                 }     
                }
                 }
                 #endif 
              
                 Memory_Copy(pexb_buf,pbuf,temp);
              
                 #ifndef USE_ALONE_EXB
                 sexb_cur_sec=pfi->File_CurSec;   //¼ÇÂ¼µ±Ç°½»»»»º³åÖĞËù·´Ó³µÄÉÈÇøµØÖ·
                 sexb_cur_dev=Dev_No; //¼ÇÂ¼µ±Ç°½»»»»º³åÖĞÊı¾İËùÔÚµÄÉè±¸ºÅ
                 psexb_cur_oc=pfi; //¼ÇÂ¼EXBÖĞ»º³åµÄÊı¾İÊôÓÚÄÄ¸öÎÄ¼ş
                 #else
                 just_file->exb_cursec=pfi->File_CurSec;
                 #endif
                 #endif
                  
                 pfi->File_CurPos=(UINT16)temp;   
                }
               }
               else
               {
                //¼ÆËã¸÷Á¬Ğø´Ø¶Î£¬ÒÔ¾¡¿ÉÄÜµÄÊ¹ÓÃ¶àÉÈÇøĞ´Çı¶¯£¬ÒÔÌá¸ßÊı¾İĞ´ÈëËÙ¶È
                //start_cluÓëend_cluÓÃÓÚ¼ÇÂ¼Á¬Ğø´Ø¶ÎµÄÊ¼Ä©
                start_clu=end_clu=pfi->File_CurClust; 
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 76  

                for(iClu=1;iClu<temp;iClu++)
                {
                 next_clu=Get_Next_Cluster(end_clu);
              
                 if((next_clu-1)==end_clu) //Èç¹ûÁ½¸ö´ØÏàÁÙ£¬¼´Á¬Ğø
                 {
                  end_clu=next_clu;
                 }
                 else //Èç¹ûÁ½¸ö´Ø²»ÏàÁÙ£¬¼´Óöµ½´ØÁ´¶Ïµã
                 {
                  znFAT_Device_Write_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),pbuf);
                pbuf+=((end_clu-start_clu+1)*CluSize);
                  start_clu=next_clu;
                  end_clu=next_clu;
                 }
                }
              
                temp1=(len%CluSize)/(pInit_Args->BytesPerSector); //Ê£ÓàÊı¾İ¹»¼¸¸öÕûÉÈÇø
                temp2=Get_Next_Cluster(end_clu);
                temp=(end_clu-start_clu+1)*(pInit_Args->SectorsPerClust);
               
                if(!IS_END_CLU(temp2)) //Èç¹ûÏÂÒ»´Ø²»ÊÇ½áÊø´Ø£¬¼´ºóÃæ»¹ÓĞÊı¾İÒªĞ´Èë
                {
                 if((temp2-1)==end_clu) //Èç¹û×îºóÒ»¸ö´ØÖĞµÄÊ£ÓàÉÈÇøÓëÇ°ÃæµÄ×îºóµÄÁ¬Ğø´Ø¶ÎÊÇÁ¬ĞøµÄ
                 {
                  znFAT_Device_Write_nSector((temp+temp1),SOC(start_clu),pbuf);
                  pbuf+=((temp+temp1)*(pInit_Args->BytesPerSector));
                 }
                 else
                 {
                  znFAT_Device_Write_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),pbuf);
             - 
                  pbuf+=(temp*(pInit_Args->BytesPerSector));
                  znFAT_Device_Write_nSector(temp1,SOC(temp2),pbuf);
                  pbuf+=(temp1*(pInit_Args->BytesPerSector));
                 }
              
                 pfi->File_CurClust=temp2;
                 pfi->File_CurSec=(SOC(temp2)+temp1);
                 //=======================================================================================
                 temp=len%(pInit_Args->BytesPerSector);
                 if(0!=temp) //»¹ÓĞÊı¾İÒªĞ´Èë
                 {
                #ifndef USE_EXCHANGE_BUFFER
                  Memory_Copy(znFAT_Buffer,pbuf,temp); //°Ñ²»×ãÒ»ÉÈÇøµÄÊı¾İÏÈ·ÅÈëÄÚ²¿»º³åÇøÖĞ
                  znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer); //½«ÄÚ²¿»º³åÇøÖĞµÄÊı¾İĞ´ÈëÉÈÇøÖĞ
                                                                       //Èç¹ûÖ±½ÓÊ¹ÓÃpbuf×÷Êı¾İÔ´À´Ğ´Èë£¬Òò²»×ãÒ»¸öÉÈÇø
                                                                       //´Ó¶ø»áÔì³ÉÄÚ´æÒç³ö,³ÌĞò±ÀÀ£
                  #else
                  #ifndef USE_ALONE_EXB
                  if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                  {
                 if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                 {
                  Dev_No=sexb_cur_dev;
                  znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
              
                    Dev_No=old_devno;
                 }
                  }
                  else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                  {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 77  

                 if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                 {
                  if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                  {
                   znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖ
             -Ğ
                  }    
                 }
                  }
                  #endif
              
                  Memory_Copy(pexb_buf,pbuf,temp);
              
                  #ifndef USE_ALONE_EXB
                  sexb_cur_sec=pfi->File_CurSec;
                sexb_cur_dev=Dev_No; //¼ÇÂ¼µ±Ç°½»»»»º³åÖĞÊı¾İËùÔÚµÄÉè±¸ºÅ
                psexb_cur_oc=pfi; //¼ÇÂ¼EXBÖĞ»º³åµÄÊı¾İÊôÓÚÄÄ¸öÎÄ¼ş
                  #else
                  just_file->exb_cursec=pfi->File_CurSec;
                  #endif
                  #endif   
                
                pfi->File_CurPos=(UINT16)temp;
                 }
                }
                else //Èç¹ûÏÂÒ»´ØÒÑÎª½áÊø´Ø£¬¼´ºóÃæÒÑÎŞÊı¾İÔÙÒªĞ´Èë
                {
                 znFAT_Device_Write_nSector(temp,SOC(start_clu),pbuf);
                 pbuf+=((temp+temp1)*(pInit_Args->BytesPerSector)); 
              
                 pfi->File_CurClust=end_clu;
                 pfi->File_CurSec=SOC(end_clu);
                }
               }
              
               //========================ÒÔÉÏ´úÂëÓÃÓÚ´¦ÀíÕû´ØÓëÕûÉÈÇøÊı¾İµÄĞ´Èë£¬¾¡¿ÉÄÜÀûÓÃÁËÉÈÇøµÄÁ¬ĞøĞÔ===============
             -=========
               #ifdef RT_UPDATE_FSINFO
               Update_FSINFO();
               #endif
              
               pfi->File_CurOffset+=len;
              
               return len;
              } 
              #endif
4681          
4682          /************************************************************************************
4683           ¹¦ÄÜ£ºÏòÎÄ¼şÖĞĞ´ÈëÊı¾İ
4684           ĞÎ²Î£ºpfi:Ö¸ÕëÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë len:ÒªĞ´ÈëµÄÊı¾İÁ¿ pbuf:Ö¸ÏòÊı¾İ»º³åÇøµÄÖ¸Õë
4685           ·µ»Ø£ºÊµ¼ÊÏòÎÄ¼şÖĞĞ´ÈëµÄÊı¾İÁ¿  Èç¹ûÎÄ¼ş´óĞ¡ÒÑ¾­´ïµ½FAT32ÖĞËùÏŞÖÆµÄ¼«ÏŞ£¬·µ»Ø-2
4686           Ïê½â£ºÕâÊÇ×îÖÕ¹©Ê¹ÓÃÕßµ÷ÓÃµÄÎÄ¼şÊı¾İĞ´Èëº¯Êı£¬Ëü×ÜÊÇ´ÓÎÄ¼şµÄÄ©Î²ÏòºóĞ´ÈëÊı¾İ£¬¼´Êı¾İ
4687                 ÊÇÒÔ×·¼ÓµÄ·½Ê½±»Ğ´ÈëµÄ¡£ÔÚÊı¾İĞ´ÈëÖ®ºó£¬Òª¼°Ê±µÄ¸üĞÂÎÄ¼ş´óĞ¡£¬·ñÔòĞ´ÈëµÄÊı¾İ½«
4688                 ²»¿É¼û¡£¿ÉÒÔ´ò¿ªRT_UPDATE_FILESIZEºêÀ´¿ªÆôÊµÊ±ÎÄ¼ş´óĞ¡¸üĞÂ¹¦ÄÜ£¬¼´Ã¿´ÎĞ´ÈëÊı¾İ
4689                 znFAT¶¼»áÈ¥¸üĞÂÎÄ¼ş´óĞ¡£¬ÕâÖÖ¹¤×÷·½Ê½ÏÂÄÄÅÂÖĞ¼äÍ»È»¶Ïµç»òËÀ»ú¶¼Ã»ÓĞ¹ØÏµ£¬¿ÉÒÔ
4690                 ±£Ö¤ÎÄ¼ş´óĞ¡ÈçÊµ·´Ó³ÎÄ¼şµÄÓĞĞ§Êı¾İÁ¿£¬µ«ÕâÖÖ·½Ê½Ê¹Êı¾İĞ´ÈëµÄËÙ¶ÈºÍĞ§ÂÊ±äÂı¡£Èô
4691                 ²»Ê¹ÓÃ´Ëºê£¬ÔòĞèÒªÊ¹ÓÃÕßÔÚËùÓĞĞ´ÈëÊı¾İµÄ²Ù×÷Íê³ÉÖ®ºó£¬µ÷ÓÃ¸üĞÂÎÄ¼ş´óĞ¡µÄº¯Êı¡£
4692          *************************************************************************************/
4693          #ifdef ZNFAT_WRITEDATA
              UINT32 znFAT_WriteData(struct FileInfo *pfi,UINT32 len,UINT8 *pbuf)
              {
               UINT32 temp=0,temp1=0,len_temp=len;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 78  

               UINT32 Cluster_Size=((pInit_Args->BytesPerSector)*(pInit_Args->SectorsPerClust));
              
               #ifdef USE_EXCHANGE_BUFFER
               #ifndef USE_ALONE_EXB
               UINT8 old_devno=Dev_No;
               #else
               pexb_buf=(pfi->exb_buf);
               #endif
               #endif
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               if(0==len) return 0; //Èç¹ûÒªĞ´ÈëµÄÊı¾İ³¤¶ÈÎª0£¬ÔòÖ±½Ó·µ»Ø0
              
               if(len>(0XFFFFFFFF-pfi->File_Size)) return (UINT32)-2; //ÎÄ¼ş´óĞ¡ÔÚĞ´ÈëÊı¾İºó½«·¢ÉúÒç³ö´íÎó
               
               znFAT_Seek(pfi,pfi->File_Size); //ÎÄ¼şÊı¾İ¶¨Î»µ½ÎÄ¼şÄ©Î²£¬ÎÄ¼şÎ»ÖÃÏà¹ØĞÅÏ¢Ëæ¼´¸Ä±ä
              
               //¼ì²é´ÅÅÌÊ£Óà¿Õ¼äÊÇ·ñ¹»ÓÃ
               if((pfi->File_CurOffset%Cluster_Size)!=0)
               {
                temp=((pInit_Args->BytesPerSector)-(pfi->File_CurPos))+((LAST_SEC_OF_CLU(pfi->File_CurClust))-(pfi->File
             -_CurSec))*(Cluster_Size);
                //µ±Ç°´ØÊ£ÓàÊı¾İÁ¿
              
                if(len>temp) //Èç¹ûÒªĞ´ÈëµÄÊı¾İÁ¿´óÓÚtemp£¬ÔòËµÃ÷±ØÈ»»á³¬³öµ±Ç°´Ø£¬ÎªÆäÀ©Õ¹¿Õ´Ø
                {
                 temp1=(len-temp)/(Cluster_Size);
                 if((len-temp)%(Cluster_Size)) temp1++; //¼ÆËãĞèÒª¶àÉÙ¸ö¿Õ´Ø
              
                 if(temp1>(pInit_Args->Free_nCluster)) return ((UINT32)-1); //¿Õ¼ä²»×ã
                }
              
               }
               else
               {
                temp1=len/(Cluster_Size);
                if(len%(Cluster_Size)) temp1++; //¼ÆËãĞèÒª¶àÉÙ¸ö¿Õ´Ø  
                if(temp1>(pInit_Args->Free_nCluster)) return ((UINT32)-1); //¿Õ¼ä²»×ã
               }
              
               //=======================================================================================================
             -====
              
               temp=((pInit_Args->BytesPerSector)-(pfi->File_CurPos)); //¼ÆËã¸³¸øÁÙÊ±±äÁ¿£¬ÒÔÃâºóÃæÖØ¸´¼ÆËã
              
               if((pfi->File_CurOffset%Cluster_Size)!=0)
               {
                if(len<=temp) //ÒªĞ´ÈëµÄÊı¾İĞ¡ÓÚµÈÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
                {
                 #ifndef USE_EXCHANGE_BUFFER
                 znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //¶ÁÈ¡µ±Ç°ÉÈÇøÊı¾İ£¬ÒÔ±ã×÷ÉÈÇøÄÚÊı¾İÆ´½Ó
                 Memory_Copy(znFAT_Buffer+pfi->File_CurPos,pbuf,len); //ÉÈÇøÊı¾İÆ´½Ó
                 znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer); //»ØĞ´ÉÈÇøÊı¾İ
                 #endif
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 79  

              
                 if(len==temp) //Èç¹ûÒªĞ´ÈëµÄÊı¾İÕıºÃÕ¼Âúµ±Ç°ÉÈÇø
                 {
                #ifdef USE_EXCHANGE_BUFFER
                if(0!=pfi->File_CurPos) 
                {
                   #ifndef USE_ALONE_EXB
                 if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                 {
                  if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                  {
                   Dev_No=sexb_cur_dev;
                   znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖ
             -Ğ
              
                     Dev_No=old_devno;
                  }
                  znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                 }
                 else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                 {
                  if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                  {
                   if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                   {
                    znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇø
             -ÖĞ
              
                    znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                   }     
                  }
                 }
              
                   #else
                 if(0==(just_file->exb_cursec)) 
                 {
                  znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf);
                 }
                   #endif
              
                 Memory_Copy(pexb_buf+pfi->File_CurPos,pbuf,len); //ÉÈÇøÊı¾İÆ´½Ó
              
                   znFAT_Device_Write_Sector(pfi->File_CurSec,pexb_buf); //»ØĞ´ÉÈÇøÊı¾İ
                   
                   #ifndef USE_ALONE_EXB
                 sexb_cur_sec=0; //Ã¿´ÎEXBÖĞµÄÊı¾İÒÔÕûÉÈÇøÊı¾İ»ØĞ´Ö®ºó£¬ÎÒÃÇ±ãÈÏÎªËü²»ÔÙ±»Õ¼ÓÃÁË
                 sexb_cur_dev=(UINT8)(-1); //EXBµÄµ±Ç°Éè±¸ºÅÖÃÎª¿Õ£¬ÕâÀïÈ¡-1ÈÏ¶¨ÆäÎª¿Õ£¬ÎªÁËÓëÓĞĞ§Éè±¸ºÅ0ÏàÇø·Ö
                 psexb_cur_oc=(struct FileInfo *)0; //´ËÊ±EXB²»¹éÈÎºÎÎÄ¼şËùÓĞ
                   #else
                 (just_file->exb_cursec)=0; //ÎÄ¼şµÄ¶ÀÁ¢EXBÎ´Õ¼ÓÃ
                   #endif
                }
                else
                {
                 znFAT_Device_Write_Sector(pfi->File_CurSec,pbuf); //»ØĞ´ÉÈÇøÊı¾İ
                }
                  #endif
              
                if(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust)) //Èç¹ûµ±Ç°ÉÈÇøÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
                {
                 pfi->File_CurSec=SOC(pfi->File_CurClust); //¸üĞÂµ±Ç°ÉÈÇø£¬ÆäÊµÎŞĞ§£¬ÎªÁË¹æÕû
                }
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 80  

                else //µ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÉÈÇø
                {
                 pfi->File_CurSec++;
                }
              
                pfi->File_CurPos=0;
                pfi->File_CurOffset+=len; //¸üĞÂµ±Ç°Æ«ÒÆÁ¿
                pfi->File_Size+=len; //¸üĞÂÎÄ¼ş´óĞ¡
                   
                  #ifdef RT_UPDATE_FILESIZE
                Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
                  #endif
              
                return len;
                 }
                 else//lenĞ¡ÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
                 {  
                #ifdef USE_EXCHANGE_BUFFER
                  #ifndef USE_ALONE_EXB
                if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                {
                 if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                 {
                  Dev_No=sexb_cur_dev;
                  znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
              
                    Dev_No=old_devno; 
                 }
                 znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf);
                }
                else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                {
                 if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                 {
                  if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                  {
                   znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖ
             -Ğ
              
                   znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                  }    
                 }
                }
                  #else
                if((0==(just_file->exb_cursec)) && (0!=(pfi->File_CurPos))) //µ±Ç°ÎÄ¼şµÄ¶ÀÁ¢EXBÎ´±»Õ¼ÓÃ£¬ÇÒÎÄ¼şµ±Ç°ÉÈÇøÄÚ
             -Æ«ÒÆ²»Îª0£¬Èç¹ûÎª0ÔòÃ»±ØÒª¶ÁÉÈÇø
                {
                 znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf);
                }
                  #endif
              
                Memory_Copy(pexb_buf+pfi->File_CurPos,pbuf,len); //ÉÈÇøÊı¾İÆ´½Ó
              
                  #ifndef USE_ALONE_EXB
                sexb_cur_dev=Dev_No;
                sexb_cur_sec=pfi->File_CurSec;
                psexb_cur_oc=pfi; //¼ÇÂ¼EXBÖĞ»º³åµÄÊı¾İÊôÓÚÄÄ¸öÎÄ¼ş
                  #else
                (just_file->exb_cursec)=pfi->File_CurSec;
                  #endif
                  #endif
                  //znFAT_Device_Write_Sector(pfi->File_CurSec,ex_buf); //»ØĞ´ÉÈÇøÊı¾İ
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 81  

              
                  pfi->File_CurPos+=(UINT16)len;
                  pfi->File_CurOffset+=len; //¸üĞÂµ±Ç°Æ«ÒÆÁ¿
                  pfi->File_Size+=len; //¸üĞÂÎÄ¼ş´óĞ¡ 
                
                  #ifdef RT_UPDATE_FILESIZE
                Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
                  #endif
              
                return len;  
                 }
                }
                else 
                {
                 #ifndef USE_EXCHANGE_BUFFER
                 znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //¶ÁÈ¡µ±Ç°ÉÈÇø
                 Memory_Copy(znFAT_Buffer+pfi->File_CurPos,pbuf,temp); //ÉÈÇøÊı¾İÆ´½Ó
                 znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer); //»ØĞ´ÉÈÇø
                 #else
              
                 if(0!=pfi->File_CurPos) 
                 {
                  #ifndef USE_ALONE_EXB
                if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                {
                 if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                 {
                  Dev_No=sexb_cur_dev;
                  znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
              
                    Dev_No=old_devno;
                 }
                 znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                }
                else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                {
                 if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                 {
                  if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                  {
                   znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖ
             -Ğ
              
                   znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                  }    
                 }
                }
                  #else
                if(0==(just_file->exb_cursec)) 
                {
                 znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf);
                }
                  #endif
              
                Memory_Copy(pexb_buf+pfi->File_CurPos,pbuf,temp); //ÉÈÇøÊı¾İÆ´½Ó
              
                  znFAT_Device_Write_Sector(pfi->File_CurSec,pexb_buf); //»ØĞ´ÉÈÇøÊı¾İ
              
                  #ifndef USE_ALONE_EXB
                sexb_cur_sec=0; //Ã¿´ÎEXBÖĞµÄÊı¾İÒÔÕûÉÈÇøÊı¾İ»ØĞ´Ö®ºó£¬ÎÒÃÇ±ãÈÏÎªËü²»ÔÙ±»Õ¼ÓÃÁË
                sexb_cur_dev=(UINT8)(-1); //EXBµÄµ±Ç°Éè±¸ºÅÖÃÎª¿Õ£¬ÕâÀïÈ¡-1ÈÏ¶¨ÆäÎª¿Õ£¬ÎªÁËÓëÓĞĞ§Éè±¸ºÅ0ÏàÇø·Ö
                psexb_cur_oc=(struct FileInfo *)0;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 82  

                  #else
                (just_file->exb_cursec)=0; //µ±Ç°ÎÄ¼ş¶ÀÁ¢EXBÎ´±»Õ¼ÓÃ
                  #endif
                 }
                 else //Èç¹ûµ±Ç°Î»ÖÃÔÚ0Î»ÖÃ£¬ÔòÖ±½ÓĞ´ÉÈÇø
                 {
                znFAT_Device_Write_Sector(pfi->File_CurSec,pbuf); //»ØĞ´ÉÈÇøÊı¾İ
                 }
                 #endif
              
                 len_temp-=temp;
                 pbuf+=temp;
              
                 if(!(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
                 {
                pfi->File_CurSec++;
                pfi->File_CurPos=0;
              
                  pfi->File_CurOffset+=temp;
              
                  temp=(LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec)+1)*(pInit_Args->BytesPerSector);//µ±Ç°´ØÖ
             -ĞµÄÊ£ÓàÕûÕûÉÈÇøÊı¾İÁ¿
              
                  if(len_temp<=temp) //Èç¹ûÒªĞ´ÈëµÄÊı¾İÁ¿Ğ¡ÓÚµÈÓÚµ±Ç°´ØÖĞµÄÊ£ÓàÕûÉÈÇøÊı¾İÁ¿
                {
                 temp1=len_temp/(pInit_Args->BytesPerSector); //¼ÆËãÒªĞ´ÈëµÄÊı¾İÁ¿¹»¼¸¸öÕûÉÈÇø
              
                 znFAT_Device_Write_nSector(temp1,pfi->File_CurSec,pbuf);
                 pbuf+=((pInit_Args->BytesPerSector)*temp1);
              
                 if(len_temp==temp) //Èç¹ûÕıºÃĞ´Âúµ±Ç°´Ø
                 {
                  pfi->File_CurSec=SOC(pfi->File_CurClust); //å´Ø
                  pfi->File_CurPos=0;
              
                  pfi->File_CurOffset+=len_temp;
                  pfi->File_Size+=len;
              
                    #ifdef RT_UPDATE_FILESIZE
                    Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
                    #endif
              
                  return len;
                 }
                 else
                 {
                  pfi->File_CurSec+=temp1;
                  pfi->File_CurPos=(UINT16)(len_temp%(pInit_Args->BytesPerSector));
              
                  if(pfi->File_CurPos) //»¹ÓĞÒªĞ´µÄÊı¾İ,´¦Àí×îºóµÄ×Ö½ÚÊı¾İ
                  {
                     #ifndef USE_EXCHANGE_BUFFER
                   Memory_Copy(znFAT_Buffer,pbuf,pfi->File_CurPos);
                   znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer);
                     #else
                     #ifndef USE_ALONE_EXB
                     if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                   {
                    if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                  {
                     Dev_No=sexb_cur_dev;
                     znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇ
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 83  

             -øÖĞ
              
                       Dev_No=old_devno;
                  }
                   }
                     else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                   {
                    if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                  {
                     if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                   {
                      znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈ
             -ÇøÖĞ
                   }     
                  }
                   }
                     #endif
              
                   Memory_Copy(pexb_buf,pbuf,pfi->File_CurPos);
              
                     #ifndef USE_ALONE_EXB
                   sexb_cur_sec=pfi->File_CurSec;
                   sexb_cur_dev=Dev_No;
                   psexb_cur_oc=pfi; //¼ÇÂ¼EXBÖĞ»º³åµÄÊı¾İÊôÓÚÄÄ¸öÎÄ¼ş
                     #else
                   just_file->exb_cursec=pfi->File_CurSec;
                     #endif
                     #endif
                  }
              
                    pfi->File_CurOffset+=len_temp;
                  pfi->File_Size+=len;
              
                    #ifdef RT_UPDATE_FILESIZE
                    Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
                    #endif
              
                  return len;
                 }
                }
                else
                {
                 temp1=temp/(pInit_Args->BytesPerSector);
              
                 znFAT_Device_Write_nSector(temp1,pfi->File_CurSec,pbuf);
                 pbuf+=temp;
              
                 len_temp-=temp;
              
                 pfi->File_CurSec=SOC(pfi->File_CurClust);
                 pfi->File_CurPos=0;
              
                 pfi->File_CurOffset+=temp;  
                }
                 }
                 else //µ±Ç°ÉÈÇøÊÇµ±Ç°´Ø×îºóÒ»¸öÉÈÇø
                 {
                pfi->File_CurSec=SOC(pfi->File_CurClust);
                pfi->File_CurPos=0;
              
                pfi->File_CurOffset+=temp;     
                 }   
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 84  

                }
               }
              
               //Èç¹ûÎÄ¼şµÄµ±Ç°Æ«ÒÆÁ¿ÊÇ´Ø´óĞ¡µÄÕûÊı±¶£¬Ôò
               //Ö±½Ó½øÈë¿ÕÎÄ¼ş¿ªÊ¼Î»ÖÃ»òÕû´ØÎ»ÖÃĞ´Êı¾İµÄ½×¶Î
               WriteData_From_nCluster(pfi,len_temp,pbuf); //´Ó¿ÕÎÄ¼ş¿ªÊ¼Î»ÖÃ»òÕû´ØÎ»ÖÃĞ´Êı¾İ£¬´ËÊ±¶¼ÊÇÒ»ÖÖ¡°¾½¾³´Ø¡±µÄÇ
             -é¿ö
                                                            //ÕâÖÖÇé¿öÏÂ£¬Êı¾İÕıºÃÍ£Ö¹ÓÚÄ©´ØµÄÄ©Î²»òÊÇ¿ÕÎÄ¼ş¶øÃ»ÓĞÊı¾İ£¬
             -Í¨
                                                            //³£ÎÄ¼şĞÅÏ¢¼¯ºÏÖĞ¼ÇÂ¼µÄÎÄ¼şÎ»ÖÃĞÅÏ¢Ó¦¸ÃÊÇÏÂÒ»´ØµÄ×î¿ªÊ¼Î»ÖÃ
             -£¬
                                                            //µ«ÊÇÕâ¸öÊ±ºòÏÂÒ»´ØÉĞÃ»ÓĞ±»·ÖÅä£¬¼´ÎÄ¼şÄ©´ØµÄFAT´ØÏî¼ÇÂ¼µÄÊ
             -Ç
                                                            //0XFFFFFF0F£¨´ØÁ´½áÊø±ê¼Ç£©£¬Òò´Ë´ËÊ±µÄÎÄ¼şÎ»ÖÃĞÅÏ¢ÊÇÎŞĞ§µÄ
                                                            //znFATÖĞ×÷³öÔ¼¶¨:¡°¾½¾³´Ø¡±Çé¿öÏÂ£¬¿ÕÎÄ¼şµ±Ç°´ØÎª0£¬ÔÚÄ©´ØÄ
             -©Î²
                                                            //Ê±£¬µ±Ç°´ØÎªÄ©´Ø¡£ÕâÖÖÔ¼¶¨±ãÓÚznFATµÄÊı¾İĞ´Èë¹¦ÄÜÔÚ¡°¾½¾³´
             -Ø¡±
                                                            //Çé¿öÏÂµÄÕıÈ·ĞÔ
               pfi->File_Size+=len;
               
               #ifdef RT_UPDATE_FILESIZE
               Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
               #endif
              
               return len;
              }
              #endif
5081          
5082          /************************************************************************************
5083           ¹¦ÄÜ£ºÎÄ¼şÊı¾İ½Ø¶Ï
5084           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë offset:Òª½øĞĞÊı¾İ½Ø¶ÏµÄÆğÊ¼Î»ÖÃ
5085           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»òÊ§°Ü 
5086           Ïê½â£º´Ëº¯ÊıÓÃÓÚ½«ÎÄ¼şµÄÊı¾İ´ÓoffsetÎ»ÖÃ½øĞĞ½Ø¶Ï£¬¼´´Ó´ËÎ»ÖÃºóÃæµÄÊı¾İ¾ù±»É¾³ı¡£Èç¹û
5087                 Ö¸¶¨µÄoffsetÈç¹û´óÓÚµÈÓÚÎÄ¼şµÄ´óĞ¡£¬ÔòÖ±½Ó·µ»Ø´íÎó¡£
5088          *************************************************************************************/
5089          #ifdef ZNFAT_DUMP_DATA
              UINT8 znFAT_Dump_Data(struct FileInfo *pfi,UINT32 offset)
              {
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               if(offset>=(pfi->File_Size)) //Òª½Ø¶ÏµÄÎ»ÖÃ³¬³öÎÄ¼ş·¶Î§
               {
                return ERR_FAIL;
               }
              
               znFAT_Seek(pfi,offset); //¶¨Î»µ½Òª½Ø¶ÏµÄÎ»ÖÃ
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN //Ïú»ÙÖ®Ç°£¬ÏÈ°ÑCCCBÖĞµÄ´ØÁ´¶Î¸üĞÂµ½FAT
               #ifndef USE_ALONE_CCCB
               if(pfi==pcccb_cur_oc) 
               #endif
               {
                CCCB_Update_FAT();
               }
               #endif
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 85  

              
               Destroy_FAT_Chain(pfi->File_CurClust); //Ïú»Ù´ØÁ´
              
               if(offset>0)
               {
                Modify_FAT(pfi->File_CurClust,0X0FFFFFFF); //´ØÁ´·â¿Ú
               }
              
               pfi->File_Size=offset; //¸üĞÂÎÄ¼ş´óĞ¡
              
               #ifdef RT_UPDATE_FILESIZE
               Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
               #endif
              
               if(0==pfi->File_Size) Update_File_sClust(pfi,0); //Èç¹ûÎÄ¼ş´óĞ¡Îª0£¬¸üĞÂÎÄ¼ş¿ªÊ¼´ØÎª0
              
               #ifdef RT_UPDATE_FSINFO
               Update_FSINFO();
               #endif
              
               return ERR_SUCC;
              }
              #endif
5138          
5139          #ifdef ZNFAT_MODIFY_DATA
              UINT32 znFAT_Modify_Data(struct FileInfo *pfi,UINT32 offset,UINT32 len,UINT8 *app_Buffer)
              {
               UINT32 temp_len=0,temp=0,nsec=0,iClu=0,start_clu=0,end_clu=0,next_clu=0,temp2=0,temp1=0;
               UINT32 Cluster_Size=((pInit_Args->BytesPerSector)*(pInit_Args->SectorsPerClust));
              
               if(offset>=(pfi->File_Size)) return ERR_MD_POS_OVER_FSIZE; //Èç¹ûÒªĞŞ¸ÄµÄÊı¾İÎ»ÖÃ³¬³öÎÄ¼ş´óĞ¡
              
               if((offset+len)>=(pfi->File_Size))  //´ÓoffsetÎ»ÖÃÒª¸ÄĞ´µÄÊı¾İ³¤¶È³¤ÓÚÎÄ¼ş³¤¶È£¬ÔòÈ¡Êµ¼Ê³¤¶È
               {
                len=(pfi->File_Size)-offset;
                (pfi->File_IsEOF)=1; //´ËÖÖÇé¿öÒ»¶¨»áĞŞ¸Äµ½ÎÄ¼ş×îÄ©Î²£¬ÎÄ¼ş½«´ïµ½½áÊøÎ»ÖÃ
               }
              
               temp_len=len; 
              
               znFAT_Seek(pfi,offset); //¶¨Î»ÎÄ¼şoffsetÎ»ÖÃ£¬¶¨Î»Ö®ºóÎÄ¼şĞÅÏ¢ÌåÏà¹Ø±äÁ¿¼´µÃµ½¸üĞÂ
              
               //======================================ÏÂÃæ¿ªÊ¼¶ÔÊı¾İ½øĞĞ¸ÄĞ´==================================
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN //Èç¹ûÊ¹ÓÃÁËCCCB»º³å£¬ÔòĞèÒª´ò¿ªÔÚCCCBÖĞÑ°´ØµÄ±ê¼Ç
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB //Èç¹ûÊ¹ÓÃÁË¶ÀÁ¢CCCB»º³å£¬Ôò°ÑCCCB´òµ½µ±Ç°Ëù²Ù×÷ÎÄ¼şµÄCCCB
               CCCB_To_Alone();
               #endif
               #endif 
               //==============================================================================================
               if(((pfi->File_CurOffset)%Cluster_Size)!=0) //Èç¹ûµ±Ç°Î»ÖÃ·Ç´Ø´óĞ¡ÕûÊı±¶£¬¼´²»ÔÚ´Ø¿ªÊ¼Î»ÖÃ
               {
                if(((pfi->File_CurOffset)%(pInit_Args->BytesPerSector))!=0) //Èç¹ûµ±Ç°Î»ÖÃ·ÇÕûÉÈÇø´óĞ¡ÕûÊı±¶£¬¼´²»ÔÚÉÈÇø
             -¿ªÊ¼Î»ÖÃ
                {
                 if(len<=((pInit_Args->BytesPerSector)-(pfi->File_CurPos))) //Èç¹ûÒªĞŞ¸ÄµÄÊı¾İ³¤¶ÈĞ¡ÓÚµÈÓÚÎÄ¼şµ±Ç°ÉÈÇøÊ£
             -ÓàÊı¾İÁ¿
                 {
                //Èç¹ûÆôÓÃÁËEXB»º³å£¬Ôò´Ë²»×ãÉÈÇøµÄÊı¾İ£¬¿ÉÄÜ²¢²»ÔÚÎïÀíÉÈÇøÖĞ£¬¶øÔÚEXB»º³åÖĞ
                  #ifdef USE_EXCHANGE_BUFFER //Èç¹ûÊ¹ÓÃÁËEXB»º³å
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 86  

                  #ifndef USE_ALONE_EXB //Èç¹ûÃ»ÓĞÆôÓÃ¶ÀÁ¢EXB»º³å£¬¼´ÆôÓÃÁË¹²ÏíEXB»º³å
                  if((psexb_cur_oc==pfi)&&(sexb_cur_dev==Dev_No)&&(sexb_cur_sec==(pfi->File_CurSec))) //Èç¹û´ËÊ±ÎÄ¼şÕıÕ¼
             -ÓÃ¹²ÏíEXB£¬Í¬Ê±µ±Ç°ÎÄ¼şËùÔÚµÄÉè±¸ÓëÉÈÇøºÍ¹²ÏíEXBÏà·û
                {
                 Memory_Copy(pexb_buf+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚ¹²ÏíEXBÖĞµÄÊı¾İ
                }
                else //·ñÔòÒªĞŞ¸ÄµÄÊı¾İ²»ÔÚEXBÖĞ£¬¶øÔÚÎïÀíÉÈÇøÖĞ
                {
                 znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                   Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                   znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                }
                  #else //Èç¹ûÆô¶¯¶ÀÁ¢EXB»º³å
                if((pfi->exb_cursec)==(pfi->File_CurSec)) //Èç¹û´ËÎÄ¼şµÄEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇøÒ»ÖÂ£¬ÔòËµÃ÷ÒªĞŞ¸ÄµÄÊı¾İ
             -ÔÚ´ËÎÄ¼şµÄEXBÖĞ
                {
                 Memory_Copy((pfi->exb_buf)+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÎÄ¼ş¶ÀÁ¢EXBÖĞµÄÊı¾İ
                }
                else //Èç¹û´ËÎÄ¼şEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇø²»Ò»ÖÂ£¬ÒªĞŞ¸ÄµÄÊı¾İÔÚÎïÀíÉÈÇøÖĞ
                {
                 znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                   Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                   znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ  
                }
                  
                  #endif
                  #else //Èç¹ûÃ»ÓĞÊ¹ÓÃEXB»º³å£¬ÔòÖ±½ÓĞŞ¸ÄÎïÀíÉÈÇøÊı¾İ
                znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                  Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                  znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                  
                  #endif
              
                  //ÒÔÏÂ¸üĞÂÎÄ¼şÎ»ÖÃĞÅÏ¢
                if(len<((pInit_Args->BytesPerSector)-(pfi->File_CurPos))) //ÒªĞŞ¸ÄµÄÊı¾İÁ¿Ğ¡ÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
                {
                 (pfi->File_CurOffset)+=len;
                 (pfi->File_CurPos)+=len;
                }
                  else
                if(len==((pInit_Args->BytesPerSector)-(pfi->File_CurPos))) //ÒªĞŞ¸ÄµÄÊı¾İÁ¿µÈÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
                {
                   if((len+(pfi->File_CurOffset))==(pfi->File_Size)) //ÕıºÃĞ´µ½ÎÄ¼şÄ©Î²
                 {
                  if(((pfi->File_Size)%Cluster_Size)==0) //Èç¹ûÎÄ¼ş´óĞ¡Îª´Ø´óĞ¡ÕûÊı±¶£¬¼´´ËÊ±²úÉúÁË¡°å´Ø¡±
                  {
                   (pfi->File_CurOffset)+=len;
                   (pfi->File_CurPos)=0;
                   (pfi->File_CurSec)=SOC((pfi->File_CurClust));
                  }
                  else //Èç¹ûÎÄ¼ş´óĞ¡·Ç´Ø´óĞ¡ÕûÊı±¶£¬¼´´ËÊ±Êı¾İĞ´µ½ÁË·Ç´ØÄ©ÉÈÇøÄ©Î²
                  {
                   (pfi->File_CurOffset)+=len;
                   (pfi->File_CurPos)=0;
                   (pfi->File_CurSec)++;
                  }
                 }
                 else
                 {
                  if(((len+(pfi->File_CurOffset))%Cluster_Size)==0) //Èç¹ûĞ´µ½µÄÎ»ÖÃÕıºÃÊÇ´Ø´óĞ¡ÕûÊı±¶£¬¶ø´ËÊ±²¢Ã»ÓĞµ½ÎÄ¼
             -şÄ©Î²
                  {
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 87  

                   (pfi->File_CurOffset)+=len;
                   (pfi->File_CurPos)=0;
                   (pfi->File_CurClust)=Get_Next_Cluster((pfi->File_CurClust));
                   (pfi->File_CurSec)=SOC((pfi->File_CurClust));     
                  }
                  else //Èç¹ûĞ´µ½µÄÎ»ÖÃ·Ç´Ø´óĞ¡ÕûÊı±¶£¬¼´´ËÊ±Êı¾İĞ´µ½ÁË·Ç´ØÄ©ÉÈÇøÄ©Î²
                  {
                   (pfi->File_CurOffset)+=len;
                   (pfi->File_CurPos)=0;
                   (pfi->File_CurSec)++;
                  }
                 }
                }
                return temp_len;
                 }
                 else //ÒªĞŞ¸ÄµÄÊı¾İ³¤¶È´óÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
                 {
                temp=(pInit_Args->BytesPerSector)-(pfi->File_CurPos);
                znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer);
                  Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,temp);
                znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer);
                len-=temp;app_Buffer+=temp;
                  (pfi->File_CurOffset)+=temp;
              
                (pfi->File_CurPos)=0;
              
                  if(!IS_END_SEC_OF_CLU((pfi->File_CurSec),(pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ½áÊøÉÈÇø
                {
                 (pfi->File_CurSec)++;
                }
                else
                {
                 (pfi->File_CurClust)=Get_Next_Cluster((pfi->File_CurClust));
                 (pfi->File_CurSec)=SOC((pfi->File_CurClust));
                }
                 }
                }
              
                if(((pfi->File_CurOffset)%(Cluster_Size))!=0) //ÕâÀïÔÙ´ÎÅĞ¶Ï´ËÊ±µÄÎ»ÖÃÊÇ·ñÔÚÕû´Ø¿ªÊ¼£¬ÎªÁËºóÃæµÄÍ³Ò»»¯´¦
             -Àí
                {
                 temp=(((SOC(pfi->File_CurClust))+(pInit_Args->SectorsPerClust)-1)-(pfi->File_CurSec)+1)*(pInit_Args->By
             -tesPerSector);
              
                 if(len<=temp) //ÒªĞŞ¸ÄµÄÊ£ÓàÊı¾İÁ¿Ğ¡ÓÚµÈÓÚµ±Ç°ÕûÉÈÇøµÄÊ£ÓàÊı¾İÁ¿
                 {
                  nsec=len/(pInit_Args->BytesPerSector); //¼ÆËãÒªĞŞ¸ÄµÄÊ£ÓàÊı¾İÁ¿ÖĞµÄÕûÉÈÇøÊı
                  znFAT_Device_Write_nSector(nsec,(pfi->File_CurSec),app_Buffer); //Ïòµ±Ç°´ØÄÚÒªĞŞ¸ÄµÄÕûÉÈÇøÊı¾İ²¿·ÖĞ´Èë
             -Êı¾İ
                  temp=(nsec*(pInit_Args->BytesPerSector));
                  len-=temp;app_Buffer+=temp;
              
                  (pfi->File_CurOffset)+=temp;
              
                  if(len==0) //ÒªĞŞ¸ÄµÄÊı¾İÕıºÃĞ´Âúµ±Ç°´Ø
                {
                   if((pfi->File_CurOffset)==(pfi->File_Size)) //Èç¹ûÕıºÃĞ´µ½ÁËÎÄ¼şÄ©Î²£¬Ôò´ËÊ±²úÉú¡°å´Ø¡±
                 {
                  (pfi->File_CurPos)=0;
                  (pfi->File_CurSec)=SOC((pfi->File_CurClust));
                 }
                   else //Ğ´ÂúÁËµ±Ç°´Ø£¬µ«²¢²»ÊÇÎÄ¼şÄ©Î²
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 88  

                 {
                  (pfi->File_CurClust)=Get_Next_Cluster((pfi->File_CurClust));
                  (pfi->File_CurPos)=0;
                  (pfi->File_CurSec)=SOC((pfi->File_CurClust));
                 }
                }
                  else //Ã»ÓĞĞ´Âúµ±Ç°´Ø
                {
                   (pfi->File_CurPos)=0;
                   (pfi->File_CurSec)+=nsec;
              
                   //Èç¹ûÆôÓÃÁËEXB»º³å£¬Ôò´Ë²»×ãÉÈÇøµÄÊı¾İ£¬¿ÉÄÜ²¢²»ÔÚÎïÀíÉÈÇøÖĞ£¬¶øÔÚEXB»º³åÖĞ
                   #ifdef USE_EXCHANGE_BUFFER //Èç¹ûÊ¹ÓÃÁËEXB»º³å
                   #ifndef USE_ALONE_EXB //Èç¹ûÃ»ÓĞÆôÓÃ¶ÀÁ¢EXB»º³å£¬¼´ÆôÓÃÁË¹²ÏíEXB»º³å
                   if((psexb_cur_oc==pfi)&&(sexb_cur_dev==Dev_No)&&(sexb_cur_sec==(pfi->File_CurSec))) //Èç¹û´ËÊ±ÎÄ¼şÕıÕ
             -¼ÓÃ¹²ÏíEXB£¬Í¬Ê±µ±Ç°ÎÄ¼şËùÔÚµÄÉè±¸ÓëÉÈÇøºÍ¹²ÏíEXBÏà·û
                 {
                  Memory_Copy(pexb_buf+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚ¹²ÏíEXBÖĞµÄÊı¾İ
                 }
                   else //·ñÔòÒªĞŞ¸ÄµÄÊı¾İ²»ÔÚEXBÖĞ£¬¶øÔÚÎïÀíÉÈÇøÖĞ
                 {
                  znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                    Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                    znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                 }
                   #else //Èç¹ûÆô¶¯¶ÀÁ¢EXB»º³å
                   if((pfi->exb_cursec)==(pfi->File_CurSec)) //Èç¹û´ËÎÄ¼şµÄEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇøÒ»ÖÂ£¬ÔòËµÃ÷ÒªĞŞ¸ÄµÄ
             -Êı¾İÔÚ´ËÎÄ¼şµÄEXBÖĞ
                 {
                  Memory_Copy((pfi->exb_buf)+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÎÄ¼ş¶ÀÁ¢EXBÖĞµÄÊı¾İ
                 }
                   else //Èç¹û´ËÎÄ¼şEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇø²»Ò»ÖÂ£¬ÒªĞŞ¸ÄµÄÊı¾İÔÚÎïÀíÉÈÇøÖĞ
                 {
                  znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                    Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                    znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ   
                 }
                 
                   #endif
                   #else //Èç¹ûÃ»ÓĞÊ¹ÓÃEXB»º³å£¬ÔòÖ±½ÓĞŞ¸ÄÎïÀíÉÈÇøÊı¾İ
                   znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                   Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                   znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                 
                   #endif
              
                   (pfi->File_CurOffset)+=len;
                   (pfi->File_CurPos)=len;
                }
              
                return temp_len;
                 }
                 else //ÒªĞŞ¸ÄµÄÊ£ÓàÊı¾İÁ¿´óÓÚµ±Ç°´ØÄÚÊ£ÓàÊı¾İÁ¿
                 {
                  //temp=(pInit_Args->BytesPerSector)-(pfi->File_CurPos);
                  //znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer);
                  //Memory_Copy(znFAT_Buffer,app_Buffer,temp);
                  //znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer);
                  //len-=temp;app_Buffer+=temp;
                  //(pfi->File_CurOffset)+=temp;
                  //(pfi->File_CurSec)++;
              
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 89  

                  temp=(((SOC(pfi->File_CurClust))+(pInit_Args->SectorsPerClust)-1)-(pfi->File_CurSec)+1);
                  znFAT_Device_Write_nSector(temp,(pfi->File_CurSec),app_Buffer); //Ïòµ±Ç°´ØÄÚÒªĞŞ¸ÄµÄÕûÉÈÇøÊı¾İ²¿·ÖĞ´Èë
             -Êı¾İ
                temp*=(pInit_Args->BytesPerSector);
                len-=temp;app_Buffer+=temp;
              
                (pfi->File_CurOffset)+=temp;
                (pfi->File_CurClust)=Get_Next_Cluster((pfi->File_CurClust));
                (pfi->File_CurPos)=0;
                (pfi->File_CurSec)=SOC((pfi->File_CurClust));
                 }
                }
               }
              
               //¼ÆËã¸÷Á¬Ğø´Ø¶Î£¬ÒÔ¾¡¿ÉÄÜµÄÊ¹ÓÃ¶àÉÈÇøĞ´Çı¶¯£¬ÒÔÌá¸ßÊı¾İĞ´ÈëËÙ¶È
               //start_cluÓëend_cluÓÃÓÚ¼ÇÂ¼Á¬Ğø´Ø¶ÎµÄÊ¼Ä©
               temp=(len/Cluster_Size); 
              
               if(temp>0) //Èç¹ûÕû´ØÊı´óÓÚ0£¬ÔòÉæ¼°µ½¶à´ØĞ´
               {
                start_clu=end_clu=(pfi->File_CurClust);
              
                for(iClu=1;iClu<temp;iClu++)
                {
                 next_clu=Get_Next_Cluster(end_clu);
              
                 if((next_clu-1)==end_clu) //Èç¹ûÁ½¸ö´ØÏàÁÙ£¬¼´Á¬Ğø
                 {
                  end_clu=next_clu;
                 }
                 else //Èç¹ûÁ½¸ö´Ø²»ÏàÁÙ£¬¼´Óöµ½´ØÁ´¶Ïµã
                 {
                  znFAT_Device_Write_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Bu
             -ffer);
                  app_Buffer+=((end_clu-start_clu+1)*Cluster_Size);
                  start_clu=next_clu;
                  end_clu=next_clu;
                 }
                } 
                 
                temp2=Get_Next_Cluster(end_clu);
                temp1=(len-temp*Cluster_Size); //ÒªĞŞ¸ÄµÄÊ£ÓàµÄ·ÇÕû´ØÊı¾İ
                   
                if(temp1==0) //ÒÑÎŞÒªĞŞ¸ÄµÄÊı¾İ£¬¼´ÒªĞŞ¸ÄµÄÊı¾İÕıºÃĞ´µ½Õû´Ø
                {
                 znFAT_Device_Write_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Buf
             -fer);
              
                 if(!IS_END_CLU(temp2)) //Èç¹ûÒÑµ½ÁË½áÊø´Ø£¬¼´ÎÄ¼şÒÑµ½Ä©Î²£¬¼´¡°å´Ø¡±
                 {
                  (pfi->File_CurClust)=end_clu;
                 }
                 else
                 {
                  (pfi->File_CurClust)=temp2;    
                 }
              
                 (pfi->File_CurOffset)+=(temp*Cluster_Size);
                 (pfi->File_CurPos)=0;
                 (pfi->File_CurSec)=SOC((pfi->File_CurClust));
              
                 return temp_len;
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 90  

                }
                else
                {
                 if((temp2-1)==end_clu) //ÏÂÒ»´ØÈç¹ûÓëÇ°ÃæÕû´Ø×îºóÒ»´ØÈÔÈ»Á¬Ğø
                 {
                  temp=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+(temp1/(pInit_Args->BytesPerSector))); //Á¬Ğ
             -øÉÈÇøÊı
                  znFAT_Device_Write_nSector(temp,SOC(start_clu),app_Buffer);
              
                  (pfi->File_CurOffset)+=(temp*(pInit_Args->BytesPerSector));
              
                  app_Buffer+=(temp*(pInit_Args->BytesPerSector));
                  len-=(temp*(pInit_Args->BytesPerSector));
                 }
                 else //ÏÂÒ»´ØÓëÇ°Ãæ´Ø²»ÔÙÁ¬Ğø
                 {
                  temp=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust));
                  znFAT_Device_Write_nSector(temp,SOC(start_clu),app_Buffer);
                  iClu=(temp*(pInit_Args->BytesPerSector)); //½èÓÃÁÙÊ±±äÁ¿£¬¼õÉÙ¼ÆËãÁ¿
                  app_Buffer+=iClu;len-=iClu;
                  (pfi->File_CurOffset)+=iClu;
              
                  znFAT_Device_Write_nSector((temp1/(pInit_Args->BytesPerSector)),SOC(temp2),app_Buffer);
                  iClu=((temp1/(pInit_Args->BytesPerSector))*(pInit_Args->BytesPerSector)); //½èÓÃÁÙÊ±±äÁ¿£¬¼õÉÙ¼ÆËãÁ¿
                  app_Buffer+=iClu;len-=iClu;
                  (pfi->File_CurOffset)+=iClu;
                 }
              
                 (pfi->File_CurClust)=temp2;
                 (pfi->File_CurPos)=0;
                 (pfi->File_CurSec)=SOC(temp2)+(temp1/(pInit_Args->BytesPerSector));
                }
               }
               else
               {
                temp=len/(pInit_Args->BytesPerSector);
                znFAT_Device_Write_nSector(temp,(pfi->File_CurSec),app_Buffer);
                app_Buffer+=(temp*(pInit_Args->BytesPerSector));
                len-=(temp*(pInit_Args->BytesPerSector));
                (pfi->File_CurOffset)+=(temp*(pInit_Args->BytesPerSector));
                 
                (pfi->File_CurSec)+=temp;
               }
              
               if(len==0) //Èç¹ûÒªĞŞ¸ÄµÄÊı¾İÒÑÎŞ£¬¼´Êı¾İÕıºÃĞ´µ½ÁËÉÈÇøÄ©Î²
               {
                return temp_len;
               }
               else //Èç¹û»¹ÓĞÊı¾İÒªĞŞ¸Ä£¬×îºóµÄ²»×ãÉÈÇø²¿·Ö
               {
                //Èç¹ûÆôÓÃÁËEXB»º³å£¬Ôò´Ë²»×ãÉÈÇøµÄÊı¾İ£¬¿ÉÄÜ²¢²»ÔÚÎïÀíÉÈÇøÖĞ£¬¶øÔÚEXB»º³åÖĞ
                #ifdef USE_EXCHANGE_BUFFER //Èç¹ûÊ¹ÓÃÁËEXB»º³å
                #ifndef USE_ALONE_EXB //Èç¹ûÃ»ÓĞÆôÓÃ¶ÀÁ¢EXB»º³å£¬¼´ÆôÓÃÁË¹²ÏíEXB»º³å
                if((psexb_cur_oc==pfi)&&(sexb_cur_dev==Dev_No)&&(sexb_cur_sec==(pfi->File_CurSec))) //Èç¹û´ËÊ±ÎÄ¼şÕıÕ¼ÓÃ
             -¹²ÏíEXB£¬Í¬Ê±µ±Ç°ÎÄ¼şËùÔÚµÄÉè±¸ÓëÉÈÇøºÍ¹²ÏíEXBÏà·û
                {
                 Memory_Copy(pexb_buf+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚ¹²ÏíEXBÖĞµÄÊı¾İ
                }
                else //·ñÔòÒªĞŞ¸ÄµÄÊı¾İ²»ÔÚEXBÖĞ£¬¶øÔÚÎïÀíÉÈÇøÖĞ
                {
                 znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                 Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 91  

                 znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                }
                #else //Èç¹ûÆô¶¯¶ÀÁ¢EXB»º³å
                if((pfi->exb_cursec)==(pfi->File_CurSec)) //Èç¹û´ËÎÄ¼şµÄEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇøÒ»ÖÂ£¬ÔòËµÃ÷ÒªĞŞ¸ÄµÄÊı¾
             -İÔÚ´ËÎÄ¼şµÄEXBÖĞ
                {
                 Memory_Copy((pfi->exb_buf)+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÎÄ¼ş¶ÀÁ¢EXBÖĞµÄÊı¾İ
                }
                else //Èç¹û´ËÎÄ¼şEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇø²»Ò»ÖÂ£¬ÒªĞŞ¸ÄµÄÊı¾İÔÚÎïÀíÉÈÇøÖĞ
                {
                 znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                 Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                 znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ  
                }
                 
                #endif
                #else //Èç¹ûÃ»ÓĞÊ¹ÓÃEXB»º³å£¬ÔòÖ±½ÓĞŞ¸ÄÎïÀíÉÈÇøÊı¾İ
                
                znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                 
                #endif
              
                (pfi->File_CurOffset)+=len;
                (pfi->File_CurPos)=len; 
               
                return temp_len;
               }
              }
              #endif
5502          
5503          /************************************************************************************
5504           ¹¦ÄÜ£º¹Ø±ÕÎÄ¼ş
5505           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë
5506           ·µ»Ø£º0
5507           Ïê½â£º´Ëº¯ÊıÓÃÓÚ¹Ø±ÕÎÄ¼ş£¬¼´¶ÔÎÄ¼şµÄĞÅÏ¢¼¯ºÏ½øĞĞÇå0£¬Ê¹ÎÄ¼şµÄÏà¹ØĞÅÏ¢µÃÒÔÏú»Ù£¬´Ó¶ø
5508                 ÎŞ·¨ÔÙ¶ÔÆä½øĞĞ²Ù×÷£¬³ı·ÇÖØĞÂ´ò¿ª´ËÎÄ¼ş¡£Óë´ËÍ¬Ê±£¬´Ëº¯Êı»¹ÒÀÕÕRT_UPDATE_FILESIZE
5509                 µÄ¶¨Òå¶ÔÎÄ¼ş´óĞ¡½øĞĞ¸üĞÂ¡£Èç¹ûÃ»ÓĞ¿ªÆôÎÄ¼ş´óĞ¡µÄÊµÊ±¸üĞÂ¹¦ÄÜ£¬ÔòÔÚµ÷ÓÃ´Ëº¯ÊıÊ±
5510                 ½«¶ÔÆä½øĞĞ¸üĞÂ¡£Òò´ËÈç¹ûÃ»ÓĞÊ¹ÓÃÊµÊ±ÎÄ¼ş´óĞ¡¸üĞÂ£¬ÄÇÃ´ÔÚÎÄ¼ş²Ù×÷£¬ÓÈÆäÊÇÊı¾İĞ´Èë
5511                 »òĞŞ¸Ä²Ù×÷Ö®ºó£¬Ò»¶¨Òªµ÷ÓÃclose_fileº¯Êı¡£
5512          *************************************************************************************/
5513          #ifdef ZNFAT_CLOSE_FILE
5514          UINT8 znFAT_Close_File(struct FileInfo *pfi)
5515          {
5516   1       #ifndef RT_UPDATE_FILESIZE
               Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
               #endif
5519   1      
5520   1       just_file=pfi;
5521   1      
5522   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
5527   1      
5528   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifndef USE_ALONE_CCCB
               if(pfi==pcccb_cur_oc) //Èç¹ûÏÖÔÚ²Ù×÷µÄÕâ¸öÎÄ¼şÕıÕ¼ÓÃCCCB£¬ÔòÔÚ¹Ø±ÕÎÄ¼şÒÔÇ°£¬ĞèÒª½«CCCB¸üĞÂµ½FAT
               #endif
                CCCB_Update_FAT();
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 92  

               #endif
5534   1      
5535   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifdef USE_ALONE_CCCB
               pcccb_buf=(UINT32 *)0;
               pcccb_curval=(UINT32 *)0;
               pcccb_counter=(UINT8 *)0;
               #endif
               #endif
5542   1      
5543   1       #ifdef USE_EXCHANGE_BUFFER
               #ifndef USE_ALONE_EXB
               if(pfi==psexb_cur_oc && 0!=(sexb_cur_sec)) //Èç¹ûµ±Ç°EXB±»Õ¼ÓÃ£¬¶øÇÒÊÇÏÖÔÚÒª¹Ø±ÕµÄÎÄ¼ş
               {
                znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //EXB»º³åÊı¾İ»ØĞ´
                sexb_cur_sec=0;
                psexb_cur_oc=(struct FileInfo *)0;
                sexb_cur_dev=(UINT8)(-1);
               }
               #else
               pexb_buf=pfi->exb_buf;
               if(0!=pfi->exb_cursec) //Èç¹ûÒª¹Ø±ÕÎÄ¼şµÄEXB±»Õ¼ÓÃ
               {
                znFAT_Device_Write_Sector(pfi->File_CurSec,pexb_buf); //EXB»º³åÊı¾İ»ØĞ´
               }
               pexb_buf=(UINT8 *)0;
               #endif
               #endif
5561   1      
5562   1       Memory_Set((UINT8 *)pfi,(UINT32)sizeof(struct FileInfo),0);
5563   1      
5564   1       just_file=(struct FileInfo *)0;
5565   1      
5566   1       return ERR_SUCC;
5567   1      }
5568          #endif
5569          
5570          /************************************************************************************
5571           ¹¦ÄÜ£ºË¢ĞÂÎÄ¼şÏµÍ³
5572           ĞÎ²Î£ºÎŞ
5573           ·µ»Ø£º0
5574           Ïê½â£ºÔÚÎÒÃÇ½øĞĞÁËÎÄ¼ş²Ù×÷Ö®ºó£¬±ÈÈç´´½¨ÎÄ¼ş»òÄ¿Â¼£¬ÏòÎÄ¼şÖĞĞ´ÈëÊı¾İ£¬»òÊÇÉ¾³ı²Ù×÷£¬
5575                 ¶¼»áÓ°Ïìµ½ÎÄ¼şÏµÍ³±¾ÉíµÄÒ»Ğ©²ÎÊı£¬±ÈÈç´ÅÅÌµÄÊ£ÓàÈİÁ¿µÈ¡£znFATÖĞ¿ÉÒÔÍ¨¹ı´ò¿ª
5576                 RT_UPDATE_FSINFOÕâ¸öºêÀ´Æô¶¯ÎÄ¼şÏµÍ³ÊµÊ±¸üĞÂ¹¦ÄÜ£¬ÈÎºÎµÄÔö¼ÓÉ¾¸Ä²Ù×÷znFAT¶¼»á
5577                 Á¢¼´¸üĞÂÎÄ¼şÏµÍ³¡£µ«ÕâÑù»á±»Êı¾İĞ´ÈëµÈ²Ù×÷Ğ§ÂÊ½µµÍ£¬Òò´Ë¿ÉÒÔÆÁ±ÎµôÕâÒ»ÊµÊ±¸üĞÂ
5578                 ¹¦ÄÜ£¬µ«ÊÇ±ØĞëÔÚËùÓĞÎÄ¼ş²Ù×÷½áÊøÖ®ºó£¬µ÷ÓÃ´Ëº¯ÊıÀ´Ë¢ĞÂÎÄ¼şÏµÍ³¡£
5579          *************************************************************************************/
5580          #ifdef ZNFAT_FLUSH_FS
5581          UINT8 znFAT_Flush_FS(void)
5582          {
5583   1       #ifndef RT_UPDATE_FSINFO
               Update_FSINFO(); //¸üĞÂÎÄ¼şÏµÍ³ĞÅÏ¢
               #endif
5586   1      
5587   1       return ERR_SUCC; 
5588   1      }
5589          #endif
5590                                                 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  23659    ----
C51 COMPILER V9.52.0.0   ZNFAT                                                             03/27/2018 22:42:44 PAGE 93  

   CONSTANT SIZE    =     11    ----
   XDATA SIZE       =    522     600
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
